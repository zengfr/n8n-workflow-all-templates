{
  "id": "Y4vZ0z2b1xAcFQxy",
  "meta": {
    "site": "https://github.com/zengfr/n8n-workflow-all-templates",
    "name": "Estimate construction costs from text with Telegram, OpenAI and DDC CWICR",
    "wechat": "youandme10086",
    "id": 12174,
    "update_time": "2026-02-13"
  },
  "name": "DDC CWICR - Text Estimator v11 (AI Nodes)",
  "tags": [],
  "nodes": [
    {
      "id": "5c6b56be-8107-4d2a-99c6-fe01de0dcd7b",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5600,
        -2176
      ],
      "parameters": {
        "width": 404,
        "height": 132,
        "content": "â­ **Star us on GitHub!**\n\n[github.com/datadrivenconstruction/DDC-CWICR](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR)\n\n**DDC CWICR** â€” Open Source Construction Cost Database\n- 55,000+ work items\n- 9 languages\n- Free forever"
      },
      "typeVersion": 1
    },
    {
      "id": "00370c25-67e4-4789-9abf-e994473af278",
      "name": "ðŸ” Credentials Setup",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5600,
        -2032
      ],
      "parameters": {
        "color": 5,
        "width": 412,
        "height": 936,
        "content": "## ðŸ” Credentials Setup\n\n### ðŸ”‘ TOKEN node:\n- `bot_token` - Telegram Bot API\n- `QDRANT_URL` - Qdrant server\n- `QDRANT_API_KEY` - Qdrant auth\n\n### n8n Credentials (Settings â†’ Credentials):\n- **OpenAI API** - for LLM + Embeddings\n- **Anthropic API** - (optional) for Claude\n- **Google Gemini API** - (optional) for Gemini\n\n### To switch AI models:\n1. Disable current model node\n2. Enable alternative model\n3. Models auto-connect to chain"
      },
      "typeVersion": 1
    },
    {
      "id": "828e259a-6e85-479c-a60e-76931f116b73",
      "name": "Checklist",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5936,
        -1712
      ],
      "parameters": {
        "width": 324,
        "height": 460,
        "content": "## âœ… SETUP CHECKLIST\n\n**1. Telegram Bot**\n- [ ] Create via @BotFather\n- [ ] Token in ðŸ”‘ TOKEN\n\n**2. n8n Credentials**\n- [ ] Add OpenAI credential\n- [ ] Link to Model nodes\n\n**3. Qdrant**\n- [ ] Install/connect Qdrant\n- [ ] Load DDC collections\n- [ ] Set QDRANT_URL\n\n**4. Test**\n- [ ] /start â†’ language\n- [ ] Enter works\n- [ ] Get estimate"
      },
      "typeVersion": 1
    },
    {
      "id": "1044a0e4-96af-46fb-87e0-f5b7011b82ad",
      "name": "Intro",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5936,
        -2176
      ],
      "parameters": {
        "width": 318,
        "height": 440,
        "content": "## ðŸš€ DDC CWICR Text Estimator\n### Construction Cost Estimation Bot\n\n**Version:** 11.0 AI Nodes\n**Author:** DataDrivenConstruction.io\n\n**All AI via n8n Credentials:**\n- ðŸ¤– Parse Text (OpenAI/Claude/Gemini)\n- ðŸ¤– Transform Query\n- ðŸ¤– Rerank Results\n- ðŸ“Š Embeddings (OpenAI)\n\n**Features:**\n- ðŸ’¬ Text input\n- ðŸŒ 9 languages\n- ðŸ” Vector search\n- ðŸ“Š HTML/Excel/PDF\n\n**No API keys in code!**\nUse n8n Credentials only."
      },
      "typeVersion": 1
    },
    {
      "id": "349fcf16-f55a-4300-aa2a-2bb9ed806716",
      "name": "ðŸ”‘ TOKEN",
      "type": "n8n-nodes-base.set",
      "position": [
        -5344,
        -1568
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "e7b8f8af-ca88-4515-a8ce-3d2c50b815b6",
              "name": "bot_token",
              "type": "string",
              "value": "YOUR_TELEGRAM_BOT_TOKEN"
            },
            {
              "id": "bd298b9a-45b6-4b99-9e50-0346cc402a30",
              "name": "OPENAI_API_KEY",
              "type": "string",
              "value": "YOUR_OPENAI_API_KEY"
            },
            {
              "id": "9c4cfdd2-d46e-465b-ac08-cea275128c20",
              "name": "QDRANT_URL",
              "type": "string",
              "value": "http://localhost:6333"
            },
            {
              "id": "835c6846-26c6-4a0f-ad75-f352010fe4a8",
              "name": "QDRANT_API_KEY",
              "type": "string",
              "value": ""
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "c576122d-0243-4772-99d0-01cf54898118",
      "name": "UI Messages",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4304,
        -2784
      ],
      "parameters": {
        "color": 6,
        "width": 464,
        "height": 804,
        "content": "## ðŸŒ UI Messages\n\nTelegram interface elements:\n- Language selection menu\n- Text input prompts\n- Edit options\n- Help text\n- Error messages\n- Progress indicators\n\nAll localized in Config node.\n\n**Customization:**\nEdit LANG object in Config\nto modify any UI text."
      },
      "typeVersion": 1
    },
    {
      "id": "3385b0fc-beba-4867-8cd8-e1f5c9c210ea",
      "name": "Route Switch",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4640,
        -2176
      ],
      "parameters": {
        "color": 4,
        "width": 308,
        "height": 1072,
        "content": "## ðŸ”€ Route Switch\n\n**11 Actions:**\n\n| # | Action | Description |\n|---|--------|-------------|\n| 0 | show_lang | Language menu |\n| 1 | lang_selected | Confirm & prompt |\n| 2 | works_updated | After edit |\n| 3 | calculate | Start calculation |\n| 4 | edit | Show edit menu |\n| 5 | export_excel | CSV download |\n| 6 | export_pdf | PDF download |\n| 7 | view_details | Resource details |\n| 8 | help | Help message |\n| 9 | restart | New session |\n| 10 | fallback | Error handler |"
      },
      "typeVersion": 1
    },
    {
      "id": "c095dbb9-7ce0-4173-8c45-d6de272c43b9",
      "name": "Config & Localization",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4880,
        -2176
      ],
      "parameters": {
        "color": 5,
        "width": 220,
        "height": 808,
        "content": "## ðŸŒ Config & Localization\n\n**9 Languages:**\nDE, EN, RU, ES, FR, PT, ZH, AR, HI\n\n**Contains:**\n- UI messages (buttons, prompts)\n- Currency symbols (â‚¬/$â‚½Â¥)\n- Database mapping\n- Search language names\n\n**Auto-selects:**\n- Qdrant collection by language\n- Currency by region\n- UI text localization\n\n**Customizable:**\n- Add new languages in LANG object\n- Modify button labels\n- Change currency defaults"
      },
      "typeVersion": 1
    },
    {
      "id": "4fe52156-022b-49e3-97f6-2da1f363a635",
      "name": "Main Router",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5168,
        -2176
      ],
      "parameters": {
        "color": 5,
        "width": 268,
        "height": 808,
        "content": "## ðŸ§  Main Router\n\nCentral message handler.\n\n**Input:** Telegram Update\n\n**Processing:**\n1. Parse message/callback\n2. Manage user sessions\n3. Detect content type\n4. Route to action\n\n**Output:** `action` code (0-10)\n\n**Session Storage:**\n- User language\n- Work items list\n- Calculation results\n- State machine"
      },
      "typeVersion": 1
    },
    {
      "id": "a5e21659-7430-412a-82a5-24b3f153118b",
      "name": "Agg",
      "type": "n8n-nodes-base.code",
      "position": [
        -1920,
        -784
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// AGG - Final aggregation of calculation results + DDC CWICR info\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\nconst L = cfg.L || {};\nlet total = 0, workers_sum = 0, materials_sum = 0, machines_sum = 0, labor_hours_sum = 0;\nlet found_count = 0;\n\n// Get accumulated results\nconst storedResults = sd.res?.[cid] || [];\n\nconsole.log('=== AGG ===');\nconsole.log('Results count:', storedResults.length);\n\n// Process each result\nconst works = storedResults.map(w => {\n  const uc = w.uc || 0;\n  const tc = w.tc || 0;\n\n  total += tc;\n  workers_sum += (w.workers_total || 0);\n  materials_sum += (w.materials_total || 0);\n  machines_sum += (w.machines_total || 0);\n  labor_hours_sum += (w.labor_hours || 0);\n\n  if (w._found) found_count++;\n\n  return {\n    id: w.id,\n    name: w.name || w.sq,\n    query: w.sq || w.query,\n    qty: w.qty,\n    unit: w.unit,\n    room: w.room,\n    uc: uc,\n    tc: tc,\n    rate_code: w.rate_code || '',\n    rate_name: w.rate_name || '',\n    resources: w.resources || [],\n    workers_total: w.workers_total || 0,\n    materials_total: w.materials_total || 0,\n    machines_total: w.machines_total || 0,\n    labor_hours: w.labor_hours || 0,\n    found: w._found || false,\n    scope_of_work: w.scope_of_work || [],\n    original_query: w.original_query || w.name\n  };\n});\n\nconst pct = works.length > 0 ? Math.round(found_count / works.length * 100) : 0;\n\n// DDC CWICR info\nconst isLimited = false; // No limit\nconst originalTotal = session.totalWorks || works.length;\nconst skippedWorks = originalTotal - works.length;\n\nconsole.log('Calculated:', works.length, '/', originalTotal);\nconsole.log('Found:', found_count, '/', works.length);\nconsole.log('Total cost:', total.toFixed(2));\n// No limit mode\n\n// Cleanup staticData\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.calcProgress?.[cid]) delete sd.calcProgress[cid];\nif (sd.progress?.[cid]) delete sd.progress[cid];\n\n// Save for report generation\nsd.lastResults = { works, total, workers_sum, materials_sum, machines_sum, labor_hours_sum, found_count, pct, L };\n\nreturn {\n  json: {\n    chatId: cid,\n    bot_token: cfg.bot_token,\n    works: works,\n    total: Math.round(total * 100) / 100,\n    workers_sum: Math.round(workers_sum * 100) / 100,\n    materials_sum: Math.round(materials_sum * 100) / 100,\n    machines_sum: Math.round(machines_sum * 100) / 100,\n    labor_hours_sum: Math.round(labor_hours_sum * 100) / 100,\n    found_count: found_count,\n    total_count: works.length,\n    pct: pct,\n    L: L,\n    currency: L.sym || 'â‚¬',\n    description: session.description || '',\n    // DDC CWICR\n    _is_limited: isLimited,\n    _total_works: originalTotal,\n    _skipped_works: skippedWorks\n  }\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "f6f6aa53-b07e-4a09-b740-7db971f3f7c9",
      "name": "ðŸ—‘ï¸ Delete Progress Msg",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2096,
        -784
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/deleteMessage",
        "method": "POST",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        },
        "jsonBody": "={\n  \"chat_id\": {{ $('ðŸ§¹ Prep Cleanup').first().json.chatId }},\n  \"message_id\": {{ $('ðŸ§¹ Prep Cleanup').first().json._delete_progress_msg || 0 }}\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "602ec477-8f11-47ec-8cfc-aaf8c9183a09",
      "name": "ðŸ—‘ï¸ Delete Work Msg",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2288,
        -784
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/deleteMessage",
        "method": "POST",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        },
        "jsonBody": "={\n  \"chat_id\": {{ $('ðŸ§¹ Prep Cleanup').first().json.chatId }},\n  \"message_id\": {{ $('ðŸ§¹ Prep Cleanup').first().json._delete_work_msg || 0 }}\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "7a275264-fb92-4cf2-8d35-dbbbbdf5d2a3",
      "name": "ðŸ§¹ Prep Cleanup",
      "type": "n8n-nodes-base.code",
      "position": [
        -2464,
        -784
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREP CLEANUP - Prepare message IDs for deletion after loop completes\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Get message IDs to delete\nconst lastMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\nconst progressMsgId = sd.progress?.[cid]?.message_id || null;\n\nconsole.log('=== PREP CLEANUP ===');\nconsole.log('ChatId:', cid);\nconsole.log('Work msg:', lastMsgId);\nconsole.log('Progress msg:', progressMsgId);\n\nreturn {\n  json: {\n    chatId: cfg.chatId,\n    bot_token: cfg.bot_token,\n    L: cfg.L,\n    _delete_work_msg: lastMsgId,\n    _delete_progress_msg: progressMsgId\n  }\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "db70fc98-d9ab-4c81-8992-9e4b844c705a",
      "name": "Acc",
      "type": "n8n-nodes-base.code",
      "position": [
        -1920,
        0
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ACC - Accumulate calculation results for final aggregation\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sd = $getWorkflowStaticData('global');\nconst w = $('ðŸ“Š Update Result').first().json;\nconst cid = String(w.chatId);\n\nif (!sd.res) sd.res = {};\nif (!sd.res[cid]) sd.res[cid] = [];\nsd.res[cid].push(w);\n\nconsole.log('Accumulated:', sd.res[cid].length, '/', w.total_works);\n\nreturn { json: w };"
      },
      "typeVersion": 2
    },
    {
      "id": "e6214da3-91f1-4065-8f60-a73a8fcd8609",
      "name": "ðŸ“¤ Edit Result",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2096,
        0
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/editMessageText",
        "method": "POST",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        },
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._edit_msg_id || 0 }}, \"text\": {{ JSON.stringify($json._result_text) }}, \"parse_mode\": \"Markdown\"}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "f78f0fc1-011c-46c4-a4ae-92088c88589c",
      "name": "ðŸ“Š Update Result",
      "type": "n8n-nodes-base.code",
      "position": [
        -2256,
        0
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// UPDATE RESULT - Format result message (âœ“ Found / Not found)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst calcData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(calcData.chatId);\nconst L = calcData.L || {};\n\nconst current = calcData.work_index || 1;\nconst total = calcData.total_works || 1;\nconst name = calcData.name || calcData.sq || 'Work';\n\nlet shortName = name.length > 22 ? name.substring(0, 19) + '...' : name;\n\nconst tc = parseFloat(calcData.tc) || 0;\nconst uc = parseFloat(calcData.uc) || 0;\nconst rateCode = String(calcData.rate_code || '');\nconst rateName = String(calcData.rate_name || '');\nconst currency = calcData.currency || L.sym || 'â‚¬';\n\nconst hasValidRate = rateCode && \n  !rateCode.includes('NOT_FOUND') && \n  !rateCode.includes('PAYLOAD_NOT_FOUND');\n\nconst found = tc > 0 || uc > 0 || hasValidRate || (rateName && rateName.length > 0);\n\nconsole.log('Result:', shortName, found ? 'âœ“' : 'âœ—', tc.toFixed(0), currency);\n\nlet text = '';\nif (found) {\n  text = current + '/' + total + ' ' + shortName + ' âœ“\\n';\n  text += tc.toFixed(0) + ' ' + currency;\n  if (rateCode && hasValidRate) text += ' Â· ' + rateCode.substring(0, 20);\n} else {\n  text = current + '/' + total + ' ' + shortName + '\\n';\n  text += (L.not_found || 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾');\n}\n\nconst msgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nreturn { json: { ...calcData, _result_text: text, _edit_msg_id: msgId, _found: found } };"
      },
      "typeVersion": 2
    },
    {
      "id": "86c8dc46-d8e3-4aaa-9aff-986535232720",
      "name": "1ï¸âƒ£ Prep Query",
      "type": "n8n-nodes-base.code",
      "position": [
        -1920,
        -400
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREP QUERY - Prepare search query with Qdrant credentials from TOKEN\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst loopItem = $input.first().json;\nconst tokenData = $('ðŸ”‘ TOKEN').first().json;\n\nconst originalQuery = loopItem.sq || loopItem.query || loopItem.name || '';\nconst collectionName = loopItem.db || '';\nconst L = loopItem.L || {};\nconst workUnit = loopItem.unit || 'mÂ²';\nconst workQty = loopItem.qty || 1;\n\n// Get Qdrant credentials from TOKEN node\nconst QDRANT_URL = tokenData.QDRANT_URL || 'http://localhost:6333';\nconst QDRANT_API_KEY = tokenData.QDRANT_API_KEY || '';\n\nconsole.log('=== PREP QUERY ===');\nconsole.log('Query:', originalQuery);\nconsole.log('Collection:', collectionName);\nconsole.log('Qdrant URL:', QDRANT_URL);\n\nif (!originalQuery || !collectionName) {\n  console.log('ERROR: Missing query or collection');\n  return [{ json: { ...loopItem, _error: 'Missing data', _skip: true } }];\n}\n\nconst searchLang = L.search_lang || 'Russian';\n\n// Detect database language from collection name\nconst isRussianDB = collectionName.includes('RU_') || collectionName.includes('_RU');\nconst isGermanDB = collectionName.includes('DE_');\nconst dbLang = isRussianDB ? 'Russian' : (isGermanDB ? 'German' : 'English');\n\nconst transformPrompt = `You are a construction cost database search expert for ${dbLang} construction rates database.\n\nTASK: Transform user query into optimal SEARCH KEYWORDS that will match entries in a vector database of construction work rates.\n\nDATABASE CONTEXT:\n- Contains standardized construction work rates with codes, names, units, resources\n- Each rate has: rate_code, rate_name, rate_unit, scope_of_work, resources\n- Language: ${dbLang}\n\nTRANSFORMATION RULES:\n1. EXPAND abbreviations to full professional terms\n2. ADD synonyms and related construction terms\n3. INCLUDE work action verbs (install, apply, lay, mount)\n4. Keep original query terms + expanded terms\n5. Output in ${dbLang} language only\n\nUSER QUERY: ${originalQuery}\nUNIT: ${workUnit}\n\nReply with ONLY the optimized search keywords (one line, no explanations):`;\n\nreturn [{ json: {\n  ...loopItem,\n  _original_query: originalQuery,\n  _transform_prompt: transformPrompt,\n  _collection: collectionName,\n  _db_lang: dbLang,\n  _qdrant_url: QDRANT_URL,\n  _qdrant_key: QDRANT_API_KEY\n}}];"
      },
      "typeVersion": 2
    },
    {
      "id": "38cc18f0-26f4-4fbf-a12d-13eb6154bb94",
      "name": "ðŸ’¾ Save Work Msg",
      "type": "n8n-nodes-base.code",
      "position": [
        -2096,
        -400
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SAVE WORK MSG - Store message ID for later editing/deletion\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst loopItem = $('ðŸ“ Prep Work Msg').first().json;\nconst tgResp = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\n\nif (!sd.calcProgress) sd.calcProgress = {};\nif (!sd.calcProgress[cid]) sd.calcProgress[cid] = {};\nsd.calcProgress[cid].lastMsgId = tgResp.result?.message_id || null;\n\nconsole.log('Saved msg ID:', sd.calcProgress[cid].lastMsgId);\n\nreturn { json: loopItem };"
      },
      "typeVersion": 2
    },
    {
      "id": "78681325-44aa-43d9-960d-276444c26b1e",
      "name": "ðŸ“¤ Send Work",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2272,
        -400
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\"chat_id\": {{ $(\"ðŸ“ Prep Work Msg\").item.json.chatId }}, \"text\": {{ JSON.stringify($(\"ðŸ“ Prep Work Msg\").item.json._work_text) }}, \"parse_mode\": \"Markdown\"}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "ac19ffbe-1ef7-4730-bc8b-5e6fa86b36d2",
      "name": "ðŸ—‘ï¸ Delete Prev",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2464,
        -400
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/deleteMessage",
        "method": "POST",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        },
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._prev_msg_id || 0 }}}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "2601173f-9e00-41d0-b242-5e21532e2ac1",
      "name": "ðŸ“ Prep Work Msg",
      "type": "n8n-nodes-base.code",
      "position": [
        -2640,
        -400
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREP WORK MSG - Create localized \"Searching...\" message for current work\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst loopItem = $('Loop').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\nconst L = loopItem.L || {};\nconst lang = L.search_lang || 'English';\n\nconst current = loopItem.work_index || 1;\nconst total = loopItem.total_works || 1;\nconst name = loopItem.name || loopItem.sq || 'Work';\nconst qty = loopItem.qty || 1;\nconst unit = loopItem.unit || 'mÂ²';\n\nlet shortName = name.length > 30 ? name.substring(0, 27) + '...' : name;\n\n// Localized search messages\nconst SEARCH_WORD = {\n  'German': 'ðŸ” Suche',\n  'English': 'ðŸ” Searching',\n  'Russian': 'ðŸ” ÐŸÐ¾Ð¸ÑÐº',\n  'Spanish': 'ðŸ” Buscando',\n  'French': 'ðŸ” Recherche',\n  'Portuguese': 'ðŸ” Buscando',\n  'Chinese': 'ðŸ” æœç´¢ä¸­',\n  'Arabic': 'ðŸ” Ø¨Ø­Ø«',\n  'Hindi': 'ðŸ” à¤–à¥‹à¤œ'\n};\n\nconst searchWord = SEARCH_WORD[lang] || 'ðŸ” Searching';\n\n// Format: \"ðŸ” ÐŸÐ¾Ð¸ÑÐº 3/26\\nÐ“Ð¸Ð¿ÑÐ¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½ 25mÂ²\"\nlet text = `${searchWord} ${current}/${total}\\n`;\ntext += `*${shortName}*\\n`;\ntext += `${qty} ${unit}`;\n\nconst prevMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nconsole.log('Work', current, '/', total, '-', shortName);\n\nreturn { json: { ...loopItem, _work_text: text, _prev_msg_id: prevMsgId } };"
      },
      "typeVersion": 2
    },
    {
      "id": "d676b99b-6ed0-4f16-b00a-a9182175d754",
      "name": "Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        -2816,
        -768
      ],
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "typeVersion": 3
    },
    {
      "id": "b7c5ad07-b6f8-488b-8a1a-b398336545b5",
      "name": "Prep Works",
      "type": "n8n-nodes-base.code",
      "position": [
        -3104,
        -1024
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREP WORKS - Prepare work items for calculation loop (: 5 items)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\n// Get all works (no limit)\nconst works = session.works || [];\nconst db = session.db || cfg.db;\nconst L = session.L || cfg.L;\n\n// Initialize results accumulator\nif (!sd.res) sd.res = {};\nsd.res[cid] = [];\n\nconst totalWorks = works.length;\n\nconsole.log('=== PREP WORKS ===');\nconsole.log('Processing:', totalWorks, 'items');\n\n// Return array for loop processing\nreturn works.map((w, idx) => ({ \n  json: { \n    ...w, \n    db, \n    L, \n    currency: L?.sym || 'â‚¬',\n    bot_token: cfg.bot_token, \n    chatId: cid, \n    sq: w.query || w.name,\n    original_query: w.query || w.name,\n    work_index: idx + 1, \n    total_works: totalWorks,\n    _is_limited: cfg._is_limited,\n    _original_total: cfg._total_works\n  } \n}));"
      },
      "typeVersion": 2
    },
    {
      "id": "0ffb3b95-d9e3-4c3d-83e6-1f909019b6a1",
      "name": "Save Progress ID",
      "type": "n8n-nodes-base.code",
      "position": [
        -3280,
        -1024
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SAVE PROGRESS ID - Store initial progress message ID for cleanup\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst prepData = $('ðŸ“ Prep Progress').first().json;\nconst telegramResponse = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Store progress message info\nif (!sd.progress) sd.progress = {};\nsd.progress[cid] = {\n  message_id: telegramResponse.result?.message_id || 0,\n  chat_id: cfg.chatId,\n  bot_token: cfg.bot_token\n};\n\n// Initialize calculation progress tracker\nif (!sd.calcProgress) sd.calcProgress = {};\nsd.calcProgress[cid] = { lastMsgId: null };\n\nconsole.log('Progress msg ID:', sd.progress[cid].message_id);\n\nreturn { \n  json: { \n    ...cfg,\n    _total_works: prepData._total_works\n  } \n};"
      },
      "typeVersion": 2
    },
    {
      "id": "76047230-a1cf-46b9-8eb4-9c85e1982969",
      "name": "ðŸ“¤ Send Progress",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -3488,
        -1024
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\"chat_id\": {{ $json._progress_chat_id }}, \"text\": {{ JSON.stringify($json._progress_text) }}, \"parse_mode\": \"Markdown\"}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "d1cec9fe-6d9a-468d-8ba1-1f8b4112de53",
      "name": "ðŸ“ Prep Progress",
      "type": "n8n-nodes-base.code",
      "position": [
        -3728,
        -1024
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREP PROGRESS - Show calculation progress message (localized)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\nconst session = sd.sess?.[cid] || {};\n\nconst allWorks = session.works || [];\nconst L = cfg.L || session.L || {};\nconst lang = cfg.lang || 'EN';\n\nconsole.log('=== PREP PROGRESS ===');\nconsole.log('Works:', allWorks.length);\nconsole.log('Language:', lang);\n\nconst totalWorks = allWorks.length;\nconst estimatedMinutes = Math.max(1, Math.ceil(totalWorks * 8 / 60));\n\n// Localized messages for \"Searching prices...\"\nconst SEARCH_MESSAGES = {\n  DE: `ðŸ” *Preissuche lÃ¤uft...*\\n\\n${totalWorks} Positionen\\nâ± ~${estimatedMinutes} Min`,\n  EN: `ðŸ” *Searching prices...*\\n\\n${totalWorks} items\\nâ± ~${estimatedMinutes} min`,\n  RU: `ðŸ” *ÐŸÐ¾Ð¸ÑÐº Ñ€Ð°ÑÑ†ÐµÐ½Ð¾Ðº...*\\n\\n${totalWorks} Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹\\nâ± ~${estimatedMinutes} Ð¼Ð¸Ð½`,\n  ES: `ðŸ” *Buscando precios...*\\n\\n${totalWorks} elementos\\nâ± ~${estimatedMinutes} min`,\n  FR: `ðŸ” *Recherche des prix...*\\n\\n${totalWorks} Ã©lÃ©ments\\nâ± ~${estimatedMinutes} min`,\n  PT: `ðŸ” *Buscando preÃ§os...*\\n\\n${totalWorks} itens\\nâ± ~${estimatedMinutes} min`,\n  ZH: `ðŸ” *æ­£åœ¨æœç´¢ä»·æ ¼...*\\n\\n${totalWorks} é¡¹ç›®\\nâ± ~${estimatedMinutes} åˆ†é’Ÿ`,\n  AR: `ðŸ” *Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...*\\n\\n${totalWorks} Ø¹Ù†Ø§ØµØ±\\nâ± ~${estimatedMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`,\n  HI: `ðŸ” *à¤•à¥€à¤®à¤¤à¥‡à¤‚ à¤–à¥‹à¤œ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚...*\\n\\n${totalWorks} à¤†à¤‡à¤Ÿà¤®\\nâ± ~${estimatedMinutes} à¤®à¤¿à¤¨à¤Ÿ`\n};\n\nconst text = SEARCH_MESSAGES[lang] || SEARCH_MESSAGES['EN'];\n\n// Save to session\nsession.totalWorks = totalWorks;\n\nreturn {\n  json: {\n    ...cfg,\n    _progress_chat_id: cfg.chatId,\n    _progress_text: text,\n    _total_works: totalWorks\n  }\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "067f5f6a-7a4a-43fc-90ca-46e7976d0f1e",
      "name": "ðŸ“¤ Send Works",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -3328,
        -1696
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": {{ JSON.stringify($json.keyboard) }}}}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "d0f90abb-6cb7-4180-ba96-9a2e94b46062",
      "name": "ðŸ“Š Show Works",
      "type": "n8n-nodes-base.code",
      "position": [
        -3472,
        -1696
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SHOW WORKS - Display extracted work items with edit buttons\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfgNode = $('Config').first().json;\nconst inputData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\n\nconst chatId = inputData.chatId || cfgNode.chatId;\nconst bot_token = inputData.bot_token || cfgNode.bot_token;\nconst cid = String(chatId);\n\n// Get L from multiple sources (session is most reliable)\nconst session = sd.sess?.[cid] || {};\nlet L = cfgNode.L || session.L || inputData.L || {};\n\n// Get works from input (from Deduplicate) or session\nconst works = inputData.works || session.works || [];\nconst rooms = inputData.rooms || session.rooms || [];\n\nconsole.log('=== SHOW WORKS ===');\nconsole.log('Works:', works.length);\nconsole.log('L.search_lang:', L.search_lang);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nif (works.length > 0) {\n  sd.sess[cid].works = works;\n  sd.sess[cid].rooms = rooms;\n  sd.sess[cid].L = L;\n  sd.sess[cid].db = cfgNode.db;\n  sd.sess[cid].state = 'wait_edit';\n}\n\nfunction short(str, len) {\n  str = String(str || '');\n  return str.length > len ? str.substring(0, len - 1) + 'â€¦' : str;\n}\n\nconst totalArea = rooms.reduce((sum, r) => sum + (r.area_m2 || 0), 0);\n\n// Use localized labels with fallback\nconst roomWord = L.rooms || 'ÐºÐ¾Ð¼Ð½Ð°Ñ‚';\nconst workWord = L.works_identified || 'Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹';\nconst generalWord = L.general || 'ÐžÐ±Ñ‰ÐµÐµ';\n\nlet msg = '*' + rooms.length + ' ' + roomWord;\nif (totalArea > 0) msg += ' Â· ' + (Math.round(totalArea * 10) / 10) + ' mÂ²';\nmsg += '*\\n';\nmsg += '_' + works.length + ' ' + workWord + '_\\n\\n';\n\nif (works.length === 0) {\n  msg += '_' + (L.no_works || 'Ð Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹') + '_\\n';\n} else {\n  const worksByRoom = new Map();\n  const noRoom = [];\n\n  for (const w of works) {\n    if (w.room && w.room.length > 0) {\n      if (!worksByRoom.has(w.room)) worksByRoom.set(w.room, []);\n      worksByRoom.get(w.room).push(w);\n    } else {\n      noRoom.push(w);\n    }\n  }\n\n  let workNum = 1;\n\n  for (const [roomName, roomWorks] of worksByRoom) {\n    const room = rooms.find(r => r.name === roomName);\n    const areaStr = room?.area_m2 ? ' Â· ' + room.area_m2 + ' mÂ²' : '';\n    msg += '*' + short(roomName, 20) + '*' + areaStr + '\\n';\n\n    for (const w of roomWorks) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' â€” ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n    msg += '\\n';\n  }\n\n  if (noRoom.length > 0) {\n    msg += '*' + generalWord + '*\\n';\n    for (const w of noRoom) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' â€” ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n  }\n}\n\n// Build keyboard\nconst keyboard = [];\nconst maxBtns = works.length;\nif (maxBtns > 0) {\n  for (let i = 0; i < maxBtns; i += 5) {\n    const row = [];\n    for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n      row.push({ text: 'âœ' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n    }\n    keyboard.push(row);\n  }\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ', callback_data: 'add_work' },\n  { text: L.btn_calc || 'â–¶ Ð Ð°ÑÑ‡Ñ‘Ñ‚', callback_data: 'calculate' }\n]);\nkeyboard.push([\n  { text: L.btn_new || 'ðŸ”„ Ð—Ð°Ð½Ð¾Ð²Ð¾', callback_data: 'restart' }\n]);\n\nreturn { json: { chatId, bot_token, L, msg, keyboard, works, rooms } };"
      },
      "typeVersion": 2
    },
    {
      "id": "420db4a8-19cf-43db-8289-bc932bee2a54",
      "name": "9ï¸âƒ£ Calculate",
      "type": "n8n-nodes-base.code",
      "position": [
        -2464,
        0
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// STEP 8: Calculate - FIXED VERSION v3\n// Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°Ñ…\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inputData = $input.first().json;\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('STEP 8: CALCULATE v3');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Ð£ÐœÐÐ«Ð™ ÐŸÐžÐ˜Ð¡Ðš PAYLOAD - Ð¸Ñ‰ÐµÐ¼ Ð²Ð¾ Ð²ÑÐµÑ… Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet payload = null;\nlet payloadSource = 'not_found';\n\n// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: _best_result.payload\nif (inputData._best_result?.payload?.rate_code) {\n  payload = inputData._best_result.payload;\n  payloadSource = '_best_result.payload';\n}\n// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: _best_payload Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ\nelse if (inputData._best_payload?.rate_code) {\n  payload = inputData._best_payload;\n  payloadSource = '_best_payload';\n}\n// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð»ÐµÐ¶Ð°Ñ‚ Ð¿Ñ€ÑÐ¼Ð¾ Ð² _best_result (Ð±ÐµÐ· Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ð³Ð¾ payload)\nelse if (inputData._best_result?.rate_code) {\n  payload = inputData._best_result;\n  payloadSource = '_best_result (direct)';\n}\n// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 4: payload Ð²Ð½ÑƒÑ‚Ñ€Ð¸ payload (Ð´Ð²Ð¾Ð¹Ð½Ð°Ñ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ)\nelse if (inputData._best_result?.payload?.payload?.rate_code) {\n  payload = inputData._best_result.payload.payload;\n  payloadSource = '_best_result.payload.payload';\n}\n// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 5: Ð¸Ñ‰ÐµÐ¼ rate_code Ð³Ð´Ðµ ÑƒÐ³Ð¾Ð´Ð½Ð¾ Ð² _best_result\nelse if (inputData._best_result) {\n  const br = inputData._best_result;\n  // Ð ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº\n  const findPayload = (obj, depth = 0) => {\n    if (!obj || depth > 3) return null;\n    if (obj.rate_code && obj.resources) return obj;\n    for (const key of Object.keys(obj)) {\n      if (typeof obj[key] === 'object' && obj[key] !== null) {\n        const found = findPayload(obj[key], depth + 1);\n        if (found) return found;\n      }\n    }\n    return null;\n  };\n  payload = findPayload(br);\n  if (payload) payloadSource = '_best_result (deep search)';\n}\n\nconsole.log('Payload source:', payloadSource);\nconsole.log('Payload found:', !!payload);\n\nif (payload) {\n  console.log('Payload keys:', Object.keys(payload));\n  console.log('rate_code:', payload.rate_code);\n  console.log('rate_name:', payload.rate_name?.substring(0, 50));\n  console.log('resources count:', (payload.resources || []).length);\n  console.log('cost_summary:', JSON.stringify(payload.cost_summary || {}).substring(0, 200));\n}\n\n// Ð•ÑÐ»Ð¸ payload Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ - Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸\nif (!payload) {\n  console.log('');\n  console.log('âŒ PAYLOAD NOT FOUND! Debug info:');\n  console.log('inputData keys:', Object.keys(inputData));\n  if (inputData._best_result) {\n    console.log('_best_result keys:', Object.keys(inputData._best_result));\n    console.log('_best_result.payload:', typeof inputData._best_result.payload);\n    if (inputData._best_result.payload) {\n      console.log('_best_result.payload keys:', Object.keys(inputData._best_result.payload));\n    }\n  }\n  \n  // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¾Ð¹\n  return [{ json: { \n    ...inputData,\n    rate_code: 'PAYLOAD_NOT_FOUND',\n    rate_name: inputData.name || inputData.sq || 'Unknown',\n    uc: 0, tc: 0,\n    resources: [],\n    _debug_keys: Object.keys(inputData),\n    _debug_best_result_keys: Object.keys(inputData._best_result || {}),\n    _debug_payload_source: payloadSource\n  }}];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Ð¢ÐµÐ¿ÐµÑ€ÑŒ payload Ð½Ð°Ð¹Ð´ÐµÐ½ - Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹\nconst workName = inputData.name || inputData.sq || '';\nconst workQty = inputData.qty || 1;\nconst workUnit = inputData.unit || 'mÂ²';\n\nconsole.log('');\nconsole.log('Work:', workName);\nconsole.log('Qty:', workQty, workUnit);\n\n// Ð”Ð°Ð½Ð½Ñ‹Ðµ Ñ€Ð°ÑÑ†ÐµÐ½ÐºÐ¸\nconst rateCode = payload.rate_code || 'NOT_FOUND';\nconst rateName = payload.rate_name || workName;\nconst rateUnit = payload.rate_unit || '';\n\nconsole.log('Rate code:', rateCode);\nconsole.log('Rate name:', rateName?.substring(0, 50));\nconsole.log('Rate unit:', rateUnit);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst costSummary = payload.cost_summary || {};\nlet totalCost = parseFloat(costSummary.total_cost_position || costSummary.total_cost || 0);\n\n// Ð•ÑÐ»Ð¸ cost_summary Ð¿ÑƒÑÑ‚Ð¾Ð¹, Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð¸Ð· Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²\nconst rawResources = payload.resources || [];\nif (totalCost === 0 && rawResources.length > 0) {\n  totalCost = rawResources.reduce((sum, r) => {\n    return sum + parseFloat(r.resource_cost_eur || 0);\n  }, 0);\n  console.log('Total cost calculated from resources:', totalCost);\n}\n\nconsole.log('Total cost:', totalCost);\nconsole.log('Resources count:', rawResources.length);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñ‹ Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nlet unitDivisor = 1;\nconst rateUnitLower = (rateUnit || '').toLowerCase();\n\nif (rateUnitLower.includes('100 ') || rateUnitLower === '100 Ð¼' || rateUnitLower === '100 Ð¼Â²' || rateUnitLower === '100 Ð¼2') {\n  unitDivisor = 100;\n} else if (rateUnitLower.match(/^10\\s/) || rateUnitLower.includes('10 Ð¼')) {\n  unitDivisor = 10;\n}\n\nconsole.log('Unit divisor:', unitDivisor);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Price calculation\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst uc = unitDivisor > 0 ? totalCost / unitDivisor : 0;\nconst tc = workQty * uc;\nconst scaleFactor = unitDivisor > 0 ? workQty / unitDivisor : workQty;\n\nconsole.log('');\nconsole.log('=== PRICE CALCULATION ===');\nconsole.log('UC (price per unit):', uc.toFixed(2), 'EUR');\nconsole.log('TC (total cost):', tc.toFixed(2), 'EUR');\nconsole.log('Scale factor:', scaleFactor);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nlet workersTotal = 0;\nlet materialsTotal = 0;\nlet machinesTotal = 0;\nlet laborHoursTotal = 0;\n\nconst resources = rawResources.map(r => {\n  const code = r.resource_code || '';\n  const name = r.resource_name || '';\n  const unit = r.resource_unit || '';\n  const rowType = r.row_type || '';\n  \n  const originalQty = r.resource_quantity !== null && r.resource_quantity !== undefined \n    ? parseFloat(r.resource_quantity) \n    : null;\n  const pricePerUnit = parseFloat(r.resource_price_per_unit_eur_current || 0);\n  const originalCost = parseFloat(r.resource_cost_eur || 0);\n  \n  // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ñ€ÐµÑÑƒÑ€ÑÐ°\n  let resourceType = 'material';\n  const rowTypeLower = (rowType || '').toLowerCase();\n  const codeUpper = (code || '').toUpperCase();\n  \n  if (rowTypeLower === 'Ð¼Ð°ÑˆÐ¸Ð½Ð¸ÑÑ‚' || rowTypeLower.includes('Ð¼Ð°ÑˆÐ¸Ð½Ð¸ÑÑ‚')) {\n    resourceType = 'labor';\n  } else if (rowTypeLower === 'ÑÐ»ÐµÐºÑ‚Ñ€Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾' || rowTypeLower.includes('ÑÐ»ÐµÐºÑ‚Ñ€Ð¸Ñ‡ÐµÑÑ‚Ð²')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('DXME') || codeUpper.startsWith('DX')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('ME_') || codeUpper.startsWith('PU_') || codeUpper.startsWith('RI_')) {\n    resourceType = 'labor';\n  }\n  \n  // ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ\n  let scaledQty = null;\n  let scaledCost = 0;\n  \n  if (originalQty !== null) {\n    scaledQty = originalQty * scaleFactor;\n    scaledCost = scaledQty * pricePerUnit;\n  } else {\n    scaledCost = originalCost * scaleFactor;\n  }\n  \n  // Ð¡ÑƒÐ¼Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼\n  if (resourceType === 'labor') {\n    workersTotal += scaledCost;\n    if (unit === 'Ñ‡' || unit === 'Ñ‡ÐµÐ».-Ñ‡' || unit === 'Ñ‡ÐµÐ»-Ñ‡' || unit === 'Ð¼Ð°Ñˆ.-Ñ‡') {\n      laborHoursTotal += scaledQty || 0;\n    }\n  } else if (resourceType === 'machine') {\n    machinesTotal += scaledCost;\n  } else {\n    materialsTotal += scaledCost;\n  }\n  \n  return {\n    resource_code: code,\n    resource_name: name,\n    resource_unit: unit,\n    resource_type: resourceType,\n    row_type: rowType,\n    resource_price: pricePerUnit,\n    original_quantity: originalQty,\n    original_cost: originalCost,\n    scaled_quantity: scaledQty,\n    scaled_cost: scaledCost\n  };\n});\n\nconsole.log('');\nconsole.log('=== RESOURCES BREAKDOWN ===');\nconsole.log('Resources processed:', resources.length);\nconsole.log('Workers total:', workersTotal.toFixed(2), 'EUR');\nconsole.log('Materials total:', materialsTotal.toFixed(2), 'EUR');\nconsole.log('Machines total:', machinesTotal.toFixed(2), 'EUR');\nconsole.log('Labor hours:', laborHoursTotal.toFixed(1), 'h');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Scope of work\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst workSteps = payload.work_steps || [];\nconst scopeOfWork = workSteps.map(s => s.text || '').filter(t => t.length > 0);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Quality\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst llmScore = inputData._llm_score || 0;\nconst qdrantScore = inputData._qdrant_score || 0;\n\nconst qualityLevel = llmScore >= 75 ? 'high' : \n                     llmScore >= 50 ? 'medium' : \n                     llmScore >= 25 ? 'low' : 'not_found';\n\nconsole.log('');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('âœ… CALCULATION COMPLETE');\nconsole.log('Rate:', rateCode, '-', rateName?.substring(0, 40));\nconsole.log('Total:', tc.toFixed(2), 'EUR');\nconsole.log('Resources:', resources.length);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð™ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn [{ json: { \n  // Original data\n  ...inputData,\n  name: workName,\n  qty: workQty,\n  unit: workUnit,\n  \n  // Rate\n  rate_code: rateCode,\n  rate_name: rateName,\n  rate_unit: workUnit,\n  original_rate_unit: rateUnit,\n  \n  // Prices\n  uc,\n  tc,\n  \n  // Labor\n  labor_hours: laborHoursTotal,\n  workers_total: workersTotal,\n  machines_total: machinesTotal,\n  materials_total: materialsTotal,\n  \n  // Quality\n  ql: qualityLevel,\n  quality_score: llmScore,\n  qdrant_score: qdrantScore,\n  llm_score: llmScore,\n  llm_reason: inputData._llm_reason || '',\n  \n  // Resources\n  resources,\n  \n  // Scope of work\n  scope_of_work: scopeOfWork,\n  \n  // Hierarchy\n  hierarchy: payload.hierarchy || {},\n  \n  // Breakdown\n  cost_breakdown: { \n    workers: workersTotal, \n    machines: machinesTotal, \n    materials: materialsTotal \n  },\n  \n  // Debug\n  _payload_source: payloadSource,\n  _scale_factor: scaleFactor,\n  _unit_divisor: unitDivisor,\n  _original_total_cost: totalCost\n}}];"
      },
      "typeVersion": 2
    },
    {
      "id": "aaf03f21-01b2-4da4-80d7-81a012957d5b",
      "name": "8ï¸âƒ£ Apply Rerank",
      "type": "n8n-nodes-base.code",
      "position": [
        -1264,
        -208
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 8ï¸âƒ£ APPLY RERANK v5 - Fixed empty results handling\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst prepData = $('6ï¸âƒ£ Prep Rerank').first().json;\nconst llmResponse = $input.first().json;\n\nconsole.log('=== APPLY RERANK v5 ===');\n\nconst qdrantResults = prepData._qdrant_results || [];\n\n// Early exit if no results\nif (qdrantResults.length === 0) {\n  console.log('No Qdrant results to rerank');\n  return [{ json: {\n    ...prepData,\n    _best_result: null,\n    _best_payload: {},\n    _llm_score: 0,\n    _llm_reason: 'no results',\n    _qdrant_score: 0,\n    _quality_level: 'not_found',\n    ql: 'not_found',\n    _step: 'rerank_done'\n  }}];\n}\n\n// Helper: extract actual data from various payload formats\nfunction getPayloadData(rawPayload) {\n  // Format 1: LangChain/n8n format - data in payload_full\n  if (rawPayload.payload_full) {\n    return rawPayload.payload_full;\n  }\n  // Format 2: data in metadata\n  if (rawPayload.metadata?.rate_code || rawPayload.metadata?.hierarchy) {\n    return rawPayload.metadata;\n  }\n  // Format 3: direct format - data at root level\n  if (rawPayload.rate_code || rawPayload.hierarchy) {\n    return rawPayload;\n  }\n  return rawPayload;\n}\n\nlet rankings = [];\ntry {\n  // AI node returns text directly, HTTP returns choices[0].message.content\n  let text = llmResponse.text || llmResponse.choices?.[0]?.message?.content || '';\n  \n  // Clear Ð¾Ñ‚ markdown Ð¸ Ð»Ð¸ÑˆÐ½Ð¸Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²\n  text = text.replace(/```json\\n?/g, '').replace(/```/g, '').trim();\n  \n  console.log('Raw LLM response:', text.substring(0, 200));\n  \n  // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ JSON\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    const parsed = JSON.parse(jsonMatch[0]);\n    rankings = parsed.rankings || [];\n    console.log('Parsed rankings:', rankings.length);\n  }\n} catch(e) {\n  console.log('Parse error:', e.message);\n  // Fallback - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Qdrant scores\n  rankings = qdrantResults.map((r, i) => ({\n    index: i,\n    score: Math.round((r.score || 0) * 100),\n    reason: 'qdrant score'\n  }));\n}\n\n// ÐšÐ¾Ð¼Ð±Ð¸Ð½Ð¸Ñ€ÑƒÐµÐ¼ LLM Ð¸ Qdrant scores\nconst scored = qdrantResults.map((r, i) => {\n  const rawPayload = r.payload || {};\n  const p = getPayloadData(rawPayload);\n  const h = p.hierarchy || {};\n  \n  // Normalize payload with extracted data\n  const normalizedPayload = {\n    ...p,\n    rate_code: p.rate_code || h.subsection_code || h.section_code || h.justification_nr || '',\n    rate_name: p.rate_name || h.subsection_name || h.section_name || '',\n    rate_unit: p.rate_unit || h.unit || '',\n    resources: p.resources || [],\n    work_steps: p.work_steps || [],\n    hierarchy: h\n  };\n  \n  const rank = rankings.find(x => x.index === i);\n  const llmScore = rank?.score || 0;\n  const reason = rank?.reason || '';\n  const qdrantScore = (r.score || 0) * 100;\n  \n  // Weighted combination: LLM Ð²Ð°Ð¶Ð½ÐµÐµ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ, Ð¸Ð½Ð°Ñ‡Ðµ Qdrant\n  let combinedScore;\n  if (llmScore > 0) {\n    combinedScore = llmScore * 0.7 + qdrantScore * 0.3;\n  } else {\n    combinedScore = qdrantScore;\n  }\n  \n  console.log('[' + i + '] LLM=' + llmScore + ' Qdrant=' + qdrantScore.toFixed(0) + ' Combined=' + combinedScore.toFixed(0) + ' - ' + (normalizedPayload.rate_code || 'N/A'));\n  \n  return {\n    ...r,\n    payload: normalizedPayload,\n    llm_score: llmScore,\n    llm_reason: reason,\n    qdrant_score: r.score || 0,\n    combined_score: combinedScore\n  };\n});\n\n// Sort Ð¿Ð¾ ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼Ñƒ score\nscored.sort((a, b) => b.combined_score - a.combined_score);\n\nconst best = scored[0];\nconst bestPayload = best?.payload || {};\nconst combinedScore = best?.combined_score || 0;\n\n// Determine quality Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°\nlet qualityLevel = 'not_found';\nif (combinedScore >= 80) qualityLevel = 'high';\nelse if (combinedScore >= 60) qualityLevel = 'medium';\nelse if (combinedScore >= 40) qualityLevel = 'low';\n\nconsole.log('');\nconsole.log('âœ… BEST: ' + (bestPayload.rate_code || 'N/A') + ' - ' + (bestPayload.rate_name || '').substring(0, 50));\nconsole.log('   Combined: ' + combinedScore.toFixed(0) + ' | Quality: ' + qualityLevel);\nconsole.log('   Reason: ' + (best?.llm_reason || 'N/A'));\n\nreturn [{ json: {\n  ...prepData,\n  _best_result: best || null,\n  _best_payload: bestPayload,\n  _llm_score: best?.llm_score || 0,\n  _llm_reason: best?.llm_reason || '',\n  _qdrant_score: best?.qdrant_score || 0,\n  _quality_level: qualityLevel,\n  ql: qualityLevel,\n  _step: 'rerank_done'\n}}];"
      },
      "typeVersion": 2
    },
    {
      "id": "51b2c91b-f306-4b76-ab25-3cd8f7bbbd85",
      "name": "6ï¸âƒ£ Prep Rerank",
      "type": "n8n-nodes-base.code",
      "position": [
        -1920,
        -208
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 6ï¸âƒ£ PREP RERANK v4 - Fixed for LangChain/n8n vector store format\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst prepData = $('4ï¸âƒ£ Extract Embedding').first().json;\nconst qdrantResponse = $input.first().json;\n\nconsole.log('=== PREP RERANK v4 ===');\n\nif (qdrantResponse.status?.error) {\n  return [{ json: { ...prepData, rate_code: 'QDRANT_ERROR', uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst results = qdrantResponse.result || [];\nconsole.log('Qdrant results:', results.length);\n\nif (results.length === 0) {\n  return [{ json: { ...prepData, rate_code: 'NOT_FOUND', rate_name: prepData._original_query, uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst originalQuery = prepData._original_query || prepData.name || '';\nconst workUnit = prepData.unit || 'mÂ²';\nconst workQty = prepData.qty || 1;\n\n// Helper: extract actual data from various payload formats\nfunction getPayloadData(rawPayload) {\n  // Format 1: LangChain/n8n format - data in payload_full\n  if (rawPayload.payload_full) {\n    return rawPayload.payload_full;\n  }\n  // Format 2: data in metadata\n  if (rawPayload.metadata?.rate_code || rawPayload.metadata?.hierarchy) {\n    return rawPayload.metadata;\n  }\n  // Format 3: direct format - data at root level\n  if (rawPayload.rate_code || rawPayload.hierarchy) {\n    return rawPayload;\n  }\n  // Return as-is\n  return rawPayload;\n}\n\n// Format ÐºÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²\nconst candidates = results.slice(0, 5).map((r, i) => {\n  const rawPayload = r.payload || {};\n  const p = getPayloadData(rawPayload);\n  const h = p.hierarchy || {};\n  \n  // Extract rate info (support both formats)\n  const code = p.rate_code || h.subsection_code || h.section_code || h.justification_nr || '';\n  const name = p.rate_name || h.subsection_name || h.section_name || '';\n  const unit = p.rate_unit || h.unit || '';\n  \n  // Scope of work\n  const workSteps = p.work_steps || [];\n  const scopeText = workSteps.slice(0, 3).map(s => s.text || s).join('; ');\n  \n  // Key materials\n  const resources = p.resources || [];\n  const materials = resources\n    .filter(res => !res.resource_code?.match(/^(DXME|ME_|PU_|RI_)/))\n    .slice(0, 3)\n    .map(res => res.resource_name)\n    .join(', ');\n  \n  const qdrantScore = (r.score * 100).toFixed(0);\n  \n  console.log('[' + i + '] ' + code + ' - ' + (name || '').substring(0, 40) + ' | ' + qdrantScore + '%');\n  \n  return i + '. [' + code + '] ' + name + '\\n   Unit: ' + unit + ' | Scope: ' + (scopeText || 'n/a').substring(0, 100) + '\\n   Materials: ' + (materials || 'n/a');\n}).join('\\n\\n');\n\nconst rerankPrompt = `TASK: Score construction rate candidates (0-100) for matching user's work request.\n\nSCORING GUIDE:\n95-100: EXACT MATCH - Same work type, method, materials, unit compatible\n80-94: VERY GOOD - Same work, minor spec differences (thickness, brand)\n65-79: GOOD - Same category, different specification\n50-64: PARTIAL - Related work, different scope\n30-49: WEAK - Same trade, different work type\n0-29: WRONG - Different trade or unrelated\n\nCRITICAL DISTINCTIONS:\nâ€¢ Ð“ÐšÐ› (Ð³Ð¸Ð¿ÑÐ¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½) â‰  Ð“Ð’Ð› (Ð³Ð¸Ð¿ÑÐ¾Ð²Ð¾Ð»Ð¾ÐºÐ½Ð¾) - DIFFERENT materials, max 60\nâ€¢ Ð¡Ñ‚ÐµÐ½Ñ‹ â‰  ÐŸÐ¾Ñ‚Ð¾Ð»Ð¾Ðº - check work location matches\nâ€¢ ÐœÐ¾Ð½Ñ‚Ð°Ð¶ â‰  Ð”ÐµÐ¼Ð¾Ð½Ñ‚Ð°Ð¶ - opposite operations\nâ€¢ 1 ÑÐ»Ð¾Ð¹ â‰  2 ÑÐ»Ð¾Ñ - check layer count\nâ€¢ Profile types: ÐŸÐŸ60 = ceiling, ÐŸÐ¡ = wall stud, ÐŸÐ = guide\n\nUNIT MATCHING:\nâ€¢ Query unit: ${workUnit}\nâ€¢ Rate unit should be compatible or convertible\nâ€¢ mÂ² work â†’ mÂ² rate (ideal)\nâ€¢ mÂ² work â†’ 100mÂ² rate (ok, will scale)\n\nUSER REQUEST: \"${originalQuery}\" (${workQty} ${workUnit})\n\nCANDIDATES:\n${candidates}\n\nReturn ONLY valid JSON (no markdown):\n{\"rankings\":[{\"index\":0,\"score\":N,\"reason\":\"brief reason\"},{\"index\":1,\"score\":N,\"reason\":\"brief reason\"}]}`;\n\nconsole.log('Prompt length:', rerankPrompt.length);\n\nreturn [{ json: {\n  ...prepData,\n  _qdrant_results: results,\n  _rerank_prompt: rerankPrompt,\n  _step: 'prep_rerank_done'\n}}];"
      },
      "typeVersion": 2
    },
    {
      "id": "d2c1dc15-e8fd-4b20-87bf-05eadde6dda4",
      "name": "5ï¸âƒ£ Qdrant Search",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2096,
        -208
      ],
      "parameters": {
        "url": "={{ $json._qdrant_url }}/collections/{{ $json._collection }}/points/search",
        "method": "POST",
        "options": {
          "timeout": 30000,
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        },
        "jsonBody": "={\n  \"vector\": {{ JSON.stringify($json._embedding) }},\n  \"limit\": 10,\n  \"with_payload\": true,\n  \"with_vector\": false\n}",
        "sendBody": true,
        "sendHeaders": true,
        "specifyBody": "json",
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $json._qdrant_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "a0c96cf7-02e7-43dd-b626-ad10568f48ad",
      "name": "4ï¸âƒ£ Extract Embedding",
      "type": "n8n-nodes-base.code",
      "position": [
        -2256,
        -208
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRACT EMBEDDING - Get vector from OpenAI response\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst prepData = $('2ï¸âƒ£ Extract Transform').first().json;\nconst embResponse = $input.first().json;\n\nconsole.log('=== EXTRACT EMBEDDING ===');\n\nif (embResponse.error) {\n  console.log('OpenAI Error:', embResponse.error.message);\n  return [{ json: { ...prepData, _error: embResponse.error.message, _embedding: [] }}];\n}\n\nconst embedding = embResponse.data?.[0]?.embedding || [];\nconsole.log('Embedding length:', embedding.length);\n\n// Accept various embedding sizes\nif (embedding.length < 256) {\n  console.log('WARNING: Embedding too short:', embedding.length);\n}\n\n// Pass all data including Qdrant credentials\nreturn [{ json: {\n  ...prepData,\n  _embedding: embedding,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _step: 'embedding_done'\n}}];"
      },
      "typeVersion": 2
    },
    {
      "id": "68ea3a8d-ec4f-4dc7-84ba-69b0193667ed",
      "name": "2ï¸âƒ£ Extract Transform",
      "type": "n8n-nodes-base.code",
      "position": [
        -1264,
        -400
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRACT TRANSFORM - Clean AI response and combine queries\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst prepData = $('1ï¸âƒ£ Prep Query').first().json;\nconst aiResponse = $input.first().json;\n\nconsole.log('=== EXTRACT TRANSFORM ===');\n\nlet transformedQuery = prepData._original_query;\n\ntry {\n  // n8n AI node returns text in different places\n  let content = '';\n  if (aiResponse.text) {\n    content = aiResponse.text;\n  } else if (aiResponse.response?.text) {\n    content = aiResponse.response.text;\n  } else if (aiResponse.output) {\n    content = aiResponse.output;\n  } else if (aiResponse.choices?.[0]?.message?.content) {\n    // Fallback for raw API response\n    content = aiResponse.choices[0].message.content;\n  }\n  \n  if (content && content.length > 5) {\n    transformedQuery = content\n      .replace(/^(keywords?:|search:|query:|result:)/i, '')\n      .replace(/[\\n\\r]+/g, ' ')\n      .trim();\n    console.log('Transformed OK');\n  }\n} catch(e) {\n  console.log('Transform failed:', e.message);\n}\n\nconsole.log('Original:', prepData._original_query);\nconsole.log('Transformed:', transformedQuery.substring(0, 80));\n\n// Smart combination - original is more important\nconst originalWords = prepData._original_query.toLowerCase().split(/\\s+/);\nconst transformedWords = transformedQuery.toLowerCase().split(/\\s+/);\n\n// Add only new words from transformation\nconst newWords = transformedWords.filter(w => \n  w.length > 2 && !originalWords.some(ow => ow.includes(w) || w.includes(ow))\n);\n\nconst combinedQuery = prepData._original_query + ' ' + newWords.slice(0, 10).join(' ');\n\nconsole.log('Combined:', combinedQuery.substring(0, 100));\n\nreturn [{ json: {\n  ...prepData,\n  _query: combinedQuery.trim(),\n  _transformed_query: transformedQuery,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _step: 'transform_done'\n}}];"
      },
      "typeVersion": 2
    },
    {
      "id": "4dc79df3-d1c1-441f-9a78-bc019de5bbbf",
      "name": "ðŸ“¤ Details",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -3728,
        -720
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $json.L.btn_export_excel || 'â†“ Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || 'â†“ PDF' }}\", \"callback_data\": \"export_pdf\"}],\n      [{\"text\": \"{{ $json.L.btn_restart || 'â†» Restart' }}\", \"callback_data\": \"restart\"}]\n    ]\n  }\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "afb04e6f-e242-4434-9458-6dfe4de368a2",
      "name": "View Details",
      "type": "n8n-nodes-base.code",
      "position": [
        -3920,
        -720
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Detailed view with resource prices\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\nconst sym = L.sym || 'â‚¬';\n\nfunction fmtCur(v) { \n  if (!v || v === 0) return sym + ' 0';\n  return sym + ' ' + v.toFixed(2); \n}\n\nlet msg = `*${L.ready} â€” ${L.resources}*\\n\\n`;\n\nworks.forEach((w, i) => {\n  const qi = { 'high': 'â—', 'medium': 'â—‹', 'low': 'â—Œ', 'not_found': 'âœ•' }[w.ql] || 'â—‹';\n  \n  msg += `*${i+1}. ${w.name}*\\n`;\n  if (w.rate_code && w.rate_code !== 'NOT_FOUND') {\n    msg += `${qi} \\`${w.rate_code}\\`\\n`;\n    if (w.rate_name && w.rate_name !== w.name) {\n      const rateName = (w.rate_name || '').substring(0, 45);\n      msg += `_${rateName}_\\n`;\n    }\n  } else {\n    msg += `${qi} _${L.not_found}_\\n`;\n  }\n  msg += `${w.qty} ${w.unit} Ã— ${fmtCur(w.uc)} = *${fmtCur(w.tc)}*\\n`;\n  \n  // Cost breakdown\n  const parts = [];\n  if (w.workers_total > 0) parts.push(`${L.workers}: ${fmtCur(w.workers_total)}`);\n  if (w.materials_total > 0) parts.push(`${L.materials}: ${fmtCur(w.materials_total)}`);\n  if (w.machines_total > 0) parts.push(`${L.machines}: ${fmtCur(w.machines_total)}`);\n  if (parts.length > 0) msg += `_${parts.join(' Â· ')}_\\n`;\n  \n  // Resources with prices\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    msg += `\\n`;\n    const showCount = Math.min(5, resources.length);\n    resources.slice(0, showCount).forEach((r, ri) => {\n      const isLast = ri === showCount - 1 && resources.length <= 5;\n      const prefix = isLast ? 'â””' : 'â”œ';\n      const typeTag = r.resource_type === 'labor' ? L.res_labor : r.resource_type === 'machine' ? L.res_machine : L.res_material;\n      const resName = (r.resource_name || '').substring(0, 26);\n      msg += `${prefix} *${typeTag}*: ${resName}\\n`;\n      \n      // Show quantity and cost\n      const qtyVal = r.scaled_quantity || r.resource_quantity || 0;\n      const costVal = r.scaled_cost || r.resource_cost || 0;\n      if (costVal > 0) {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''} = ${fmtCur(costVal)}\\n`;\n      } else {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''}\\n`;\n      }\n    });\n    if (resources.length > 5) {\n      msg += `â”” _...+${resources.length - 5} ${L.resources}_\\n`;\n    }\n  }\n  \n  // Scope of work\n  const scope = w.scope_of_work || [];\n  if (scope.length > 0) {\n    msg += `\\nðŸ“‹ *${L.scope_title || 'Scope of Work'}:*\\n`;\n    scope.forEach((s, si) => {\n      const prefix = si === scope.length - 1 ? 'â””' : 'â”œ';\n      const sText = (s || '').substring(0, 45);\n      msg += `${prefix} ${sText}\\n`;\n    });\n  }\n  msg += `\\n`;\n});\n\n// Summary\nmsg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n`;\nconst totalParts = [];\nif (data.workers_sum > 0) totalParts.push(`${L.workers}: ${fmtCur(data.workers_sum)}`);\nif (data.materials_sum > 0) totalParts.push(`${L.materials}: ${fmtCur(data.materials_sum)}`);\nif (data.machines_sum > 0) totalParts.push(`${L.machines}: ${fmtCur(data.machines_sum)}`);\nif (totalParts.length > 0) msg += totalParts.join('\\n') + '\\n\\n';\n\nmsg += `*${L.total}: ${fmtCur(data.total || 0)}*\\n`;\n\nreturn { json: { ...cfg, msg, chatId: cid, bot_token: cfg.bot_token, L } };"
      },
      "typeVersion": 2
    },
    {
      "id": "c3aad83b-e6bf-4ec8-b283-daa45871eab9",
      "name": "ðŸ“¤ Fallback",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -4272,
        -1232
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify(($json.L && $json.L.fallback_start) || \"Use /start to begin\") }},\n  \"parse_mode\": \"Markdown\"\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "1b9da534-f7af-4bb6-b8ab-7b43749584db",
      "name": "ðŸ“¤ Help",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -3920,
        -720
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR - Help*\\n\\n*What is DDC CWICR?*\\nOpen source construction cost database\\nhttps://DataDrivenConstruction.io\\n\\n*Features:*\\nðŸ“¸ Photo analysis with AI\\nðŸ“ Text input with work lists\\nðŸŒ 9 languages supported\\nðŸ“Š 55,000+ work items\\nðŸ’° Regional pricing (EUR, USD, RUB, etc.)\\nðŸ“„ Excel & PDF export\\n\\n*How to use:*\\n1. Select your language\\n2. Send photo OR text description\\n3. Edit detected works if needed\\n4. Get cost estimate\\n\\n*Commands:*\\n/start - New estimate\\n\\n*Contact:*\\nGitHub: github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [[{\"text\": \"â—€ï¸ Back\", \"callback_data\": \"back_to_lang\"}]]\n  }\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "db60dd77-e822-4331-bd7c-3aa78e4da29c",
      "name": "ðŸ“¤ Send PDF",
      "type": "n8n-nodes-base.telegram",
      "position": [
        -3488,
        -880
      ],
      "webhookId": "0cfa0dd8-bdc3-4031-9a7a-1d3948d2c347",
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "operation": "sendDocument",
        "binaryData": true,
        "additionalFields": {
          "caption": "={{ $json.L?.export_pdf_msg || 'ðŸ“„ PDF Export (HTML)' }}",
          "fileName": "={{ $json.filename }}"
        },
        "binaryPropertyName": "pdf"
      },
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "8d1a58e4-a704-4624-8180-0b529806f3c3",
      "name": "IF PDF",
      "type": "n8n-nodes-base.if",
      "position": [
        -3728,
        -864
      ],
      "parameters": {
        "options": {},
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              },
              "leftValue": "={{ $json.skip }}",
              "rightValue": true
            }
          ]
        }
      },
      "typeVersion": 2.2
    },
    {
      "id": "4b92eb93-933b-4f56-8e21-687d11a0e0c1",
      "name": "Generate PDF",
      "type": "n8n-nodes-base.code",
      "position": [
        -3920,
        -864
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Generate PDF (using HTML-to-PDF service or return HTML)\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst html = sd.html_report || '';\nconst L = sd.lastResults?.L || cfg.L || {};\n\nif (!html) {\n  // No HTML report yet - send message\n  try {\n    await $http.request({\n      method: 'POST',\n      url: `https://api.telegram.org/bot${cfg.bot_token}/sendMessage`,\n      body: { chat_id: parseInt(cid), text: 'âŒ No report to export. Please calculate first.' },\n      json: true\n    });\n  } catch(e) {}\n  return { json: { skip: true } };\n}\n\n// For now, send HTML file as \"PDF alternative\"\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.html`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { pdf: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "typeVersion": 2
    },
    {
      "id": "46040b41-3270-4544-a7f3-1fc4fef3827c",
      "name": "ðŸ“¤ Send Excel",
      "type": "n8n-nodes-base.telegram",
      "position": [
        -3728,
        -560
      ],
      "webhookId": "944e581c-0095-4205-9487-8551328862ea",
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "operation": "sendDocument",
        "binaryData": true,
        "additionalFields": {
          "caption": "={{ $json.L?.export_excel_msg || 'ðŸ“Š Excel Export (CSV)' }}",
          "fileName": "={{ $json.filename }}"
        },
        "binaryPropertyName": "excel"
      },
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "f2db6463-97c3-48e2-84e3-0a8f5fb1708e",
      "name": "Generate Excel",
      "type": "n8n-nodes-base.code",
      "position": [
        -3920,
        -560
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Generate Excel file\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\n\n// Create CSV content (Excel-compatible)\nlet csv = '\\uFEFF'; // BOM for UTF-8\ncsv += `${L.doc_title || 'ESTIMATE'} - ${data.description || 'Estimate'}\\n`;\ncsv += `${L.region || 'Region'} | ${new Date().toLocaleDateString()}\\n\\n`;\n\n// Headers\ncsv += `${L.col_pos || 'Pos'};${L.col_code || 'Code'};${L.col_desc || 'Description'};${L.col_unit || 'Unit'};${L.col_qty || 'Qty'};${L.col_price || 'Price'};${L.col_total || 'Total'}\\n`;\n\n// Data rows\nworks.forEach((w, i) => {\n  const name = (w.rate_name || w.name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n  csv += `${i+1};${w.rate_code || ''};\"${name}\";${w.rate_unit || w.unit || ''};${(w.qty || 0).toFixed(2)};${(w.uc || 0).toFixed(2)};${(w.tc || 0).toFixed(2)}\\n`;\n  \n  // Resources\n  (w.resources || []).forEach(r => {\n    const resName = (r.resource_name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n    csv += `;${r.resource_code || ''};\"  ${resName}\";${r.resource_unit || ''};${(r.scaled_quantity || 0).toFixed(3)};${(r.resource_price || 0).toFixed(2)};${(r.scaled_cost || 0).toFixed(2)}\\n`;\n  });\n});\n\n// Totals\ncsv += `\\n;;;;;${L.total || 'TOTAL'};${(data.total || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.workers || 'Labor'};${(data.workers_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.materials || 'Materials'};${(data.materials_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.machines || 'Equipment'};${(data.machines_sum || 0).toFixed(2)}\\n`;\n\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.csv`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { excel: { data: Buffer.from(csv, 'utf-8').toString('base64'), mimeType: 'text/csv', fileName: filename } } };"
      },
      "typeVersion": 2
    },
    {
      "id": "50c3a592-49e4-4c66-a26a-fd48ad24894c",
      "name": "ðŸ“¤ Send HTML",
      "type": "n8n-nodes-base.telegram",
      "position": [
        -1152,
        -784
      ],
      "webhookId": "2d59d493-4108-40d3-b74e-77fd2b869592",
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "operation": "sendDocument",
        "binaryData": true,
        "additionalFields": {
          "caption": "ðŸ“Š Professional HTML Report",
          "fileName": "={{ $json.filename }}"
        },
        "binaryPropertyName": "html"
      },
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "547ccce6-8b5c-415d-9c20-6e2ccd30bf91",
      "name": "Prep HTML File",
      "type": "n8n-nodes-base.code",
      "position": [
        -1376,
        -784
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst d = $input.first().json;\nconst html = d.html_content || '';\nconst L = d.L || {};\nconst now = new Date();\nconst ts = now.toISOString().replace(/[:.]/g, '-').substring(0, 16);\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${ts}.html`;\n\nreturn { json: { chatId: d.chatId, bot_token: d.bot_token, filename }, binary: { html: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "typeVersion": 2
    },
    {
      "id": "36335c56-6c71-43aa-b12c-19f182a8edca",
      "name": "ðŸ“¤ Final",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1376,
        -928
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"{{ $json.L.resources || 'Resources' }}\", \"callback_data\": \"view_details\"}], [{\"text\": \"{{ $json.L.btn_export_excel || 'Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || 'PDF' }}\", \"callback_data\": \"export_pdf\"}], [{\"text\": \"{{ $json.L.btn_restart || 'New' }}\", \"callback_data\": \"restart\"}]]}}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "beab9359-66f2-4fe3-b554-336be6767f3b",
      "name": "Final",
      "type": "n8n-nodes-base.code",
      "position": [
        -1584,
        -784
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Final message (ultra-compact for Telegram 4096 limit)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst d = $('Generate HTML').first().json;\nconst cid = d.chatId;\nconst sd = $getWorkflowStaticData('global');\nconst L = d.L || {};\n\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.sess?.[cid]) sd.sess[cid].state = 'done';\n\nfunction fmt(v) { \n  try { return new Intl.NumberFormat(L.loc || 'en', { maximumFractionDigits: 0 }).format(v || 0); } \n  catch(e) { return String(Math.round(v || 0)); } \n}\n\nfunction fmtCur(v) { \n  const sym = L.sym || '$';\n  const num = Math.round(v || 0);\n  return sym + ' ' + fmt(num);\n}\n\nfunction esc(s) {\n  // Remove ALL markdown special chars to avoid Telegram parse errors\n  return String(s || '').replace(/[_*`\\[\\]()~>#+\\-=|{}.!\\\\]/g, '');\n}\n\nfunction shortName(str, len) {\n  str = esc(str);\n  if (str.length > len) return str.substring(0, len - 1) + 'â€¦';\n  return str;\n}\n\nconst works = d.works || [];\nconst total = d.total || 0;\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(L.loc || 'en', { day: '2-digit', month: '2-digit', year: 'numeric' });\n\n// Build compact message\nlet lines = [];\n\n// Header\nlines.push('*' + esc(L.doc_title || 'COST ESTIMATE') + '*');\nlines.push(dateStr + ' Â· ' + esc(L.region || ''));\nlines.push(works.length + ' ' + esc(L.items || 'items'));\nlines.push('');\n\n// Works list - super compact\nconst MAX_ITEMS_SHOWN = 30;\nconst showWorks = works.slice(0, MAX_ITEMS_SHOWN);\n\nshowWorks.forEach((w, i) => {\n  const name = shortName(w.rate_name || w.name || '', 20);\n  lines.push((i+1) + '. ' + name + ' ' + fmtCur(w.tc));\n});\n\nif (works.length > MAX_ITEMS_SHOWN) {\n  lines.push('... +' + (works.length - MAX_ITEMS_SHOWN) + ' ' + esc(L.more_resources || 'more'));\n}\n\n// Total\nlines.push('');\nlines.push('*' + esc(L.total || 'TOTAL') + ': ' + fmtCur(total) + '*');\nlines.push('');\n\n// Breakdown (one line)\nconst parts = [];\nif (d.workers_sum > 0) parts.push(fmtCur(d.workers_sum));\nif (d.materials_sum > 0) parts.push(fmtCur(d.materials_sum));\nif (d.machines_sum > 0) parts.push(fmtCur(d.machines_sum));\nif (parts.length > 0) lines.push(parts.join(' Â· '));\n\n// Hours\nif (d.labor_hours_sum > 0) {\n  const days = Math.ceil(d.labor_hours_sum / 8);\n  lines.push(fmt(d.labor_hours_sum) + 'h Â· ' + days + ' ' + esc(L.days || 'd'));\n}\n\n// Build message\nlet msg = lines.join('\\n');\n\n// Hard truncate at 3800 chars to be safe\nif (msg.length > 3800) {\n  msg = msg.substring(0, 3700);\n  msg += '\\n\\n...\\n*' + esc(L.total || 'TOTAL') + ': ' + fmtCur(total) + '*';\n}\n\nconsole.log('Final msg length:', msg.length);\n\nreturn { json: { ...d, msg } };"
      },
      "typeVersion": 2
    },
    {
      "id": "15e86a97-6806-49e5-82dd-d5546f164475",
      "name": "Generate HTML",
      "type": "n8n-nodes-base.code",
      "position": [
        -1744,
        -784
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Generate HTML Report with expandable resources\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst d = $('Agg').first().json;\nconst L = d.L || {};\nconst cur = L.cur || 'USD'; \nconst loc = L.loc || 'en'; \nconst sym = L.sym || '$';\nconst works = d.works || []; \nconst total = d.total || 0;\n\nfunction fmt(v) { \n  try { \n    return new Intl.NumberFormat(loc, { style: 'currency', currency: cur, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v || 0); \n  } catch(e) { \n    return sym + ' ' + (v || 0).toFixed(2); \n  } \n}\nfunction fmtNum(v, dec) { \n  return new Intl.NumberFormat(loc, { minimumFractionDigits: dec || 2, maximumFractionDigits: dec || 2 }).format(v || 0); \n}\nfunction esc(t) { \n  return String(t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); \n}\n\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' });\nconst timeStr = now.toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' });\n\nconst laborPct = total > 0 ? Math.round(d.workers_sum / total * 100) : 0;\nconst materialPct = total > 0 ? Math.round(d.materials_sum / total * 100) : 0;\nconst machinePct = total > 0 ? Math.round(d.machines_sum / total * 100) : 0;\nconst laborDays = Math.ceil((d.labor_hours_sum || 0) / 8);\n\nlet html = `<!DOCTYPE html>\n<html><head><meta charset=\"UTF-8\">\n<title>${esc(L.doc_title || 'Cost Estimate')} - ${esc(d.description || '')}</title>\n<style>\n:root{--primary:#007AFF;--text:#1D1D1F;--text2:#86868B;--text3:#AEAEB2;--bg:#FFF;--bg2:#F5F5F7;--bg3:#E8E8ED;--border:#D2D2D7;--labor:#E3F2FD;--labor-text:#1565C0;--material:#FFF3E0;--material-text:#E65100;--machine:#F3E5F5;--machine-text:#7B1FA2}\n*{box-sizing:border-box}\nbody{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,sans-serif;margin:0;padding:16px;background:var(--bg2);color:var(--text);font-size:12px;line-height:1.4}\n.container{background:var(--bg);max-width:1200px;margin:0 auto;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);overflow:hidden}\n.header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}\n.header h1{margin:0;font-size:18px;font-weight:600}\n.header-info{font-size:11px;color:var(--text3)}\n.toolbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}\n.btn{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:11px}\n.btn:hover{background:var(--bg3)}\n.kpi{display:flex;gap:8px;padding:12px 20px;background:var(--bg2);flex-wrap:wrap}\n.kpi-card{background:var(--bg);border-radius:8px;padding:10px 14px;border:1px solid var(--border);min-width:100px}\n.kpi-value{font-size:16px;font-weight:600}\n.kpi-label{font-size:9px;color:var(--text3);text-transform:uppercase}\ntable{width:100%;border-collapse:collapse}\nth,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}\nth{background:var(--bg2);font-weight:500;font-size:10px;text-transform:uppercase;color:var(--text2)}\n.work-row{cursor:pointer;transition:background 0.15s}\n.work-row:hover{background:var(--bg2)}\n.work-row td:first-child{font-weight:500}\n.toggle{width:20px;color:var(--text3);font-size:10px}\n.res-row{background:#FAFAFA;font-size:11px}\n.res-row.hidden{display:none}\n.scope-row{background:#F0FFF0;font-size:11px}\n.scope-row.hidden{display:none}\n.scope-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed #D0E8D0}\n.scope-toggle{color:var(--primary);cursor:pointer;font-size:10px;margin-left:8px}\n.res-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed var(--border)}\n.res-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:500;margin-right:6px}\n.res-labor{background:var(--labor);color:var(--labor-text)}\n.res-material{background:var(--material);color:var(--material-text)}\n.res-machine{background:var(--machine);color:var(--machine-text)}\n.summary-row{background:linear-gradient(90deg,var(--bg2),var(--bg));font-size:10px}\n.summary-row.hidden{display:none}\n.summary-row td{padding:6px 10px 6px 30px;border-top:1px solid var(--border)}\n.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}\n.dot-high{background:#34C759}\n.dot-medium{background:#FF9500}\n.dot-low{background:#FF3B30}\n.dot-none{background:#8E8E93}\n.total-row{background:var(--bg2);font-weight:600}\n.total-row td{padding:12px 10px}\n.right{text-align:right}\n.footer{padding:16px 20px;text-align:center;font-size:10px;color:var(--text3);border-top:1px solid var(--border)}\n.footer a{color:var(--primary);text-decoration:none}\n@media(max-width:600px){\n  body{padding:8px;font-size:11px}\n  th,td{padding:6px}\n  .kpi-card{min-width:80px;padding:8px}\n  .kpi-value{font-size:14px}\n}\n</style>\n</head><body>\n<div class=\"container\">\n<div class=\"header\">\n  <h1>${esc(L.doc_title || 'Cost Estimate')}</h1>\n  <div class=\"header-info\">${dateStr} ${timeStr} Â· ${esc(L.region || '')}</div>\n</div>\n<div class=\"toolbar\">\n  <button class=\"btn\" onclick=\"expandAll()\">${esc(L.expand_all || 'Expand All')}</button>\n  <button class=\"btn\" onclick=\"collapseAll()\">${esc(L.collapse_all || 'Collapse All')}</button>\n</div>\n<div class=\"kpi\">\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${fmt(total)}</div><div class=\"kpi-label\">${esc(L.kpi_total || 'Total')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${works.length}</div><div class=\"kpi-label\">${esc(L.kpi_items || 'Items')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborDays}d</div><div class=\"kpi-label\">${esc(L.kpi_days || 'Days')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborPct}%</div><div class=\"kpi-label\">${esc(L.workers || 'Labor')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${materialPct}%</div><div class=\"kpi-label\">${esc(L.materials || 'Materials')}</div></div>\n</div>\n<table>\n<tr>\n  <th style=\"width:30px\"></th>\n  <th>${esc(L.col_code || 'Code')}</th>\n  <th>${esc(L.col_desc || 'Description')}</th>\n  <th>${esc(L.col_unit || 'Unit')}</th>\n  <th class=\"right\">${esc(L.col_qty || 'Qty')}</th>\n  <th class=\"right\">${esc(L.col_price || 'Price')}</th>\n  <th class=\"right\">${esc(L.col_total || 'Total')}</th>\n  <th style=\"width:30px\"></th>\n</tr>`;\n\nworks.forEach((w, i) => {\n  console.log('Work ' + (i+1) + ': ' + (w.rate_name || w.name) + ' - Resources: ' + (w.resources || []).length);\n  const hasRes = (w.resources || []).length > 0;\n  const isFirst = i === 0;\n  const dotClass = w.ql === 'high' ? 'dot-high' : w.ql === 'medium' ? 'dot-medium' : w.ql === 'low' ? 'dot-low' : 'dot-none';\n  const code = w.rate_code && w.rate_code !== 'NOT_FOUND' ? w.rate_code : 'â€”';\n  \n  const hasScope = (w.scope_of_work || []).length > 0;\n  const scopeBtn = hasScope ? '<span class=\"scope-toggle\" onclick=\"event.stopPropagation();toggleScope(' + i + ')\">ðŸ“‹</span>' : '';\n  \n  html += `<tr class=\"work-row\" data-work=\"${i}\" onclick=\"toggleWork(${i})\">\n    <td class=\"toggle\"><span id=\"icon-${i}\">${isFirst ? 'â–¼' : 'â–¶'}</span></td>\n    <td style=\"font-size:10px;color:var(--text2)\">${esc(code)}</td>\n    <td><strong>${esc(w.rate_name || w.name)}</strong>${scopeBtn}</td>\n    <td>${esc(w.rate_unit || w.unit)}</td>\n    <td class=\"right\">${fmtNum(w.qty)}</td>\n    <td class=\"right\">${fmt(w.uc)}</td>\n    <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n    <td><span class=\"dot ${dotClass}\" title=\"${w.llm_match || ''}\"></span>${w.llm_score ? '<span style=\"font-size:9px;color:var(--text3);margin-left:2px\">' + w.llm_score + '</span>' : ''}</td>\n  </tr>`;\n  \n  // Scope of work rows\n  const scopeItems = w.scope_of_work || [];\n  if (scopeItems.length > 0) {\n    html += `<tr class=\"scope-row hidden\" data-scope=\"${i}\">\n      <td></td>\n      <td colspan=\"6\" style=\"background:#F8FFF8\">\n        <strong style=\"color:#2E7D32\">ðŸ“‹ ${esc(L.scope_title || 'Scope of Work')}:</strong><br>\n        ${scopeItems.map((s, si) => '<span style=\"color:#555\">â€¢ ' + esc(s) + '</span>').join('<br>')}\n      </td>\n      <td></td>\n    </tr>`;\n  }\n  \n  // Resources\n  const resources = w.resources || [];\n  resources.forEach((r, ri) => {\n    const tagClass = r.resource_type === 'labor' ? 'res-labor' : r.resource_type === 'machine' ? 'res-machine' : 'res-material';\n    const tagLabel = r.resource_type === 'labor' ? (L.res_labor || 'Labor') : r.resource_type === 'machine' ? (L.res_machine || 'Equip') : (L.res_material || 'Mat');\n    const hiddenClass = isFirst ? '' : 'hidden';\n    const resQty = r.scaled_quantity || r.resource_quantity || 0;\n    const resPrice = r.resource_price || 0;\n    const resCost = r.scaled_cost || 0;\n    const norm = r.resource_quantity || r.norma || 0;\n    const pct = w.tc > 0 ? Math.round(resCost / w.tc * 100) : 0;\n    \n    html += `<tr class=\"res-row ${hiddenClass}\" data-work=\"${i}\">\n      <td></td>\n      <td><span style=\"font-size:9px;color:var(--text3)\">${esc(r.resource_code || '')}</span></td>\n      <td>\n        <span class=\"res-tag ${tagClass}\">${esc(tagLabel)}</span>\n        ${esc(r.resource_name || '')}\n        ${norm ? '<span style=\"color:var(--text3);font-size:9px;margin-left:4px\">Ã—' + fmtNum(norm, 4) + '</span>' : ''}\n      </td>\n      <td style=\"font-size:10px\">${esc(r.resource_unit || '')}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmtNum(resQty, 3)}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmt(resPrice)}</td>\n      <td class=\"right\">${fmt(resCost)} <span style=\"font-size:9px;color:var(--text3)\">${pct}%</span></td>\n      <td></td>\n    </tr>`;\n  });\n  \n  // Summary row for work\n  if (resources.length > 0) {\n    const laborSum = resources.filter(r => r.resource_type === 'labor').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const matSum = resources.filter(r => r.resource_type === 'material').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const machSum = resources.filter(r => r.resource_type === 'machine').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const hiddenClass = isFirst ? '' : 'hidden';\n    \n    html += `<tr class=\"summary-row ${hiddenClass}\" data-work=\"${i}\">\n      <td colspan=\"2\"></td>\n      <td colspan=\"4\">\n        <span style=\"color:var(--labor-text)\">${L.workers || 'Labor'}: ${fmt(laborSum)}</span> Â· \n        <span style=\"color:var(--material-text)\">${L.materials || 'Mat'}: ${fmt(matSum)}</span> Â· \n        <span style=\"color:var(--machine-text)\">${L.machines || 'Equip'}: ${fmt(machSum)}</span>\n      </td>\n      <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n      <td></td>\n    </tr>`;\n  }\n});\n\nhtml += `<tr class=\"total-row\">\n  <td colspan=\"6\" style=\"text-align:right\">${esc(L.grand_total || 'TOTAL')}</td>\n  <td class=\"right\">${fmt(total)}</td>\n  <td></td>\n</tr>\n</table>\n<div class=\"footer\">\n  <a href=\"https://DataDrivenConstruction.io\" target=\"_blank\">DDC CWICR</a> Â· \n  Open Source Construction Cost Database Â· ${dateStr}\n</div>\n</div>\n<script>\nfunction toggleWork(idx) {\n  const icon = document.getElementById('icon-' + idx);\n  const rows = document.querySelectorAll('tr[data-work=\"' + idx + '\"]:not(.work-row)');\n  const isHidden = rows.length > 0 && rows[0].classList.contains('hidden');\n  rows.forEach(r => r.classList.toggle('hidden', !isHidden));\n  if (icon) icon.textContent = isHidden ? 'â–¼' : 'â–¶';\n}\nfunction expandAll() {\n  document.querySelectorAll('tr[data-work]').forEach(r => r.classList.remove('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = 'â–¼');\n}\nfunction collapseAll() {\n  document.querySelectorAll('tr.res-row, tr.summary-row, tr.scope-row').forEach(r => r.classList.add('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = 'â–¶');\n}\nfunction toggleScope(idx) {\n  const rows = document.querySelectorAll('tr.scope-row[data-scope=\"' + idx + '\"]');\n  rows.forEach(r => r.classList.toggle('hidden'));\n}\n</script>\n</body></html>`;\n\nconst sd = $getWorkflowStaticData('global');\nsd.html_report = html;\n\nreturn { json: { ...d, html_content: html } };"
      },
      "typeVersion": 2
    },
    {
      "id": "652200d3-b872-4e16-8a78-81f62cfed6f1",
      "name": "Answer Calc CB",
      "type": "n8n-nodes-base.httpRequest",
      "onError": "continueRegularOutput",
      "position": [
        -3920,
        -1024
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/answerCallbackQuery",
        "method": "POST",
        "options": {
          "timeout": 5000
        },
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\",\n  \"text\": \"{{ $('Config').item.json.L.loading }}\",\n  \"show_alert\": false\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "06108977-5e6c-4ded-bc87-481a1f213469",
      "name": "ðŸ“¤ Works Updated",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -4128,
        -1376
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "6e8b2b3d-e435-4a4f-acdd-8dfc3fb7948e",
      "name": "Works Updated",
      "type": "n8n-nodes-base.code",
      "position": [
        -4272,
        -1376
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// WORKS UPDATED - Show updated works list after quantity change\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== WORKS UPDATED ===');\nconsole.log('Works:', works.length);\nconsole.log('L.native:', L.native);\n\nlet msg = 'âœ… ' + (L.work_added || 'ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾') + '\\n\\n';\nmsg += '*' + works.length + ' ' + (L.items || 'Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹') + '*\\n\\n';\n\nfor (let i = 0; i < works.length; i++) {\n  const w = works[i];\n  const name = w.name.length > 25 ? w.name.substring(0, 22) + '...' : w.name;\n  msg += (i + 1) + '. ' + name + ' â€” ' + w.qty + ' ' + (w.unit || 'mÂ²') + '\\n';\n}\n\n// No limit\n\nconst keyboard = [];\nconst maxBtns = works.length;\nfor (let i = 0; i < maxBtns; i += 5) {\n  const row = [];\n  for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n    row.push({ text: 'âœï¸' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n  }\n  keyboard.push(row);\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ', callback_data: 'add_work' },\n  { text: L.btn_calc || 'â–¶ Ð Ð°ÑÑ‡Ñ‘Ñ‚', callback_data: 'calculate' }\n]);\nkeyboard.push([{ text: L.btn_new || 'ðŸ”„ Ð—Ð°Ð½Ð¾Ð²Ð¾', callback_data: 'restart' }]);\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "typeVersion": 2
    },
    {
      "id": "b4972bc3-4ad6-4fc9-ba80-c2b54fa94ae8",
      "name": "ðŸ“¤ Ask New Work",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -4272,
        -2128
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.enter_work) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "22ebe40e-e174-4a2c-917c-9cd3836c8a68",
      "name": "Edit Menu",
      "type": "n8n-nodes-base.code",
      "position": [
        -4272,
        -1520
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EDIT MENU - Show edit buttons for selected work item\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconst idx = session.editingWorkIndex || cfg.editingWorkIndex || 0;\nconst work = works[idx];\n\nconsole.log('=== EDIT MENU ===');\nconsole.log('Editing work index:', idx);\nconsole.log('Work:', work?.name);\n\nif (!work) {\n  return { json: { ...cfg, _skip: true } };\n}\n\nconst name = work.name.length > 30 ? work.name.substring(0, 27) + '...' : work.name;\nlet msg = 'âœï¸ *' + (L.btn_edit || 'Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ') + '*\\n\\n';\nmsg += '*' + (idx + 1) + '. ' + name + '*\\n';\nmsg += 'ðŸ“ ' + work.qty + ' ' + (work.unit || 'mÂ²') + '\\n\\n';\nmsg += (L.edit_hint || 'Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾:');\n\n// Quantity edit buttons\nconst keyboard = [\n  [\n    { text: '-10', callback_data: 'qty_work_' + idx + '_minus10' },\n    { text: '-1', callback_data: 'qty_work_' + idx + '_minus1' },\n    { text: '+1', callback_data: 'qty_work_' + idx + '_plus1' },\n    { text: '+10', callback_data: 'qty_work_' + idx + '_plus10' }\n  ],\n  [\n    { text: 'Ã·2', callback_data: 'qty_work_' + idx + '_half' },\n    { text: 'Ã—2', callback_data: 'qty_work_' + idx + '_double' }\n  ],\n  [\n    { text: 'ðŸ—‘ ' + (L.btn_delete || 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ'), callback_data: 'delete_work_' + idx }\n  ],\n  [\n    { text: 'â—€ï¸ ' + (L.btn_done || 'ÐÐ°Ð·Ð°Ð´'), callback_data: 'done_editing' }\n  ]\n];\n\nreturn { json: { ...cfg, msg, keyboard, chatId: cid } };"
      },
      "typeVersion": 2
    },
    {
      "id": "e1cb2be1-216e-4826-9438-004b65c3fa57",
      "name": "ðŸ“¤ Lang OK",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -3968,
        -2288
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={{ JSON.stringify($json._body) }}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "948a9e11-d8f5-43bb-93c9-d83a198a86a6",
      "name": "Answer Lang CB",
      "type": "n8n-nodes-base.httpRequest",
      "onError": "continueRegularOutput",
      "position": [
        -4272,
        -2288
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/answerCallbackQuery",
        "method": "POST",
        "options": {
          "timeout": 5000
        },
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\"\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "dc1f5a37-6590-433d-adba-e59843e63aa0",
      "name": "ðŸ“¤ Lang Menu",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -4272,
        -2432
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR Cost Estimator*\\nhttps://DataDrivenConstruction.io\\n\\nâ–¸ Photo analysis (up to 4)\\nâ–¸ Text description\\nâ–¸ 9 languages Â· 55,000+ work items\\nâ–¸ Excel & PDF export\\n\\nSelect language:\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"ðŸ‡©ðŸ‡ª Deutsch\", \"callback_data\": \"lang_DE\"}, {\"text\": \"ðŸ‡¬ðŸ‡§ English\", \"callback_data\": \"lang_EN\"}, {\"text\": \"ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹\", \"callback_data\": \"lang_RU\"}],\n      [{\"text\": \"ðŸ‡ªðŸ‡¸ EspaÃ±ol\", \"callback_data\": \"lang_ES\"}, {\"text\": \"ðŸ‡«ðŸ‡· FranÃ§ais\", \"callback_data\": \"lang_FR\"}, {\"text\": \"ðŸ‡§ðŸ‡· PortuguÃªs\", \"callback_data\": \"lang_PT\"}],\n      [{\"text\": \"ðŸ‡¨ðŸ‡³ ä¸­æ–‡\", \"callback_data\": \"lang_ZH\"}, {\"text\": \"ðŸ‡¦ðŸ‡ª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\", \"callback_data\": \"lang_AR\"}, {\"text\": \"ðŸ‡®ðŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€\", \"callback_data\": \"lang_HI\"}],\n      [{\"text\": \"â“ Help\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "2bb17fad-5bfa-4332-a937-fb7c88c4fef5",
      "name": "Route",
      "type": "n8n-nodes-base.switch",
      "position": [
        -4544,
        -1728
      ],
      "parameters": {
        "rules": {
          "values": [
            {
              "outputKey": "LANG",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "a3c7266e-9deb-4abe-a856-0e835757cdc8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_lang"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "LANG_OK",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "abc9388b-156f-4a27-8b6b-16d0e18e9749",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "lang_selected"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "WORKS_UPD",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "320b81af-ef5e-4776-814d-3aead2e0a38a",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "works_updated"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "EDIT_MENU",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "def6b912-0ac9-4066-b421-59fd67b596c8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_edit_menu"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "ADD_WORK",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "4ca5650d-0486-456a-b17c-34ec088923d1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_new_work"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "CALC",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "8f7bceab-ef7c-43b4-8afa-a8c309a74645",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "start_calc"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "EXCEL",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "e1037d8b-0e5f-46c3-a008-ad16d97689c2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_excel"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "PDF",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6fff52ee-58d7-4073-b42d-cb15298d5788",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_pdf"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "HELP",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "fdf49046-6eaf-4183-8ff8-209eff4fefc4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_help"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "DETAILS",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6b143832-1fbb-40ee-9465-ff85f59b0328",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "view_details"
                  }
                ]
              },
              "renameOutput": true
            },
            {
              "outputKey": "ANALYZE_TEXT",
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "244cd331-efdc-4e0e-b267-f51d8a6c6f3d",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze_text"
                  }
                ]
              },
              "renameOutput": true
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "typeVersion": 3.2
    },
    {
      "id": "9ed6eb3e-b254-466f-8ff1-c3f015caae2d",
      "name": "Config",
      "type": "n8n-nodes-base.code",
      "position": [
        -4832,
        -1568
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// CONFIG v8.5 PRO - Professional style localization + PDF SUPPORT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $input.first().json;\nconst lang = (input.lang || 'EN').toUpperCase();\nconst chatId = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nconst LANGS = {\n  'DE': { \n    fallback_start: 'DrÃ¼cken Sie /start um zu beginnen', \n    rooms: 'RÃ¤ume', works_identified: 'Positionen', general: 'Allgemein', no_works: 'Keine Arbeiten', items: 'Positionen', min: 'Min', \n    db: 'DE_BERLIN_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'German', flag: 'ðŸ‡©ðŸ‡ª', native: 'Deutsch', cur: 'EUR', sym: 'â‚¬', loc: 'de-DE', region: 'Berlin', search_lang: 'German',\n    // Professional welcome with PDF support\n    ok: 'âœ… *Deutsch* Â· Berlin Â· EUR',\n    text_prompt: `*Beschreiben Sie die Arbeiten:*\\n\\n_Beispiel:_\\n\\`\\`\\`\\nGipskarton 2-lagig 25m2\\nFliesen Bad 15m2\\nMalerarbeiten 120m2\\n\\`\\`\\``,\n    photo: `*Foto, PDF oder Beschreibung senden*\n\nðŸ“„ *PDF-Zeichnungen* â€” Grundriss oder Bauplan (max. 3 Seiten)\nðŸ“· *Foto* â€” Raum oder Objekt fotografieren\nâœï¸ *Text* â€” Arbeiten als Liste beschreiben\n\n_Beispiel zum Kopieren:_\n\\`\\`\\`\nGipskarton 2-lagig Metallprofil CW75 25m2\nFliesen Feinsteinzeug 60x60 Bad 15m2\nSpachteln Q3 Decken und Waende 120m2\nElektro Steckdosen UP 20 Stueck\n\\`\\`\\`\n\nOder Foto/PDF senden ðŸ“·ðŸ“„`,\n    // PDF specific\n    pdf_received: 'ðŸ“„ *PDF erhalten*',\n    pdf_processing: 'â³ Analysiere Zeichnung...',\n    pdf_pages: 'Seiten',\n    pdf_page_limit: 'âš ï¸ Nur erste 3 Seiten werden verarbeitet',\n    pdf_rooms_found: 'ðŸ  RÃ¤ume gefunden',\n    pdf_elements_found: 'ðŸ§± Elemente gefunden',\n    pdf_works_generated: 'ðŸ“ Arbeiten generiert',\n    pdf_analyzing_page: 'ðŸ” Analysiere Seite',\n    pdf_of: 'von',\n    pdf_complete: 'âœ… Analyse abgeschlossen',\n    pdf_error: 'âŒ PDF-Verarbeitungsfehler',\n    // Rest of translations\n    photo_added: 'âœ… Foto hinzugefÃ¼gt',\n    photos_count: 'Fotos',\n    add_more: '+ Weitere Fotos',\n    analyze_now: 'â–¶ Analyse starten',\n    analyzing: 'Bildanalyse lÃ¤uft...',\n    found: '*Erkannte Leistungen:*',\n    edit_hint: 'Zur Bearbeitung antippen',\n    calc: 'Preisermittlung',\n    ready: '*KOSTENVORANSCHLAG*',\n    total: 'GESAMT',\n    days: 'Tage',\n    pct: 'Trefferquote',\n    workers: 'Lohn',\n    machines: 'GerÃ¤te',\n    materials: 'Material',\n    subtotal: 'Zusammenfassung',\n    searching: 'Suche',\n    of: 'von',\n    not_found: 'Keine Ãœbereinstimmung',\n    low_conf: 'PrÃ¼fung empfohlen',\n    price_note: 'Preisbasis: Berlin 2025',\n    btn_calc: 'â–¶ Berechnen',\n    btn_new: '+ Neues Projekt',\n    btn_lang: 'âš™ Sprache',\n    btn_edit: 'âœŽ Ã„ndern',\n    btn_delete: 'âœ• Entfernen',\n    btn_add_work: '+ Position',\n    btn_done: 'âœ… Fertig',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Neu starten',\n    btn_help: '? Hilfe',\n    loading: 'Preisermittlung lÃ¤uft...',\n    more_in_html: 'Detaillierter Bericht verfÃ¼gbar',\n    resources: 'Details: Ressourcen & Leistungsumfang',\n    enter_work: '*Neue Position hinzufÃ¼gen*\\nFormat: Bezeichnung, Menge Einheit\\nBeispiel: Gipskartonwand, 15 mÂ²',\n    work_added: 'âœ… Position hinzugefÃ¼gt',\n    what_next: '*Weitere Optionen:*',\n    categories: 'Kategorien',\n    cat_demolition: 'Abbruch',\n    cat_rough: 'Rohbau',\n    cat_finishing: 'Ausbau',\n    cat_mep: 'TGA',\n    help_title: '*Benutzerhandbuch*',\n    help_text: `*Benutzerhandbuch*\n\n*1. Dokumentation*\nSenden Sie Fotos, PDF-PlÃ¤ne oder Beschreibung.\nPDF: max. 3 Seiten werden analysiert.\n\n*2. PrÃ¼fung*\nÃœberprÃ¼fen Sie die erkannten Leistungen.\n\n*3. Kalkulation*\nPreisermittlung aus DDC CWICR Datenbank.\n\n*4. Export*\nErgebnisse als Excel oder PDF.\n\n*Befehle:*\n/start â€” Neues Projekt\n/help â€” Diese Hilfe`,\n    doc_title: 'KOSTENVORANSCHLAG',\n    col_pos: 'Pos', col_code: 'Kennziffer', col_desc: 'Bezeichnung', col_unit: 'Einh.', col_qty: 'Menge', col_price: 'EP', col_total: 'GP', col_labor: 'Std', col_quality: 'Q',\n    grand_total: 'GESAMTSUMME', labor_cost: 'Lohnkosten', material_cost: 'Materialkosten', labor_days: 'Arbeitstage',\n    kpi_total: 'Gesamtkosten', kpi_hours: 'Arbeitsstunden', kpi_days: 'Arbeitstage',\n    chart_cost_structure: 'Kostenstruktur', chart_labor: 'Lohn', chart_material: 'Material', chart_machines: 'GerÃ¤te',\n    res_labor: 'Lohn', res_material: 'Mat', res_machine: 'Ger',\n    collapse_all: 'Alle einklappen', expand_all: 'Alle ausklappen',\n    quality_high: 'Hohe Ãœbereinstimmung', quality_medium: 'Mittlere Ãœbereinstimmung', quality_low: 'Geringe Ãœbereinstimmung',\n    export_excel_msg: 'Excel-Export (CSV)', export_pdf_msg: 'PDF-Export', btn_refine: 'Genauer analysieren', found_pct: 'gefunden', more_resources: 'weitere', kpi_items: 'Positionen', scope_title: 'Leistungsumfang', show_scope: 'Leistungen anzeigen'\n  },\n\n  'EN': { \n    fallback_start: 'Use /start to begin', \n    rooms: 'ÐºÐ¾Ð¼Ð½Ð°Ñ‚', works_identified: 'works', general: 'ÐžÐ±Ñ‰ÐµÐµ', no_works: 'Ð Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹', items: 'Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹', min: 'Ð¼Ð¸Ð½', \n    db: 'ENG_TORONTO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'English', flag: 'ðŸ‡¬ðŸ‡§', native: 'English', cur: 'CAD', sym: '$', loc: 'en-CA', region: 'Toronto', search_lang: 'English',\n    ok: 'âœ… *English* Â· Toronto Â· CAD',\n    text_prompt: `*Describe the works:*\\n\\n_Example:_\\n\\`\\`\\`\\nDrywall 2-layer 25m2\\nFloor tiles bathroom 15m2\\nPainting walls 120m2\\n\\`\\`\\``,\n    photo: `*Send photo, PDF or description*\n\nðŸ“„ *PDF drawings* â€” floor plan or blueprint (max 3 pages)\nðŸ“· *Photo* â€” photograph room or object\nâœï¸ *Text* â€” describe work as a list\n\n_Example to copy:_\n\\`\\`\\`\nDrywall 2-layer metal stud CW75 25m2\nPorcelain tiles 60x60 bathroom 15m2\nPlastering level 3 ceiling walls 120m2\nElectrical outlets flush mount 20 pcs\n\\`\\`\\`\n\nOr send photo/PDF ðŸ“·ðŸ“„`,\n    // PDF specific\n    pdf_received: 'ðŸ“„ *PDF received*',\n    pdf_processing: 'â³ Analyzing drawing...',\n    pdf_pages: 'pages',\n    pdf_page_limit: 'âš ï¸ Processing first 3 pages only',\n    pdf_rooms_found: 'ðŸ  Rooms found',\n    pdf_elements_found: 'ðŸ§± Elements found',\n    pdf_works_generated: 'ðŸ“ Works generated',\n    pdf_analyzing_page: 'ðŸ” Analyzing page',\n    pdf_of: 'of',\n    pdf_complete: 'âœ… Analysis complete',\n    pdf_error: 'âŒ PDF processing error',\n    // Rest\n    photo_added: 'âœ… Photo added',\n    photos_count: 'photos',\n    add_more: '+ Add more',\n    analyze_now: 'â–¶ Start analysis',\n    analyzing: 'Analyzing images...',\n    found: '*Identified Work Items:*',\n    edit_hint: 'Tap to edit',\n    calc: 'Pricing lookup',\n    ready: '*COST ESTIMATE*',\n    total: 'TOTAL',\n    days: 'days',\n    pct: 'Match rate',\n    workers: 'Labor',\n    machines: 'Equipment',\n    materials: 'Materials',\n    subtotal: 'Summary',\n    searching: 'Searching',\n    of: 'of',\n    not_found: 'No match found',\n    low_conf: 'Review recommended',\n    price_note: 'Price basis: Toronto 2025',\n    btn_calc: 'â–¶ Calculate',\n    btn_new: '+ New Project',\n    btn_lang: 'âš™ Language',\n    btn_edit: 'âœŽ Edit',\n    btn_delete: 'âœ• Remove',\n    btn_add_work: '+ Add Item',\n    btn_done: 'âœ… Done',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Start Over',\n    btn_help: '? Help',\n    loading: 'Calculating prices...',\n    more_in_html: 'Detailed report available',\n    resources: 'Details: Resources & Scope of Work',\n    enter_work: '*Add New Item*\\nFormat: Description, Quantity Unit\\nExample: Drywall installation, 15 mÂ²',\n    work_added: 'âœ… Item added',\n    what_next: '*Options:*',\n    categories: 'Categories',\n    cat_demolition: 'Demolition',\n    cat_rough: 'Structure',\n    cat_finishing: 'Finishes',\n    cat_mep: 'MEP',\n    help_title: '*User Guide*',\n    help_text: `*User Guide*\n\n*1. Documentation*\nSend photos, PDF plans or description.\nPDF: max 3 pages will be analyzed.\n\n*2. Review*\nCheck identified work items.\n\n*3. Ð Ð°ÑÑ‡Ñ‘Ñ‚*\nPricing from DDC CWICR database.\n\n*4. Export*\nExport as Excel or PDF.\n\n*Commands:*\n/start â€” New project\n/help â€” This guide`,\n    doc_title: 'COST ESTIMATE',\n    col_pos: 'No', col_code: 'Code', col_desc: 'Description', col_unit: 'Unit', col_qty: 'Qty', col_price: 'Rate', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'GRAND TOTAL', labor_cost: 'Labor Cost', material_cost: 'Material Cost', labor_days: 'Work Days',\n    kpi_total: 'Total Cost', kpi_hours: 'Work Hours', kpi_days: 'Work Days',\n    chart_cost_structure: 'Cost Structure', chart_labor: 'Labor', chart_material: 'Material', chart_machines: 'Equipment',\n    res_labor: 'Labor', res_material: 'Mat', res_machine: 'Equip',\n    collapse_all: 'Collapse all', expand_all: 'Expand all',\n    quality_high: 'High confidence', quality_medium: 'Medium confidence', quality_low: 'Low confidence',\n    export_excel_msg: 'Excel Export (CSV)', export_pdf_msg: 'PDF Export', btn_refine: 'Refine Analysis', found_pct: 'found', more_resources: 'more', kpi_items: 'Items', scope_title: 'Scope of Work', show_scope: 'Show scope'\n  },\n\n  'RU': { \n    fallback_start: 'ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ /start Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°', \n    rooms: 'ÐºÐ¾Ð¼Ð½Ð°Ñ‚', works_identified: 'Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹', general: 'ÐžÐ±Ñ‰ÐµÐµ', no_works: 'Ð Ð°Ð±Ð¾Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹', items: 'Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹', min: 'Ð¼Ð¸Ð½', \n    db: 'RU_STPETERSBURG_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Russian', flag: 'ðŸ‡·ðŸ‡º', native: 'Ð ÑƒÑÑÐºÐ¸Ð¹', cur: 'RUB', sym: 'â‚½', loc: 'ru-RU', region: 'Ð¡Ð°Ð½ÐºÑ‚-ÐŸÐµÑ‚ÐµÑ€Ð±ÑƒÑ€Ð³', search_lang: 'Russian',\n    ok: 'âœ… *Ð ÑƒÑÑÐºÐ¸Ð¹* Â· Ð¡ÐŸÐ± Â· RUB',\n    text_prompt: `*ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:*\\n\\n_ÐŸÑ€Ð¸Ð¼ÐµÑ€:_\\n\\`\\`\\`\\nÐ“Ð¸Ð¿ÑÐ¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½ 2 ÑÐ»Ð¾Ñ 25Ð¼2\\nÐŸÐ»Ð¸Ñ‚ÐºÐ° Ð²Ð°Ð½Ð½Ð°Ñ 15Ð¼2\\nÐŸÐ¾ÐºÑ€Ð°ÑÐºÐ° ÑÑ‚ÐµÐ½ 120Ð¼2\\n\\`\\`\\``,\n    photo: `*ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾, PDF Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ*\n\nðŸ“„ *PDF Ñ‡ÐµÑ€Ñ‚ÐµÐ¶Ð¸* â€” Ð¿Ð»Ð°Ð½ ÑÑ‚Ð°Ð¶Ð° Ð¸Ð»Ð¸ Ñ‡ÐµÑ€Ñ‚Ñ‘Ð¶ (Ð´Ð¾ 3 ÑÑ‚Ñ€.)\nðŸ“· *Ð¤Ð¾Ñ‚Ð¾* â€” ÑÑ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ\nâœï¸ *Ð¢ÐµÐºÑÑ‚* â€” Ð¾Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼\n\n_ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð´Ð»Ñ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:_\n\\`\\`\\`\nÐ“Ð¸Ð¿ÑÐ¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½ 2 ÑÐ»Ð¾Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ ÐŸÐŸ60 25Ð¼2\nÐŸÐ»Ð¸Ñ‚ÐºÐ° ÐºÐµÑ€Ð°Ð¼Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‚ 60x60 Ð²Ð°Ð½Ð½Ð°Ñ 15Ð¼2\nÐ¨Ð¿Ð°ÐºÐ»ÐµÐ²ÐºÐ° Ð¿Ð¾Ð´ Ð¿Ð¾ÐºÑ€Ð°ÑÐºÑƒ Ð¿Ð¾Ñ‚Ð¾Ð»ÐºÐ¸ ÑÑ‚ÐµÐ½Ñ‹ 120Ð¼2\nÐ Ð¾Ð·ÐµÑ‚ÐºÐ¸ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ Ð¼Ð¾Ð½Ñ‚Ð°Ð¶ 20ÑˆÑ‚\n\\`\\`\\`\n\nÐ˜Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾/PDF ðŸ“·ðŸ“„`,\n    // PDF specific\n    pdf_received: 'ðŸ“„ *PDF Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½*',\n    pdf_processing: 'ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽ Ñ‡ÐµÑ€Ñ‚Ñ‘Ð¶...',\n    pdf_pages: 'ÑÑ‚Ñ€.',\n    pdf_page_limit: 'âš ï¸ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 3 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹',\n    pdf_rooms_found: 'ðŸ  ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ð¾Ð¼ÐµÑ‰ÐµÐ½Ð¸Ð¹',\n    pdf_elements_found: 'ðŸ§± ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²',\n    pdf_works_generated: 'ðŸ“ Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚',\n    pdf_analyzing_page: 'ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ',\n    pdf_of: 'Ð¸Ð·',\n    pdf_complete: 'âœ… ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½',\n    pdf_error: 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ PDF',\n    // Rest\n    photo_added: 'âœ… Ð¤Ð¾Ñ‚Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾',\n    photos_count: 'Ñ„Ð¾Ñ‚Ð¾',\n    add_more: '+ Ð•Ñ‰Ñ‘ Ñ„Ð¾Ñ‚Ð¾',\n    analyze_now: 'â–¶ ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð°Ð½Ð°Ð»Ð¸Ð·',\n    analyzing: 'ÐÐ½Ð°Ð»Ð¸Ð· Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹...',\n    found: '*ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ñ‹Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:*',\n    edit_hint: 'ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ',\n    calc: 'ÐŸÐ¾Ð¸ÑÐº Ñ€Ð°ÑÑ†ÐµÐ½Ð¾Ðº',\n    ready: '*Ð¡ÐœÐ•Ð¢Ð*',\n    total: 'Ð˜Ð¢ÐžÐ“Ðž',\n    days: 'Ð´Ð½.',\n    pct: 'Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ',\n    workers: 'Ð¢Ñ€ÑƒÐ´',\n    machines: 'ÐœÐµÑ…Ð°Ð½Ð¸Ð·Ð¼Ñ‹',\n    materials: 'ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹',\n    subtotal: 'Ð¡Ð²Ð¾Ð´ÐºÐ°',\n    searching: 'ÐŸÐ¾Ð¸ÑÐº',\n    of: 'Ð¸Ð·',\n    not_found: 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾',\n    low_conf: 'Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸',\n    price_note: 'Ð‘Ð°Ð·Ð° Ñ†ÐµÐ½: Ð¡Ð°Ð½ÐºÑ‚-ÐŸÐµÑ‚ÐµÑ€Ð±ÑƒÑ€Ð³ 2025',\n    btn_calc: 'â–¶ Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ',\n    btn_new: '+ ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚',\n    btn_lang: 'âš™ Ð¯Ð·Ñ‹Ðº',\n    btn_edit: 'âœŽ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ',\n    btn_delete: 'âœ• Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ',\n    btn_add_work: '+ ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ',\n    btn_done: 'âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Ð—Ð°Ð½Ð¾Ð²Ð¾',\n    btn_help: '? Ð¡Ð¿Ñ€Ð°Ð²ÐºÐ°',\n    loading: 'Ð Ð°ÑÑ‡Ñ‘Ñ‚...',\n    more_in_html: 'ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½',\n    resources: 'ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ: Ñ€ÐµÑÑƒÑ€ÑÑ‹ Ð¸ ÑÐ¾ÑÑ‚Ð°Ð²Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚',\n    enter_work: '*Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ*\\nÐ¤Ð¾Ñ€Ð¼Ð°Ñ‚: ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ, ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð°\\nÐŸÑ€Ð¸Ð¼ÐµÑ€: ÐœÐ¾Ð½Ñ‚Ð°Ð¶ Ð“ÐšÐ›, 15 Ð¼Â²',\n    work_added: 'âœ… ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°',\n    what_next: '*Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:*',\n    categories: 'ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸',\n    cat_demolition: 'Ð”ÐµÐ¼Ð¾Ð½Ñ‚Ð°Ð¶',\n    cat_rough: 'Ð§ÐµÑ€Ð½Ð¾Ð²Ñ‹Ðµ',\n    cat_finishing: 'ÐžÑ‚Ð´ÐµÐ»ÐºÐ°',\n    cat_mep: 'Ð˜Ð½Ð¶ÐµÐ½ÐµÑ€Ð¸Ñ',\n    help_title: '*Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾*',\n    help_text: `*Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ*\n\n*1. Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ*\nÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾, PDF-Ð¿Ð»Ð°Ð½ Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ.\nPDF: Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð´Ð¾ 3 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†.\n\n*2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°*\nÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ñ‹Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹.\n\n*3. Ð Ð°ÑÑ‡Ñ‘Ñ‚*\nÐ¦ÐµÐ½Ñ‹ Ð¸Ð· Ð±Ð°Ð·Ñ‹ DDC CWICR.\n\n*4. Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚*\nÐ’Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ° Ð² Excel Ð¸Ð»Ð¸ PDF.\n\n*ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:*\n/start â€” ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚\n/help â€” Ð¡Ð¿Ñ€Ð°Ð²ÐºÐ°`,\n    doc_title: 'Ð¡ÐœÐ•Ð¢Ð',\n    col_pos: 'â„–', col_code: 'Ð¨Ð¸Ñ„Ñ€', col_desc: 'ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ', col_unit: 'Ð•Ð´.', col_qty: 'ÐšÐ¾Ð».', col_price: 'Ð¦ÐµÐ½Ð°', col_total: 'Ð¡ÑƒÐ¼Ð¼Ð°', col_labor: 'Ð§/Ñ‡', col_quality: 'Ðš',\n    grand_total: 'Ð’Ð¡Ð•Ð“Ðž', labor_cost: 'Ð¤ÐžÐ¢', material_cost: 'ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹', labor_days: 'Ð”Ð½ÐµÐ¹',\n    kpi_total: 'Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ', kpi_hours: 'Ð¢Ñ€ÑƒÐ´Ð¾Ð·Ð°Ñ‚Ñ€Ð°Ñ‚Ñ‹', kpi_days: 'Ð¡Ñ€Ð¾Ðº',\n    chart_cost_structure: 'Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð·Ð°Ñ‚Ñ€Ð°Ñ‚', chart_labor: 'Ð¢Ñ€ÑƒÐ´', chart_material: 'ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹', chart_machines: 'ÐœÐµÑ…Ð°Ð½Ð¸Ð·Ð¼Ñ‹',\n    res_labor: 'Ð¢Ñ€ÑƒÐ´', res_material: 'ÐœÐ°Ñ‚', res_machine: 'ÐœÐµÑ…',\n    collapse_all: 'Ð¡Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ', expand_all: 'Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ',\n    quality_high: 'Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ', quality_medium: 'Ð¡Ñ€ÐµÐ´Ð½ÑÑ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ', quality_low: 'ÐÐ¸Ð·ÐºÐ°Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ',\n    export_excel_msg: 'Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Excel (CSV)', export_pdf_msg: 'Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ PDF', btn_refine: 'Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ð°Ð½Ð°Ð»Ð¸Ð·', found_pct: 'Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾', more_resources: 'ÐµÑ‰Ñ‘', kpi_items: 'ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ð¸', scope_title: 'Ð¡Ð¾ÑÑ‚Ð°Ð² Ñ€Ð°Ð±Ð¾Ñ‚', show_scope: 'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð²'\n  },\n\n  'ES': { \n    fallback_start: 'Pulse /start para comenzar', \n    rooms: 'habitaciones', works_identified: 'trabajos', general: 'ÐžÐ±Ñ‰ÐµÐµ', no_works: 'Sin trabajos', items: 'elementos', min: 'Ð¼Ð¸Ð½', \n    db: 'ES_BARCELONA_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸', native: 'EspaÃ±ol', cur: 'EUR', sym: 'â‚¬', loc: 'es-ES', region: 'Barcelona', search_lang: 'Spanish',\n    ok: 'âœ… *EspaÃ±ol* Â· Barcelona Â· EUR',\n    text_prompt: `*Describa los trabajos:*\\n\\n_Ejemplo:_\\n\\`\\`\\`\\nPladur 2 capas 25m2\\nAzulejos baÃ±o 15m2\\nPintura paredes 120m2\\n\\`\\`\\``,\n    photo: `*EnvÃ­e foto, PDF o descripciÃ³n*\n\nðŸ“„ *Planos PDF* â€” plano de planta o dibujo (mÃ¡x. 3 pÃ¡gs.)\nðŸ“· *Foto* â€” fotografÃ­e el espacio\nâœï¸ *Texto* â€” describa trabajos en lista\n\n_Ejemplo para copiar:_\n\\`\\`\\`\nPladur 2 capas perfil metÃ¡lico 25m2\nAzulejos porcelÃ¡nico 60x60 baÃ±o 15m2\nAlisado para pintura techos paredes 120m2\nEnchufes empotrados 20uds\n\\`\\`\\`\n\nO envÃ­e foto/PDF ðŸ“·ðŸ“„`,\n    pdf_received: 'ðŸ“„ *PDF recibido*',\n    pdf_processing: 'â³ Analizando plano...',\n    pdf_pages: 'pÃ¡ginas',\n    pdf_page_limit: 'âš ï¸ Solo se procesan las primeras 3 pÃ¡ginas',\n    pdf_rooms_found: 'ðŸ  Habitaciones encontradas',\n    pdf_elements_found: 'ðŸ§± Elementos encontrados',\n    pdf_works_generated: 'ðŸ“ Trabajos generados',\n    pdf_analyzing_page: 'ðŸ” Analizando pÃ¡gina',\n    pdf_of: 'de',\n    pdf_complete: 'âœ… AnÃ¡lisis completado',\n    pdf_error: 'âŒ Error al procesar PDF',\n    photo_added: 'âœ… Foto aÃ±adida',\n    photos_count: 'fotos',\n    add_more: '+ MÃ¡s fotos',\n    analyze_now: 'â–¶ Analizar',\n    analyzing: 'Analizando...',\n    found: '*Trabajos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'BÃºsqueda de precios',\n    ready: '*PRESUPUESTO*',\n    total: 'TOTAL',\n    days: 'dÃ­as',\n    pct: 'PrecisiÃ³n',\n    workers: 'M.O.',\n    machines: 'Equipos',\n    materials: 'Materiales',\n    subtotal: 'Resumen',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'Sin coincidencia',\n    low_conf: 'Revisar',\n    price_note: 'Base: Barcelona 2025',\n    btn_calc: 'â–¶ Calcular',\n    btn_new: '+ Nuevo',\n    btn_lang: 'âš™ Idioma',\n    btn_edit: 'âœŽ Editar',\n    btn_delete: 'âœ• Eliminar',\n    btn_add_work: '+ Partida',\n    btn_done: 'âœ… Listo',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Reiniciar',\n    btn_help: '? Ayuda',\n    loading: 'Calculando...',\n    more_in_html: 'Informe detallado disponible',\n    resources: 'Detalles: recursos y alcance',\n    enter_work: '*AÃ±adir partida*\\nFormato: DescripciÃ³n, Cantidad Unidad',\n    work_added: 'âœ… AÃ±adido',\n    what_next: '*Opciones:*',\n    categories: 'CategorÃ­as',\n    cat_demolition: 'DemoliciÃ³n',\n    cat_rough: 'Estructura',\n    cat_finishing: 'Acabados',\n    cat_mep: 'Instalaciones',\n    help_title: '*GuÃ­a*',\n    help_text: `*GuÃ­a de uso*\n\n*1.* EnvÃ­e fotos, PDF o descripciÃ³n\nPDF: mÃ¡x. 3 pÃ¡ginas\n*2.* Revise los trabajos\n*3.* Calcule precios\n*4.* Exporte\n\n/start â€” Nuevo\n/help â€” Ayuda`,\n    doc_title: 'PRESUPUESTO',\n    col_pos: 'NÂº', col_code: 'CÃ³digo', col_desc: 'DescripciÃ³n', col_unit: 'Ud', col_qty: 'Cant', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiales', labor_days: 'DÃ­as',\n    kpi_total: 'Coste Total', kpi_hours: 'Horas', kpi_days: 'DÃ­as',\n    chart_cost_structure: 'Estructura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Contraer', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'Media', quality_low: 'Baja',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'mÃ¡s', kpi_items: 'ArtÃ­culos', scope_title: 'Alcance', show_scope: 'Ver alcance'\n  },\n\n  'FR': { \n    fallback_start: 'Appuyez sur /start pour commencer', \n    rooms: 'piÃ¨ces', works_identified: 'travaux', general: 'GÃ©nÃ©ral', no_works: 'Aucun travail', items: 'Ã©lÃ©ments', min: 'Ð¼Ð¸Ð½', \n    db: 'FR_PARIS_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'French', flag: 'ðŸ‡«ðŸ‡·', native: 'FranÃ§ais', cur: 'EUR', sym: 'â‚¬', loc: 'fr-FR', region: 'Paris', search_lang: 'French',\n    ok: 'âœ… *FranÃ§ais* Â· Paris Â· EUR',\n    text_prompt: `*DÃ©crivez les travaux:*\\n\\n_Exemple:_\\n\\`\\`\\`\\nPlaco 2 couches 25m2\\nCarrelage sdb 15m2\\nPeinture murs 120m2\\n\\`\\`\\``,\n    photo: `*Envoyez photo, PDF ou description*\n\nðŸ“„ *Plans PDF* â€” plan d'Ã©tage ou dessin (max 3 pages)\nðŸ“· *Photo* â€” photographiez l'espace\nâœï¸ *Texte* â€” dÃ©crivez les travaux en liste\n\n_Exemple Ã  copier:_\n\\`\\`\\`\nPlaco 2 couches ossature mÃ©tallique 25m2\nCarrelage grÃ¨s cÃ©rame 60x60 sdb 15m2\nEnduit plafonds murs 120m2\nPrises encastrÃ©es 20pcs\n\\`\\`\\`\n\nOu envoyez photo/PDF ðŸ“·ðŸ“„`,\n    pdf_received: 'ðŸ“„ *PDF reÃ§u*',\n    pdf_processing: 'â³ Analyse du plan...',\n    pdf_pages: 'pages',\n    pdf_page_limit: 'âš ï¸ Seules les 3 premiÃ¨res pages sont traitÃ©es',\n    pdf_rooms_found: 'ðŸ  PiÃ¨ces trouvÃ©es',\n    pdf_elements_found: 'ðŸ§± Ã‰lÃ©ments trouvÃ©s',\n    pdf_works_generated: 'ðŸ“ Travaux gÃ©nÃ©rÃ©s',\n    pdf_analyzing_page: 'ðŸ” Analyse de la page',\n    pdf_of: 'sur',\n    pdf_complete: 'âœ… Analyse terminÃ©e',\n    pdf_error: 'âŒ Erreur de traitement PDF',\n    photo_added: 'âœ… Photo ajoutÃ©e',\n    photos_count: 'photos',\n    add_more: '+ Autres photos',\n    analyze_now: 'â–¶ Analyser',\n    analyzing: 'Analyse en cours...',\n    found: '*Ouvrages identifiÃ©s:*',\n    edit_hint: 'Appuyez pour modifier',\n    calc: 'Recherche des prix',\n    ready: '*DEVIS*',\n    total: 'TOTAL',\n    days: 'jours',\n    pct: 'PrÃ©cision',\n    workers: 'M.O.',\n    machines: 'MatÃ©riel',\n    materials: 'MatÃ©riaux',\n    subtotal: 'RÃ©sumÃ©',\n    searching: 'Recherche',\n    of: 'sur',\n    not_found: 'Non trouvÃ©',\n    low_conf: 'Ã€ vÃ©rifier',\n    price_note: 'Base: Paris 2025',\n    btn_calc: 'â–¶ Calculer',\n    btn_new: '+ Nouveau',\n    btn_lang: 'âš™ Langue',\n    btn_edit: 'âœŽ Modifier',\n    btn_delete: 'âœ• Supprimer',\n    btn_add_work: '+ Ouvrage',\n    btn_done: 'âœ… TerminÃ©',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Recommencer',\n    btn_help: '? Aide',\n    loading: 'Calcul en cours...',\n    more_in_html: 'Rapport dÃ©taillÃ© disponible',\n    resources: 'DÃ©tails: ressources et description',\n    enter_work: '*Ajouter ouvrage*\\nFormat: Description, QuantitÃ© UnitÃ©',\n    work_added: 'âœ… AjoutÃ©',\n    what_next: '*Options:*',\n    categories: 'CatÃ©gories',\n    cat_demolition: 'DÃ©molition',\n    cat_rough: 'Gros Å“uvre',\n    cat_finishing: 'Finitions',\n    cat_mep: 'CVC',\n    help_title: '*Guide*',\n    help_text: `*Guide d'utilisation*\n\n*1.* Envoyez photos, PDF ou description\nPDF: max 3 pages\n*2.* VÃ©rifiez les ouvrages\n*3.* Calculez les prix\n*4.* Exportez\n\n/start â€” Nouveau\n/help â€” Aide`,\n    doc_title: 'DEVIS',\n    col_pos: 'NÂ°', col_code: 'Code', col_desc: 'DÃ©signation', col_unit: 'U', col_qty: 'QtÃ©', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'MatÃ©riaux', labor_days: 'Jours',\n    kpi_total: 'CoÃ»t Total', kpi_hours: 'Heures', kpi_days: 'Jours',\n    chart_cost_structure: 'Structure', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Ã‰q',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Ã‰q',\n    collapse_all: 'RÃ©duire', expand_all: 'DÃ©velopper',\n    quality_high: 'Haute', quality_medium: 'Moyenne', quality_low: 'Faible',\n    export_excel_msg: 'Export Excel', export_pdf_msg: 'Export PDF', btn_refine: 'Affiner', found_pct: 'trouvÃ©', more_resources: 'plus', kpi_items: 'Articles', scope_title: 'Description', show_scope: 'Voir description'\n  },\n\n  'PT': { \n    fallback_start: 'Pressione /start para comeÃ§ar', \n    rooms: 'quartos', works_identified: 'trabalhos', general: 'Geral', no_works: 'Sem trabalhos', items: 'itens', min: 'Ð¼Ð¸Ð½', \n    db: 'PT_SAOPAULO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Portuguese', flag: 'ðŸ‡§ðŸ‡·', native: 'PortuguÃªs', cur: 'BRL', sym: 'R$', loc: 'pt-BR', region: 'SÃ£o Paulo', search_lang: 'Portuguese',\n    ok: 'âœ… *PortuguÃªs* Â· SÃ£o Paulo Â· BRL',\n    text_prompt: `*Descreva os trabalhos:*\\n\\n_Exemplo:_\\n\\`\\`\\`\\nDrywall 2 camadas 25m2\\nPorcelanato banheiro 15m2\\nPintura paredes 120m2\\n\\`\\`\\``,\n    photo: `*Envie foto, PDF ou descriÃ§Ã£o*\n\nðŸ“„ *Plantas PDF* â€” planta baixa ou desenho (mÃ¡x. 3 pÃ¡gs.)\nðŸ“· *Foto* â€” fotografe o ambiente\nâœï¸ *Texto* â€” descreva os trabalhos em lista\n\n_Exemplo para copiar:_\n\\`\\`\\`\nDrywall 2 camadas perfil metÃ¡lico 25m2\nPorcelanato 60x60 banheiro 15m2\nMassa corrida teto paredes 120m2\nTomadas embutidas 20un\n\\`\\`\\`\n\nOu envie foto/PDF ðŸ“·ðŸ“„`,\n    pdf_received: 'ðŸ“„ *PDF recebido*',\n    pdf_processing: 'â³ Analisando planta...',\n    pdf_pages: 'pÃ¡ginas',\n    pdf_page_limit: 'âš ï¸ Processando apenas as 3 primeiras pÃ¡ginas',\n    pdf_rooms_found: 'ðŸ  CÃ´modos encontrados',\n    pdf_elements_found: 'ðŸ§± Elementos encontrados',\n    pdf_works_generated: 'ðŸ“ Trabalhos gerados',\n    pdf_analyzing_page: 'ðŸ” Analisando pÃ¡gina',\n    pdf_of: 'de',\n    pdf_complete: 'âœ… AnÃ¡lise concluÃ­da',\n    pdf_error: 'âŒ Erro ao processar PDF',\n    photo_added: 'âœ… Foto adicionada',\n    photos_count: 'fotos',\n    add_more: '+ Mais fotos',\n    analyze_now: 'â–¶ Analisar',\n    analyzing: 'Analisando...',\n    found: '*ServiÃ§os identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'Busca de preÃ§os',\n    ready: '*ORÃ‡AMENTO*',\n    total: 'TOTAL',\n    days: 'dias',\n    pct: 'PrecisÃ£o',\n    workers: 'M.O.',\n    machines: 'Equipamentos',\n    materials: 'Materiais',\n    subtotal: 'Resumo',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'NÃ£o encontrado',\n    low_conf: 'Verificar',\n    price_note: 'Base: SÃ£o Paulo 2025',\n    btn_calc: 'â–¶ Calcular',\n    btn_new: '+ Novo',\n    btn_lang: 'âš™ Idioma',\n    btn_edit: 'âœŽ Editar',\n    btn_delete: 'âœ• Excluir',\n    btn_add_work: '+ ServiÃ§o',\n    btn_done: 'âœ… Pronto',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» RecomeÃ§ar',\n    btn_help: '? Ajuda',\n    loading: 'Calculando...',\n    more_in_html: 'RelatÃ³rio detalhado disponÃ­vel',\n    resources: 'Detalhes: recursos e escopo',\n    enter_work: '*Adicionar serviÃ§o*\\nFormato: DescriÃ§Ã£o, Quantidade Unidade',\n    work_added: 'âœ… Adicionado',\n    what_next: '*OpÃ§Ãµes:*',\n    categories: 'Categorias',\n    cat_demolition: 'DemoliÃ§Ã£o',\n    cat_rough: 'Estrutura',\n    cat_finishing: 'Acabamento',\n    cat_mep: 'InstalaÃ§Ãµes',\n    help_title: '*Guia*',\n    help_text: `*Guia de uso*\n\n*1.* Envie fotos, PDF ou descriÃ§Ã£o\nPDF: mÃ¡x. 3 pÃ¡ginas\n*2.* Revise os serviÃ§os\n*3.* Calcule preÃ§os\n*4.* Exporte\n\n/start â€” Novo\n/help â€” Ajuda`,\n    doc_title: 'ORÃ‡AMENTO',\n    col_pos: 'NÂº', col_code: 'CÃ³digo', col_desc: 'DescriÃ§Ã£o', col_unit: 'Un', col_qty: 'Qtd', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiais', labor_days: 'Dias',\n    kpi_total: 'Custo Total', kpi_hours: 'Horas', kpi_days: 'Dias',\n    chart_cost_structure: 'Estrutura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Recolher', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'MÃ©dia', quality_low: 'Baixa',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'mais', kpi_items: 'Itens', scope_title: 'Escopo', show_scope: 'Ver escopo'\n  },\n\n  'ZH': { \n    db: 'ZH_SHANGHAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³', native: 'ä¸­æ–‡', cur: 'CNY', sym: 'Â¥', loc: 'zh-CN', region: 'ä¸Šæµ·', search_lang: 'Chinese',\n    ok: 'âœ… *ä¸­æ–‡* Â· ä¸Šæµ· Â· CNY',\n    text_prompt: `*æè¿°å·¥ä½œ:*\\n\\n_ç¤ºä¾‹:_\\n\\`\\`\\`\\nçŸ³è†æ¿åŒå±‚ 25m2\\nç“·ç –å«ç”Ÿé—´ 15m2\\nå¢™é¢æ¶‚æ–™ 120m2\\n\\`\\`\\``,\n    photo: `*å‘é€ç…§ç‰‡ã€PDFæˆ–æè¿°*\n\nðŸ“„ *PDFå›¾çº¸* â€” å¹³é¢å›¾æˆ–å›¾çº¸ï¼ˆæœ€å¤š3é¡µï¼‰\nðŸ“· *ç…§ç‰‡* â€” æ‹æ‘„æˆ¿é—´æˆ–ç‰©ä½“\nâœï¸ *æ–‡å­—* â€” ä»¥åˆ—è¡¨å½¢å¼æè¿°\n\n_å¤åˆ¶ç¤ºä¾‹ï¼š_\n\\`\\`\\`\nçŸ³è†æ¿åŒå±‚è½»é’¢é¾™éª¨ 25m2\nç“·ç –600x600å«ç”Ÿé—´ 15m2\nè…»å­æ‰¾å¹³é¡¶å¢™ 120m2\næš—è£…æ’åº§ 20ä¸ª\n\\`\\`\\`\n\næˆ–å‘é€ç…§ç‰‡/PDF ðŸ“·ðŸ“„`,\n    pdf_received: 'ðŸ“„ *å·²æ”¶åˆ°PDF*',\n    pdf_processing: 'â³ æ­£åœ¨åˆ†æžå›¾çº¸...',\n    pdf_pages: 'é¡µ',\n    pdf_page_limit: 'âš ï¸ ä»…å¤„ç†å‰3é¡µ',\n    pdf_rooms_found: 'ðŸ  å‘çŽ°æˆ¿é—´',\n    pdf_elements_found: 'ðŸ§± å‘çŽ°å…ƒç´ ',\n    pdf_works_generated: 'ðŸ“ å·²ç”Ÿæˆå·¥ä½œé¡¹',\n    pdf_analyzing_page: 'ðŸ” æ­£åœ¨åˆ†æžç¬¬',\n    pdf_of: 'é¡µï¼Œå…±',\n    pdf_complete: 'âœ… åˆ†æžå®Œæˆ',\n    pdf_error: 'âŒ PDFå¤„ç†é”™è¯¯',\n    photo_added: 'âœ… ç…§ç‰‡å·²æ·»åŠ ',\n    photos_count: 'å¼ ',\n    add_more: '+ æ›´å¤šç…§ç‰‡',\n    analyze_now: 'â–¶ å¼€å§‹åˆ†æž',\n    analyzing: 'åˆ†æžä¸­...',\n    found: '*è¯†åˆ«çš„å·¥ä½œé¡¹:*',\n    edit_hint: 'ç‚¹å‡»ç¼–è¾‘',\n    calc: 'ä»·æ ¼æŸ¥è¯¢',\n    ready: '*å·¥ç¨‹é¢„ç®—*',\n    total: 'åˆè®¡',\n    days: 'å¤©',\n    pct: 'åŒ¹é…çŽ‡',\n    workers: 'äººå·¥',\n    machines: 'æœºæ¢°',\n    materials: 'ææ–™',\n    subtotal: 'æ‘˜è¦',\n    searching: 'æœç´¢',\n    of: '/',\n    not_found: 'æœªæ‰¾åˆ°',\n    low_conf: 'éœ€æ ¸æŸ¥',\n    price_note: 'ä»·æ ¼åŸºå‡†ï¼šä¸Šæµ· 2025',\n    btn_calc: 'â–¶ è®¡ç®—',\n    btn_new: '+ æ–°é¡¹ç›®',\n    btn_lang: 'âš™ è¯­è¨€',\n    btn_edit: 'âœŽ ç¼–è¾‘',\n    btn_delete: 'âœ• åˆ é™¤',\n    btn_add_work: '+ æ·»åŠ ',\n    btn_done: 'âœ… å®Œæˆ',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» é‡æ–°å¼€å§‹',\n    btn_help: '? å¸®åŠ©',\n    loading: 'è®¡ç®—ä¸­...',\n    more_in_html: 'è¯¦ç»†æŠ¥å‘Šå¯ç”¨',\n    resources: 'è¯¦æƒ…ï¼šèµ„æºå’Œå·¥ä½œèŒƒå›´',\n    enter_work: '*æ·»åŠ é¡¹ç›®*\\næ ¼å¼ï¼šæè¿°ï¼Œæ•°é‡ å•ä½',\n    work_added: 'âœ… å·²æ·»åŠ ',\n    what_next: '*é€‰é¡¹:*',\n    categories: 'ç±»åˆ«',\n    cat_demolition: 'æ‹†é™¤',\n    cat_rough: 'ç»“æž„',\n    cat_finishing: 'è£…é¥°',\n    cat_mep: 'æœºç”µ',\n    help_title: '*æŒ‡å—*',\n    help_text: `*ä½¿ç”¨æŒ‡å—*\n\n*1.* å‘é€ç…§ç‰‡ã€PDFæˆ–æè¿°\nPDFï¼šæœ€å¤š3é¡µ\n*2.* æ£€æŸ¥å·¥ä½œé¡¹\n*3.* è®¡ç®—ä»·æ ¼\n*4.* å¯¼å‡º\n\n/start â€” æ–°é¡¹ç›®\n/help â€” å¸®åŠ©`,\n    doc_title: 'é¢„ç®—',\n    col_pos: 'åºå·', col_code: 'ç¼–ç ', col_desc: 'åç§°', col_unit: 'å•ä½', col_qty: 'æ•°é‡', col_price: 'å•ä»·', col_total: 'åˆè®¡', col_labor: 'å·¥æ—¶', col_quality: 'è´¨',\n    grand_total: 'æ€»è®¡', labor_cost: 'äººå·¥è´¹', material_cost: 'ææ–™è´¹', labor_days: 'å·¥æœŸ',\n    kpi_total: 'æ€»æˆæœ¬', kpi_hours: 'å·¥æ—¶', kpi_days: 'å·¥æœŸ',\n    chart_cost_structure: 'æˆæœ¬ç»“æž„', chart_labor: 'äººå·¥', chart_material: 'ææ–™', chart_machines: 'æœºæ¢°',\n    res_labor: 'äººå·¥', res_material: 'ææ–™', res_machine: 'æœºæ¢°',\n    collapse_all: 'æŠ˜å ', expand_all: 'å±•å¼€',\n    quality_high: 'é«˜', quality_medium: 'ä¸­', quality_low: 'ä½Ž',\n    export_excel_msg: 'å¯¼å‡ºExcel', export_pdf_msg: 'å¯¼å‡ºPDF', btn_refine: 'ç²¾ç¡®åˆ†æž', found_pct: 'æ‰¾åˆ°', more_resources: 'æ›´å¤š', kpi_items: 'é¡¹ç›®', scope_title: 'å·¥ä½œèŒƒå›´', show_scope: 'æŸ¥çœ‹èŒƒå›´'\n  },\n\n  'AR': { \n    db: 'AR_DUBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Arabic', flag: 'ðŸ‡¦ðŸ‡ª', native: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', cur: 'AED', sym: 'Ø¯.Ø¥', loc: 'ar-AE', region: 'Ø¯Ø¨ÙŠ', search_lang: 'Arabic',\n    ok: 'âœ… *Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©* Â· Ø¯Ø¨ÙŠ Â· AED',\n    text_prompt: `*ØµÙ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:*\\n\\n_Ù…Ø«Ø§Ù„:_\\n\\`\\`\\`\\nØ¬Ø¨Ø³ Ø¨ÙˆØ±Ø¯ Ø·Ø¨Ù‚ØªÙŠÙ† 25Ù…2\\nØ¨Ù„Ø§Ø· Ø­Ù…Ø§Ù… 15Ù…2\\nØ¯Ù‡Ø§Ù† Ø¬Ø¯Ø±Ø§Ù† 120Ù…2\\n\\`\\`\\``,\n    photo: `*Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ø£Ùˆ PDF Ø£Ùˆ ÙˆØµÙ*\n\nðŸ“„ *Ù…Ø®Ø·Ø·Ø§Øª PDF* â€” Ù…Ø®Ø·Ø· Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø£Ùˆ Ø§Ù„Ø±Ø³Ù… (Ø­ØªÙ‰ 3 ØµÙØ­Ø§Øª)\nðŸ“· *ØµÙˆØ±Ø©* â€” Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ù„Ù„Ù…ÙƒØ§Ù†\nâœï¸ *Ù†Øµ* â€” ØµÙ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙƒÙ‚Ø§Ø¦Ù…Ø©\n\n_Ù…Ø«Ø§Ù„ Ù„Ù„Ù†Ø³Ø®:_\n\\`\\`\\`\nØ¬Ø¨Ø³ Ø¨ÙˆØ±Ø¯ Ø·Ø¨Ù‚ØªÙŠÙ† Ù‡ÙŠÙƒÙ„ Ù…Ø¹Ø¯Ù†ÙŠ 25Ù…2\nØ¨Ù„Ø§Ø· Ø³ÙŠØ±Ø§Ù…ÙŠÙƒ 60x60 Ø­Ù…Ø§Ù… 15Ù…2\nÙ…Ø¹Ø¬ÙˆÙ† Ø£Ø³Ù‚Ù Ø¬Ø¯Ø±Ø§Ù† 120Ù…2\nÙ…Ù‚Ø§Ø¨Ø³ Ù…Ø®ÙÙŠØ© 20Ù‚Ø·Ø¹Ø©\n\\`\\`\\`\n\nØ£Ùˆ Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø©/PDF ðŸ“·ðŸ“„`,\n    pdf_received: 'ðŸ“„ *ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… PDF*',\n    pdf_processing: 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·...',\n    pdf_pages: 'ØµÙØ­Ø§Øª',\n    pdf_page_limit: 'âš ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆÙ„ 3 ØµÙØ­Ø§Øª ÙÙ‚Ø·',\n    pdf_rooms_found: 'ðŸ  Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©',\n    pdf_elements_found: 'ðŸ§± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©',\n    pdf_works_generated: 'ðŸ“ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©',\n    pdf_analyzing_page: 'ðŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©',\n    pdf_of: 'Ù…Ù†',\n    pdf_complete: 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„',\n    pdf_error: 'âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© PDF',\n    photo_added: 'âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©',\n    photos_count: 'ØµÙˆØ±',\n    add_more: '+ Ø§Ù„Ù…Ø²ÙŠØ¯',\n    analyze_now: 'â–¶ ØªØ­Ù„ÙŠÙ„',\n    analyzing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...',\n    found: '*Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:*',\n    edit_hint: 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ¹Ø¯ÙŠÙ„',\n    calc: 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±',\n    ready: '*Ø§Ù„ØªÙ‚Ø¯ÙŠØ±*',\n    total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',\n    days: 'ÙŠÙˆÙ…',\n    pct: 'Ø§Ù„Ø¯Ù‚Ø©',\n    workers: 'Ø¹Ù…Ø§Ù„Ø©',\n    machines: 'Ù…Ø¹Ø¯Ø§Øª',\n    materials: 'Ù…ÙˆØ§Ø¯',\n    subtotal: 'Ù…Ù„Ø®Øµ',\n    searching: 'Ø¨Ø­Ø«',\n    of: 'Ù…Ù†',\n    not_found: 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',\n    low_conf: 'Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',\n    price_note: 'Ø§Ù„Ø£Ø³Ø§Ø³: Ø¯Ø¨ÙŠ 2025',\n    btn_calc: 'â–¶ Ø­Ø³Ø§Ø¨',\n    btn_new: '+ Ø¬Ø¯ÙŠØ¯',\n    btn_lang: 'âš™ Ù„ØºØ©',\n    btn_edit: 'âœŽ ØªØ¹Ø¯ÙŠÙ„',\n    btn_delete: 'âœ• Ø­Ø°Ù',\n    btn_add_work: '+ Ø¥Ø¶Ø§ÙØ©',\n    btn_done: 'âœ… ØªÙ…',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯',\n    btn_help: '? Ù…Ø³Ø§Ø¹Ø¯Ø©',\n    loading: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...',\n    more_in_html: 'ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ù…ØªØ§Ø­',\n    resources: 'Ø§Ù„ØªÙØ§ØµÙŠÙ„: Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„',\n    enter_work: '*Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯*\\nØ§Ù„ØµÙŠØºØ©: Ø§Ù„ÙˆØµÙØŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø©',\n    work_added: 'âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©',\n    what_next: '*Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:*',\n    categories: 'Ø§Ù„ÙØ¦Ø§Øª',\n    cat_demolition: 'Ù‡Ø¯Ù…',\n    cat_rough: 'Ù‡ÙŠÙƒÙ„',\n    cat_finishing: 'ØªØ´Ø·ÙŠØ¨',\n    cat_mep: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ',\n    help_title: '*Ø¯Ù„ÙŠÙ„*',\n    help_text: `*Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…*\n\n*1.* Ø£Ø±Ø³Ù„ ØµÙˆØ± Ø£Ùˆ PDF Ø£Ùˆ ÙˆØµÙ\nPDF: Ø­ØªÙ‰ 3 ØµÙØ­Ø§Øª\n*2.* Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„\n*3.* Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±\n*4.* ØµØ¯Ù‘Ø±\n\n/start â€” Ø¬Ø¯ÙŠØ¯\n/help â€” Ù…Ø³Ø§Ø¹Ø¯Ø©`,\n    doc_title: 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±',\n    col_pos: 'Ø±Ù‚Ù…', col_code: 'Ø§Ù„Ø±Ù…Ø²', col_desc: 'Ø§Ù„ÙˆØµÙ', col_unit: 'ÙˆØ­Ø¯Ø©', col_qty: 'ÙƒÙ…ÙŠØ©', col_price: 'Ø³Ø¹Ø±', col_total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', col_labor: 'Ø³Ø§Ø¹Ø§Øª', col_quality: 'Ø¬',\n    grand_total: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', labor_cost: 'Ø¹Ù…Ø§Ù„Ø©', material_cost: 'Ù…ÙˆØ§Ø¯', labor_days: 'Ø£ÙŠØ§Ù…',\n    kpi_total: 'Ø§Ù„ØªÙƒÙ„ÙØ©', kpi_hours: 'Ø³Ø§Ø¹Ø§Øª', kpi_days: 'Ø£ÙŠØ§Ù…',\n    chart_cost_structure: 'Ø§Ù„Ù‡ÙŠÙƒÙ„', chart_labor: 'Ø¹Ù…Ø§Ù„Ø©', chart_material: 'Ù…ÙˆØ§Ø¯', chart_machines: 'Ù…Ø¹Ø¯Ø§Øª',\n    res_labor: 'Ø¹Ù…Ø§Ù„Ø©', res_material: 'Ù…ÙˆØ§Ø¯', res_machine: 'Ù…Ø¹Ø¯Ø§Øª',\n    collapse_all: 'Ø·ÙŠ', expand_all: 'ØªÙˆØ³ÙŠØ¹',\n    quality_high: 'Ø¹Ø§Ù„ÙŠØ©', quality_medium: 'Ù…ØªÙˆØ³Ø·Ø©', quality_low: 'Ù…Ù†Ø®ÙØ¶Ø©',\n    export_excel_msg: 'ØªØµØ¯ÙŠØ± Excel', export_pdf_msg: 'ØªØµØ¯ÙŠØ± PDF', btn_refine: 'ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ù‚', found_pct: 'ÙˆØ¬Ø¯', more_resources: 'Ø§Ù„Ù…Ø²ÙŠØ¯', kpi_items: 'Ø¨Ù†ÙˆØ¯', scope_title: 'Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„', show_scope: 'Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø·Ø§Ù‚'\n  },\n\n  'HI': { \n    db: 'HI_MUMBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³', native: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', cur: 'INR', sym: 'â‚¹', loc: 'hi-IN', region: 'à¤®à¥à¤‚à¤¬à¤ˆ', search_lang: 'Hindi',\n    ok: 'âœ… *à¤¹à¤¿à¤¨à¥à¤¦à¥€* Â· à¤®à¥à¤‚à¤¬à¤ˆ Â· INR',\n    text_prompt: `*à¤•à¤¾à¤°à¥à¤¯à¥‹à¤‚ à¤•à¤¾ à¤µà¤°à¥à¤£à¤¨ à¤•à¤°à¥‡à¤‚:*\\n\\n_à¤‰à¤¦à¤¾à¤¹à¤°à¤£:_\\n\\`\\`\\`\\nà¤¡à¥à¤°à¤¾à¤ˆà¤µà¥‰à¤² 2 à¤²à¥‡à¤¯à¤° 25m2\\nà¤Ÿà¤¾à¤‡à¤²à¥à¤¸ à¤¬à¤¾à¤¥à¤°à¥‚à¤® 15m2\\nà¤ªà¥‡à¤‚à¤Ÿà¤¿à¤‚à¤— à¤¦à¥€à¤µà¤¾à¤°à¥‡à¤‚ 120m2\\n\\`\\`\\``,\n    photo: `*à¤«à¤¼à¥‹à¤Ÿà¥‹, PDF à¤¯à¤¾ à¤µà¤¿à¤µà¤°à¤£ à¤­à¥‡à¤œà¥‡à¤‚*\n\nðŸ“„ *PDF à¤¡à¥à¤°à¤¾à¤‡à¤‚à¤—* â€” à¤«à¥à¤²à¥‹à¤° à¤ªà¥à¤²à¤¾à¤¨ à¤¯à¤¾ à¤¬à¥à¤²à¥‚à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ (à¤…à¤§à¤¿à¤•à¤¤à¤® 3 à¤ªà¥‡à¤œ)\nðŸ“· *à¤«à¤¼à¥‹à¤Ÿà¥‹* â€” à¤•à¤®à¤°à¥‡ à¤¯à¤¾ à¤µà¤¸à¥à¤¤à¥ à¤•à¥€ à¤«à¤¼à¥‹à¤Ÿà¥‹\nâœï¸ *à¤Ÿà¥‡à¤•à¥à¤¸à¥à¤Ÿ* â€” à¤•à¤¾à¤°à¥à¤¯à¥‹à¤‚ à¤•à¤¾ à¤µà¤¿à¤µà¤°à¤£ à¤¸à¥‚à¤šà¥€ à¤®à¥‡à¤‚\n\n_à¤•à¥‰à¤ªà¥€ à¤‰à¤¦à¤¾à¤¹à¤°à¤£:_\n\\`\\`\\`\nà¤¡à¥à¤°à¤¾à¤ˆà¤µà¥‰à¤² 2 à¤²à¥‡à¤¯à¤° à¤®à¥‡à¤Ÿà¤² à¤«à¥à¤°à¥‡à¤® 25m2\nà¤Ÿà¤¾à¤‡à¤²à¥à¤¸ 60x60 à¤¬à¤¾à¤¥à¤°à¥‚à¤® 15m2\nà¤ªà¥à¤Ÿà¥à¤Ÿà¥€ à¤›à¤¤ à¤¦à¥€à¤µà¤¾à¤°à¥‡à¤‚ 120m2\nà¤¸à¥‰à¤•à¥‡à¤Ÿ 20 à¤ªà¥€à¤¸\n\\`\\`\\`\n\nà¤¯à¤¾ à¤«à¤¼à¥‹à¤Ÿà¥‹/PDF à¤­à¥‡à¤œà¥‡à¤‚ ðŸ“·ðŸ“„`,\n    pdf_received: 'ðŸ“„ *PDF à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤*',\n    pdf_processing: 'â³ à¤¡à¥à¤°à¤¾à¤‡à¤‚à¤— à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£...',\n    pdf_pages: 'à¤ªà¥‡à¤œ',\n    pdf_page_limit: 'âš ï¸ à¤•à¥‡à¤µà¤² à¤ªà¤¹à¤²à¥‡ 3 à¤ªà¥‡à¤œ à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸ à¤¹à¥‹à¤‚à¤—à¥‡',\n    pdf_rooms_found: 'ðŸ  à¤•à¤®à¤°à¥‡ à¤®à¤¿à¤²à¥‡',\n    pdf_elements_found: 'ðŸ§± à¤à¤²à¤¿à¤®à¥‡à¤‚à¤Ÿ à¤®à¤¿à¤²à¥‡',\n    pdf_works_generated: 'ðŸ“ à¤•à¤¾à¤°à¥à¤¯ à¤¬à¤¨à¤¾à¤ à¤—à¤',\n    pdf_analyzing_page: 'ðŸ” à¤ªà¥‡à¤œ à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',\n    pdf_of: 'à¤®à¥‡à¤‚ à¤¸à¥‡',\n    pdf_complete: 'âœ… à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤ªà¥‚à¤°à¥à¤£',\n    pdf_error: 'âŒ PDF à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸à¤¿à¤‚à¤— à¤¤à¥à¤°à¥à¤Ÿà¤¿',\n    photo_added: 'âœ… à¤«à¤¼à¥‹à¤Ÿà¥‹ à¤œà¥‹à¤¡à¤¼à¥€ à¤—à¤ˆ',\n    photos_count: 'à¤«à¤¼à¥‹à¤Ÿà¥‹',\n    add_more: '+ à¤”à¤° à¤«à¤¼à¥‹à¤Ÿà¥‹',\n    analyze_now: 'â–¶ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',\n    analyzing: 'à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£...',\n    found: '*à¤ªà¤¹à¤šà¤¾à¤¨à¥‡ à¤—à¤ à¤•à¤¾à¤°à¥à¤¯:*',\n    edit_hint: 'à¤¸à¤‚à¤ªà¤¾à¤¦à¤¨ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¥ˆà¤ª à¤•à¤°à¥‡à¤‚',\n    calc: 'à¤®à¥‚à¤²à¥à¤¯ à¤–à¥‹à¤œ',\n    ready: '*à¤…à¤¨à¥à¤®à¤¾à¤¨*',\n    total: 'à¤•à¥à¤²',\n    days: 'à¤¦à¤¿à¤¨',\n    pct: 'à¤¸à¤Ÿà¥€à¤•à¤¤à¤¾',\n    workers: 'à¤¶à¥à¤°à¤®',\n    machines: 'à¤‰à¤ªà¤•à¤°à¤£',\n    materials: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€',\n    subtotal: 'à¤¸à¤¾à¤°à¤¾à¤‚à¤¶',\n    searching: 'à¤–à¥‹à¤œ',\n    of: 'à¤®à¥‡à¤‚ à¤¸à¥‡',\n    not_found: 'à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾',\n    low_conf: 'à¤œà¤¾à¤à¤šà¥‡à¤‚',\n    price_note: 'à¤†à¤§à¤¾à¤°: à¤®à¥à¤‚à¤¬à¤ˆ 2025',\n    btn_calc: 'â–¶ à¤—à¤£à¤¨à¤¾',\n    btn_new: '+ à¤¨à¤¯à¤¾',\n    btn_lang: 'âš™ à¤­à¤¾à¤·à¤¾',\n    btn_edit: 'âœŽ à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤',\n    btn_delete: 'âœ• à¤¹à¤Ÿà¤¾à¤à¤‚',\n    btn_add_work: '+ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚',\n    btn_done: 'âœ… à¤¹à¥‹ à¤—à¤¯à¤¾',\n    btn_export_excel: 'â†“ Excel',\n    btn_export_pdf: 'â†“ PDF',\n    btn_restart: 'â†» à¤«à¤¿à¤° à¤¸à¥‡',\n    btn_help: '? à¤®à¤¦à¤¦',\n    loading: 'à¤—à¤£à¤¨à¤¾...',\n    more_in_html: 'à¤µà¤¿à¤¸à¥à¤¤à¥ƒà¤¤ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤‰à¤ªà¤²à¤¬à¥à¤§',\n    resources: 'à¤µà¤¿à¤µà¤°à¤£: à¤¸à¤‚à¤¸à¤¾à¤§à¤¨ à¤”à¤° à¤•à¤¾à¤°à¥à¤¯ à¤•à¥à¤·à¥‡à¤¤à¥à¤°',\n    enter_work: '*à¤†à¤‡à¤Ÿà¤® à¤œà¥‹à¤¡à¤¼à¥‡à¤‚*\\nà¤ªà¥à¤°à¤¾à¤°à¥‚à¤ª: à¤µà¤¿à¤µà¤°à¤£, à¤®à¤¾à¤¤à¥à¤°à¤¾ à¤‡à¤•à¤¾à¤ˆ',\n    work_added: 'âœ… à¤œà¥‹à¤¡à¤¼à¤¾ à¤—à¤¯à¤¾',\n    what_next: '*à¤µà¤¿à¤•à¤²à¥à¤ª:*',\n    categories: 'à¤¶à¥à¤°à¥‡à¤£à¤¿à¤¯à¤¾à¤‚',\n    cat_demolition: 'à¤¤à¥‹à¤¡à¤¼à¤«à¥‹à¤¡à¤¼',\n    cat_rough: 'à¤¢à¤¾à¤‚à¤šà¤¾',\n    cat_finishing: 'à¤«à¤¼à¤¿à¤¨à¤¿à¤¶à¤¿à¤‚à¤—',\n    cat_mep: 'MEP',\n    help_title: '*à¤—à¤¾à¤‡à¤¡*',\n    help_text: `*à¤‰à¤ªà¤¯à¥‹à¤— à¤—à¤¾à¤‡à¤¡*\n\n*1.* à¤«à¤¼à¥‹à¤Ÿà¥‹, PDF à¤¯à¤¾ à¤µà¤¿à¤µà¤°à¤£ à¤­à¥‡à¤œà¥‡à¤‚\nPDF: à¤…à¤§à¤¿à¤•à¤¤à¤® 3 à¤ªà¥‡à¤œ\n*2.* à¤•à¤¾à¤°à¥à¤¯ à¤œà¤¾à¤à¤šà¥‡à¤‚\n*3.* à¤®à¥‚à¤²à¥à¤¯ à¤—à¤£à¤¨à¤¾\n*4.* à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤\n\n/start â€” à¤¨à¤¯à¤¾\n/help â€” à¤®à¤¦à¤¦`,\n    doc_title: 'à¤…à¤¨à¥à¤®à¤¾à¤¨',\n    col_pos: 'à¤•à¥à¤°à¤®', col_code: 'à¤•à¥‹à¤¡', col_desc: 'à¤µà¤¿à¤µà¤°à¤£', col_unit: 'à¤‡à¤•à¤¾à¤ˆ', col_qty: 'à¤®à¤¾à¤¤à¥à¤°à¤¾', col_price: 'à¤¦à¤°', col_total: 'à¤•à¥à¤²', col_labor: 'à¤˜à¤‚à¤Ÿà¥‡', col_quality: 'à¤—à¥',\n    grand_total: 'à¤•à¥à¤² à¤¯à¥‹à¤—', labor_cost: 'à¤¶à¥à¤°à¤®', material_cost: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', labor_days: 'à¤¦à¤¿à¤¨',\n    kpi_total: 'à¤•à¥à¤² à¤²à¤¾à¤—à¤¤', kpi_hours: 'à¤˜à¤‚à¤Ÿà¥‡', kpi_days: 'à¤¦à¤¿à¤¨',\n    chart_cost_structure: 'à¤¸à¤‚à¤°à¤šà¤¨à¤¾', chart_labor: 'à¤¶à¥à¤°à¤®', chart_material: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', chart_machines: 'à¤‰à¤ªà¤•à¤°à¤£',\n    res_labor: 'à¤¶à¥à¤°à¤®', res_material: 'à¤¸à¤¾à¤®à¤—à¥à¤°à¥€', res_machine: 'à¤‰à¤ªà¤•à¤°à¤£',\n    collapse_all: 'à¤¸à¤‚à¤•à¥à¤·à¤¿à¤ªà¥à¤¤', expand_all: 'à¤µà¤¿à¤¸à¥à¤¤à¥ƒà¤¤',\n    quality_high: 'à¤‰à¤šà¥à¤š', quality_medium: 'à¤®à¤§à¥à¤¯à¤®', quality_low: 'à¤¨à¤¿à¤®à¥à¤¨',\n    export_excel_msg: 'Excel à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤', export_pdf_msg: 'PDF à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤', btn_refine: 'à¤¸à¥à¤§à¤¾à¤°à¥‡à¤‚', found_pct: 'à¤®à¤¿à¤²à¤¾', more_resources: 'à¤”à¤°', kpi_items: 'à¤†à¤‡à¤Ÿà¤®', scope_title: 'à¤•à¤¾à¤°à¥à¤¯ à¤•à¥à¤·à¥‡à¤¤à¥à¤°', show_scope: 'à¤¦à¥‡à¤–à¥‡à¤‚'\n  }\n};\n\nconst L = LANGS[lang] || LANGS['EN'];\n\n// Update session with language data\nif (sd.sess && sd.sess[chatId]) { \n  sd.sess[chatId].db = L.db; \n  sd.sess[chatId].L = L; \n}\n\n// Get voice/PDF file IDs from session if available\nconst voiceFileId = sd.sess?.[chatId]?.voiceFileId || input.voiceFileId || null;\nconst pdfFileId = sd.sess?.[chatId]?.pdfFileId || input.pdfFileId || null;\nconst pdfFileName = sd.sess?.[chatId]?.pdfFileName || input.pdfFileName || null;\n\nreturn { \n  json: { \n    ...input, \n    L: L, \n    db: L.db, \n    voiceFileId,\n    pdfFileId,\n    pdfFileName,\n    // API Keys passthrough\n  } \n};"
      },
      "typeVersion": 2
    },
    {
      "id": "e787b927-681d-4414-b6bd-35a77570c8b9",
      "name": "Main",
      "type": "n8n-nodes-base.code",
      "position": [
        -5088,
        -1568
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAIN ROUTER - Text-Only Version\n// DDC CWICR - Data Driven Construction Cost Estimator\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst update = $('Telegram Trigger1').first().json;\nconst botToken = $input.first().json.bot_token;\nconst isCallback = !!update.callback_query;\n\nlet chatId, callbackData, callbackQueryId, text;\n\nif (isCallback) {\n  const cb = update.callback_query;\n  chatId = cb.message?.chat?.id;\n  callbackData = cb.data || '';\n  callbackQueryId = cb.id;\n  text = '';\n} else {\n  const msg = update.message || {};\n  chatId = msg.chat?.id;\n  callbackData = '';\n  callbackQueryId = '';\n  text = msg.text || '';\n}\n\nconst sd = $getWorkflowStaticData('global');\nif (!sd.sess) sd.sess = {};\nconst cid = String(chatId);\nif (!sd.sess[cid]) sd.sess[cid] = { \n  lang: null, works: [], state: 'new', db: null, L: null, description: ''\n};\nconst S = sd.sess[cid];\n\nlet action = 'none';\n\n// === COMMANDS ===\nif (text.toLowerCase() === '/start') {\n  S.lang = null; S.works = []; S.state = 'wait_lang'; S.db = null; S.L = null;\n  S.description = '';\n  action = 'show_lang';\n}\nelse if (text.toLowerCase() === '/help') {\n  action = 'show_help';\n}\n\n// === LANGUAGE SELECTION ===\nelse if (/^lang_(DE|EN|RU|ES|FR|PT|ZH|AR|HI)$/i.test(callbackData)) {\n  S.lang = callbackData.replace('lang_', '').toUpperCase();\n  S.state = 'wait_text';\n  action = 'lang_selected';\n}\n\n// === EDIT WORK ITEMS ===\nelse if (/^edit_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/edit_work_(\\d+)/)[1]);\n  S.editingWorkIndex = idx;\n  S.state = 'editing_work';\n  action = 'show_edit_menu';\n}\nelse if (/^delete_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/delete_work_(\\d+)/)[1]);\n  if (S.works[idx]) {\n    S.works.splice(idx, 1);\n    S.works.forEach((w, i) => { w.seq = i + 1; w.id = `W${String(i+1).padStart(3,'0')}`; });\n  }\n  action = 'works_updated';\n}\nelse if (/^qty_work_(\\d+)_(.+)$/.test(callbackData)) {\n  const match = callbackData.match(/qty_work_(\\d+)_(.+)/);\n  const idx = parseInt(match[1]);\n  const change = match[2];\n  if (S.works[idx]) {\n    let q = S.works[idx].qty;\n    if (change === 'plus10') q += 10;\n    else if (change === 'minus10') q = Math.max(1, q - 10);\n    else if (change === 'plus1') q += 1;\n    else if (change === 'minus1') q = Math.max(1, q - 1);\n    else if (change === 'double') q *= 2;\n    else if (change === 'half') q = Math.max(1, Math.round(q / 2));\n    S.works[idx].qty = q;\n  }\n  action = 'works_updated';\n}\nelse if (callbackData === 'add_work') {\n  S.state = 'adding_work';\n  action = 'ask_new_work';\n}\nelse if (callbackData === 'done_editing') {\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === CALCULATE ===\nelse if (callbackData === 'calculate') {\n  if (S.works && S.works.length > 0) {\n    S.state = 'calc';\n    action = 'start_calc';\n  } else {\n    action = 'lang_selected'; // show text prompt again\n  }\n}\n\n// === EXPORT ===\nelse if (callbackData === 'view_details') { action = 'view_details'; }\nelse if (callbackData === 'export_excel') { action = 'export_excel'; }\nelse if (callbackData === 'export_pdf') { action = 'export_pdf'; }\n\n// === RESTART ===\nelse if (callbackData === 'restart' || callbackData === 'new_estimate') {\n  S.works = []; S.description = ''; S.state = 'wait_text';\n  action = 'lang_selected';\n}\nelse if (callbackData === 'show_help' || callbackData === 'help') { action = 'show_help'; }\nelse if (callbackData === 'change_language' || callbackData === 'back_to_lang') {\n  S.lang = null; S.state = 'wait_lang';\n  action = 'show_lang';\n}\n\n// === TEXT INPUT ===\nelse if (text && S.state === 'adding_work') {\n  const parts = text.split(',');\n  const name = parts[0]?.trim() || text;\n  let qty = 1, unit = 'mÂ²';\n  if (parts[1]) {\n    const qtyMatch = parts[1].match(/([\\d.,]+)\\s*(.*)/);\n    if (qtyMatch) {\n      qty = parseFloat(qtyMatch[1].replace(',', '.')) || 1;\n      unit = qtyMatch[2]?.trim() || 'mÂ²';\n    }\n  }\n  S.works.push({\n    id: `W${String(S.works.length + 1).padStart(3,'0')}`,\n    name, query: name, qty, unit, conf: 'medium', seq: S.works.length + 1\n  });\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\nelse if (text && S.lang && (S.state === 'wait_text' || S.state === 'new') && text.length > 3) {\n  S.description = text;\n  S.textInput = text;\n  action = 'analyze_text';\n}\n\n// === FALLBACKS ===\nelse if (!S.lang) { action = 'show_lang'; }\nelse if (!text && S.state === 'wait_text') { action = 'lang_selected'; }\n\nreturn { json: { \n  bot_token: botToken, chatId, action, lang: S.lang, works: S.works, \n  callbackData, callbackQueryId, isCallback, text,\n  description: S.description, editingWorkIndex: S.editingWorkIndex\n}};"
      },
      "typeVersion": 2
    },
    {
      "id": "87655043-2e58-4c4f-8698-8e8029c3d5e4",
      "name": "Block 6 - Calculation",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2944,
        -560
      ],
      "parameters": {
        "color": 3,
        "width": 1936,
        "height": 772,
        "content": "## ðŸ”„ Block 6: Calculation Loop\n\n**Per Work Item:**\n```\nPrep â†’ LLM Transform â†’ Embed â†’ \nQdrant Search â†’ Rerank â†’ Calculate\n```\n\n**Vector Search:**\n- OpenAI text-embedding-3-small\n- Qdrant similarity search\n- LLM reranking (best match)\n\n**Output per item:**\n- Matched rate code\n- Unit cost\n- Total cost\n- Resources breakdown\n- Scope of work"
      },
      "typeVersion": 1
    },
    {
      "id": "214f72a6-a2c6-4508-9a6a-ffaa5deafc7b",
      "name": "Block 7 - Reports",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2944,
        -1072
      ],
      "parameters": {
        "color": 6,
        "width": 1928,
        "height": 484,
        "content": "## ðŸ“Š Block 7: Reports\n\n**Final Processing:**\n```\nAggregate â†’ Generate HTML â†’ Send\n```\n**Report Contents:**\n- Work items with costs\n- Resources (labor/material/machine)\n- Scope of work\n- Quality indicators\n- Cost breakdown charts"
      },
      "typeVersion": 1
    },
    {
      "id": "e7488701-92a6-4a11-9651-0c37965c4900",
      "name": "Block 8 - Export",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4304,
        -1072
      ],
      "parameters": {
        "color": 6,
        "width": 1320,
        "height": 692,
        "content": "## ðŸ“¥ Block 8: Export\n\n**Available Exports:**\n- ðŸ“Š **Excel (CSV)** â€” Spreadsheet\n- ðŸ“„ **PDF** â€” Document\n- ðŸŒ **HTML** â€” Interactive\n\n**View Details button:**\n- Full resource breakdown\n- Scope of work\n- Quality scores\n\n**Data includes:**\n- Rate codes\n- Unit prices\n- Labor hours\n- Material costs"
      },
      "typeVersion": 1
    },
    {
      "id": "0accda2e-edfc-4609-9d5c-37ab7b6672a1",
      "name": "Qdrant Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3360,
        -336
      ],
      "parameters": {
        "width": 380,
        "height": 528,
        "content": "## ðŸ” Qdrant Vector DB\n\n**Collections (9 languages):**\n- `DDC_CWICR_DE` â€” German\n- `DDC_CWICR_EN` â€” English\n- `DDC_CWICR_RU` â€” Russian\n- `DDC_CWICR_ES` â€” Spanish\n- `DDC_CWICR_FR` â€” French\n- `DDC_CWICR_PT` â€” Portuguese\n- `DDC_CWICR_ZH` â€” Chinese\n- `DDC_CWICR_AR` â€” Arabic\n- `DDC_CWICR_HI` â€” Hindi\n\n**Setup:**\n1. Install Qdrant\n2. Load collections from DDC repo\n3. Configure QDRANT_URL\n\n**Each collection:** ~55,000 vectors"
      },
      "typeVersion": 1
    },
    {
      "id": "18bb796a-6bf0-44e9-be2b-72ebae258a29",
      "name": "Prep Text LLM",
      "type": "n8n-nodes-base.code",
      "position": [
        -4272,
        -1696
      ],
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DDC CWICR - Prep Text LLM Request (for AI Node)\n// Prepare prompt for text-to-works analysis\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cfg = $('Config').first().json;\nconst tokenConfig = $('ðŸ”‘ TOKEN').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || {};\n\nconst textInput = cfg.text || session.textInput || cfg.textInput || cfg.description || '';\nconst searchLang = L.search_lang || 'English';\n\nconsole.log('=== PREP TEXT LLM ===');\nconsole.log('Input:', textInput);\nconsole.log('Language:', searchLang);\n\nif (!textInput || textInput.length < 3) {\n  return { json: { ...cfg, chatId: cid, _skip_llm: true, works: [], description: 'No input' }};\n}\n\n// Language-specific examples\nconst LANG_EXAMPLES = {\n  'German': {\n    input: 'Renovierung Badezimmer 8qm',\n    output: '[{\"name\": \"Fliesendemontage Wand Boden\", \"qty\": 24, \"unit\": \"mÂ²\"}, {\"name\": \"Wandfliesen Feinsteinzeug 30x60\", \"qty\": 16, \"unit\": \"mÂ²\"}, {\"name\": \"Bodenfliesen rutschfest\", \"qty\": 8, \"unit\": \"mÂ²\"}, {\"name\": \"WC wandhÃ¤ngend montieren\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Waschtisch montieren\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'English': {\n    input: 'Bathroom renovation 8sqm',\n    output: '[{\"name\": \"Tile removal walls floor\", \"qty\": 24, \"unit\": \"mÂ²\"}, {\"name\": \"Wall tiles porcelain 30x60\", \"qty\": 16, \"unit\": \"mÂ²\"}, {\"name\": \"Floor tiles anti-slip\", \"qty\": 8, \"unit\": \"mÂ²\"}, {\"name\": \"Wall-hung toilet install\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Vanity basin install\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'Russian': {\n    input: 'Ñ€ÐµÐ¼Ð¾Ð½Ñ‚ ÐºÑƒÑ…Ð½Ð¸ 20Ð¼2 ÑÑ‚ÐµÐ½Ñ‹ Ð¸ Ð»Ð°Ð¼Ð¸Ð½Ð°Ñ‚',\n    output: '[{\"name\": \"Ð”ÐµÐ¼Ð¾Ð½Ñ‚Ð°Ð¶ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ð¾ÐµÐ²\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Ð¨Ñ‚ÑƒÐºÐ°Ñ‚ÑƒÑ€ÐºÐ° ÑÑ‚ÐµÐ½ Ð³Ð¸Ð¿ÑÐ¾Ð²Ð°Ñ\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Ð¨Ð¿Ð°ÐºÐ»Ñ‘Ð²ÐºÐ° ÑÑ‚ÐµÐ½ Ñ„Ð¸Ð½Ð¸ÑˆÐ½Ð°Ñ\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"ÐžÐºÑ€Ð°ÑÐºÐ° ÑÑ‚ÐµÐ½ Ð²Ð¾Ð´Ð¾ÑÐ¼ÑƒÐ»ÑŒÑÐ¸Ð¾Ð½Ð½Ð°Ñ\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Ð”ÐµÐ¼Ð¾Ð½Ñ‚Ð°Ð¶ Ð½Ð°Ð¿Ð¾Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ\", \"qty\": 20, \"unit\": \"mÂ²\"}, {\"name\": \"Ð£ÐºÐ»Ð°Ð´ÐºÐ° Ð»Ð°Ð¼Ð¸Ð½Ð°Ñ‚Ð° Ñ Ð¿Ð¾Ð´Ð»Ð¾Ð¶ÐºÐ¾Ð¹\", \"qty\": 20, \"unit\": \"mÂ²\"}, {\"name\": \"ÐœÐ¾Ð½Ñ‚Ð°Ð¶ Ð¿Ð»Ð¸Ð½Ñ‚ÑƒÑÐ°\", \"qty\": 18, \"unit\": \"m\"}]'\n  },\n  'Spanish': {\n    input: 'reforma cocina 20m2 paredes y suelo',\n    output: '[{\"name\": \"Retirada papel pintado\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Enlucido paredes\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"DemoliciÃ³n suelo\", \"qty\": 20, \"unit\": \"mÂ²\"}, {\"name\": \"Tarima flotante\", \"qty\": 20, \"unit\": \"mÂ²\"}]'\n  },\n  'French': {\n    input: 'rÃ©novation cuisine 20m2 murs et sol',\n    output: '[{\"name\": \"DÃ©pose papier peint\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Enduit murs\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Peinture murs\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"DÃ©pose revÃªtement sol\", \"qty\": 20, \"unit\": \"mÂ²\"}, {\"name\": \"Pose parquet flottant\", \"qty\": 20, \"unit\": \"mÂ²\"}]'\n  },\n  'Portuguese': {\n    input: 'reforma cozinha 20m2 paredes e piso',\n    output: '[{\"name\": \"RemoÃ§Ã£o papel parede\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Reboco paredes\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"mÂ²\"}, {\"name\": \"RemoÃ§Ã£o piso\", \"qty\": 20, \"unit\": \"mÂ²\"}, {\"name\": \"Piso laminado\", \"qty\": 20, \"unit\": \"mÂ²\"}]'\n  }\n};\n\nconst langExample = LANG_EXAMPLES[searchLang] || LANG_EXAMPLES['English'];\n\nconst parsePrompt = `You are a construction cost estimator. Extract ALL construction works from user's text.\n\nRULES:\n1. Output ONLY valid JSON array - NO explanations, NO markdown code blocks\n2. Generate works in ${searchLang} language  \n3. Be COMPREHENSIVE - include ALL works needed for described scope\n4. Use REALISTIC quantities based on area/room size mentioned\n5. Work names must be SPECIFIC for database search (not generic like \"wall work\")\n\nUNITS: mÂ² (area), m (linear), pcs (items), kg, l\n\nEXAMPLE:\nInput: \"${langExample.input}\"\nOutput: ${langExample.output}\n\nUSER INPUT: \"${textInput}\"\n\nJSON ARRAY OUTPUT:`;\n\nconsole.log('Prompt prepared, length:', parsePrompt.length);\n\nreturn { json: { \n  ...cfg, \n  chatId: cid, \n  textInput,\n  description: textInput.substring(0, 50) + (textInput.length > 50 ? '...' : ''),\n  _parse_prompt: parsePrompt,\n  L\n}};"
      },
      "typeVersion": 2
    },
    {
      "id": "5428212a-6693-4480-933a-4d4ec9edd0ea",
      "name": "ðŸ“¤ Edit Menu",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -4128,
        -1520
      ],
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('ðŸ”‘ TOKEN').first().json.bot_token }}/sendMessage",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "sendBody": true,
        "specifyBody": "json"
      },
      "typeVersion": 4.2
    },
    {
      "id": "96e1a4d4-e8f8-42b6-bf14-f21159e676dc",
      "name": "Telegram Trigger1",
      "type": "n8n-nodes-base.telegramTrigger",
      "position": [
        -5536,
        -1568
      ],
      "webhookId": "da06f3e4-5c38-4698-90c5-ed8bcc977443",
      "parameters": {
        "updates": [
          "callback_query",
          "message"
        ],
        "additionalFields": {}
      },
      "credentials": {
        "telegramApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "18d9abc4-db2b-4089-864a-d456405ffe09",
      "name": "Prep Lang OK",
      "type": "n8n-nodes-base.code",
      "position": [
        -4112,
        -2288
      ],
      "parameters": {
        "jsCode": "// Prepare Lang OK message body\nconst cfg = $('Config').item.json;\nconst L = cfg.L || {};\n\n// Two options message\nconst examples = {\n  DE: `âœ… *Deutsch* Â· Berlin Â· EUR\n\n*Beschreiben Sie Ihr Projekt:*\n\n*Option 1 â€” Kurzbeschreibung:*\n\\`Renovierung KÃ¼che 15mÂ², mittlere QualitÃ¤t\\`\n\\`Badezimmer komplett neu 8mÂ²\\`\n\n*Option 2 â€” Detaillierte Liste:*\n\\`\\`\\`\nGipskarton 2-lagig 25m2\nFliesen 60x60 Bad 15m2\nSpachteln Decken WÃ¤nde 120m2\nSteckdosen 20 StÃ¼ck\n\\`\\`\\``,\n\n  EN: `âœ… *English* Â· Toronto Â· CAD\n\n*Describe your project:*\n\n*Option 1 â€” Brief description:*\n\\`Kitchen renovation 15mÂ², medium quality\\`\n\\`Complete bathroom remodel 8mÂ²\\`\n\n*Option 2 â€” Detailed list:*\n\\`\\`\\`\nDrywall 2-layer 25m2\nTiles 60x60 bathroom 15m2\nPlastering ceiling walls 120m2\nElectrical outlets 20 pcs\n\\`\\`\\``,\n\n  RU: `âœ… *Ð ÑƒÑÑÐºÐ¸Ð¹* Â· Ð¡ÐŸÐ± Â· RUB\n\n*ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð¿Ñ€Ð¾ÐµÐºÑ‚:*\n\n*Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1 â€” ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ:*\n\\`Ð ÐµÐ¼Ð¾Ð½Ñ‚ ÐºÑƒÑ…Ð½Ð¸ 15Ð¼Â², ÑÑ€ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ»Ð°ÑÑ\\`\n\\`Ð’Ð°Ð½Ð½Ð°Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ð¿Ð¾Ð´ ÐºÐ»ÑŽÑ‡ 8Ð¼Â²\\`\n\n*Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2 â€” Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº:*\n\\`\\`\\`\nÐ“Ð¸Ð¿ÑÐ¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½ 2 ÑÐ»Ð¾Ñ 25Ð¼2\nÐŸÐ»Ð¸Ñ‚ÐºÐ° 60x60 Ð²Ð°Ð½Ð½Ð°Ñ 15Ð¼2\nÐ¨Ð¿Ð°ÐºÐ»ÐµÐ²ÐºÐ° Ð¿Ð¾Ñ‚Ð¾Ð»ÐºÐ¸ ÑÑ‚ÐµÐ½Ñ‹ 120Ð¼2\nÐ Ð¾Ð·ÐµÑ‚ÐºÐ¸ 20ÑˆÑ‚\n\\`\\`\\``,\n\n  ES: `âœ… *EspaÃ±ol* Â· Barcelona Â· EUR\n\n*Describa su proyecto:*\n\n*OpciÃ³n 1 â€” DescripciÃ³n breve:*\n\\`Reforma cocina 15mÂ², calidad media\\`\n\\`BaÃ±o completo 8mÂ²\\`\n\n*OpciÃ³n 2 â€” Lista detallada:*\n\\`\\`\\`\nPladur 2 capas 25m2\nAzulejos 60x60 baÃ±o 15m2\nAlisado techos paredes 120m2\nEnchufes 20uds\n\\`\\`\\``,\n\n  FR: `âœ… *FranÃ§ais* Â· Paris Â· EUR\n\n*DÃ©crivez votre projet:*\n\n*Option 1 â€” Description courte:*\n\\`RÃ©novation cuisine 15mÂ², qualitÃ© moyenne\\`\n\\`Salle de bain complÃ¨te 8mÂ²\\`\n\n*Option 2 â€” Liste dÃ©taillÃ©e:*\n\\`\\`\\`\nPlaco 2 couches 25m2\nCarrelage 60x60 sdb 15m2\nEnduit plafonds murs 120m2\nPrises 20pcs\n\\`\\`\\``,\n\n  PT: `âœ… *PortuguÃªs* Â· SÃ£o Paulo Â· BRL\n\n*Descreva seu projeto:*\n\n*OpÃ§Ã£o 1 â€” DescriÃ§Ã£o breve:*\n\\`Reforma cozinha 15mÂ², qualidade mÃ©dia\\`\n\\`Banheiro completo 8mÂ²\\`\n\n*OpÃ§Ã£o 2 â€” Lista detalhada:*\n\\`\\`\\`\nDrywall 2 camadas 25m2\nPorcelanato 60x60 banheiro 15m2\nMassa corrida teto paredes 120m2\nTomadas 20un\n\\`\\`\\``,\n\n  ZH: `âœ… *ä¸­æ–‡* Â· ä¸Šæµ· Â· CNY\n\n*æè¿°æ‚¨çš„é¡¹ç›®:*\n\n*é€‰é¡¹1 â€” ç®€è¦æè¿°:*\n\\`åŽ¨æˆ¿ç¿»æ–° 15mÂ²ï¼Œä¸­ç­‰å“è´¨\\`\n\\`å«ç”Ÿé—´å…¨å¥— 8mÂ²\\`\n\n*é€‰é¡¹2 â€” è¯¦ç»†æ¸…å•:*\n\\`\\`\\`\nçŸ³è†æ¿åŒå±‚ 25m2\nç“·ç –60x60å«ç”Ÿé—´ 15m2\nè…»å­é¡¶å¢™ 120m2\næ’åº§ 20ä¸ª\n\\`\\`\\``,\n\n  AR: `âœ… *Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©* Â· Ø¯Ø¨ÙŠ Â· AED\n\n*ØµÙ Ù…Ø´Ø±ÙˆØ¹Ùƒ:*\n\n*Ø§Ù„Ø®ÙŠØ§Ø± 1 â€” ÙˆØµÙ Ù…Ø®ØªØµØ±:*\n\\`ØªØ¬Ø¯ÙŠØ¯ Ù…Ø·Ø¨Ø® 15Ù…Â²ØŒ Ø¬ÙˆØ¯Ø© Ù…ØªÙˆØ³Ø·Ø©\\`\n\\`Ø­Ù…Ø§Ù… ÙƒØ§Ù…Ù„ 8Ù…Â²\\`\n\n*Ø§Ù„Ø®ÙŠØ§Ø± 2 â€” Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØµÙ„Ø©:*\n\\`\\`\\`\nØ¬Ø¨Ø³ Ø¨ÙˆØ±Ø¯ Ø·Ø¨Ù‚ØªÙŠÙ† 25Ù…2\nØ¨Ù„Ø§Ø· 60x60 Ø­Ù…Ø§Ù… 15Ù…2\nÙ…Ø¹Ø¬ÙˆÙ† Ø£Ø³Ù‚Ù Ø¬Ø¯Ø±Ø§Ù† 120Ù…2\nÙ…Ù‚Ø§Ø¨Ø³ 20 Ù‚Ø·Ø¹Ø©\n\\`\\`\\``,\n\n  HI: `âœ… *à¤¹à¤¿à¤¨à¥à¤¦à¥€* Â· à¤®à¥à¤‚à¤¬à¤ˆ Â· INR\n\n*à¤…à¤ªà¤¨à¤¾ à¤ªà¥à¤°à¥‹à¤œà¥‡à¤•à¥à¤Ÿ à¤¬à¤¤à¤¾à¤à¤‚:*\n\n*à¤µà¤¿à¤•à¤²à¥à¤ª 1 â€” à¤¸à¤‚à¤•à¥à¤·à¤¿à¤ªà¥à¤¤ à¤µà¤¿à¤µà¤°à¤£:*\n\\`à¤•à¤¿à¤šà¤¨ à¤°à¥‡à¤¨à¥‹à¤µà¥‡à¤¶à¤¨ 15mÂ², à¤®à¤§à¥à¤¯à¤® à¤•à¥à¤µà¤¾à¤²à¤¿à¤Ÿà¥€\\`\n\\`à¤¬à¤¾à¤¥à¤°à¥‚à¤® à¤ªà¥‚à¤°à¥à¤£ 8mÂ²\\`\n\n*à¤µà¤¿à¤•à¤²à¥à¤ª 2 â€” à¤µà¤¿à¤¸à¥à¤¤à¥ƒà¤¤ à¤¸à¥‚à¤šà¥€:*\n\\`\\`\\`\nà¤¡à¥à¤°à¤¾à¤ˆà¤µà¥‰à¤² 2 à¤²à¥‡à¤¯à¤° 25m2\nà¤Ÿà¤¾à¤‡à¤²à¥à¤¸ 60x60 à¤¬à¤¾à¤¥à¤°à¥‚à¤® 15m2\nà¤ªà¥à¤Ÿà¥à¤Ÿà¥€ à¤›à¤¤ à¤¦à¥€à¤µà¤¾à¤°à¥‡à¤‚ 120m2\nà¤¸à¥‰à¤•à¥‡à¤Ÿ 20 à¤ªà¥€à¤¸\n\\`\\`\\``\n};\n\nconst lang = cfg.lang || 'EN';\nconst text = examples[lang] || examples['EN'];\n\nreturn {\n  json: {\n    chatId: cfg.chatId,\n    _body: {\n      chat_id: cfg.chatId,\n      text: text,\n      parse_mode: \"Markdown\",\n      reply_markup: {\n        inline_keyboard: [\n          [\n            {text: \"â“ Help\", callback_data: \"show_help\"}, \n            {text: \"ðŸŒ Language\", callback_data: \"change_language\"}\n          ]\n        ]\n      }\n    }\n  }\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "cf603c92-9a4b-4f48-91f9-07b4f3cbdb29",
      "name": "ðŸ”§ Config Parse",
      "type": "n8n-nodes-base.set",
      "position": [
        -4128,
        -1696
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "519bfbb9-8f49-49f9-ba53-8a234a1e6e35",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json._parse_prompt }}"
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "e3771ed1-2c9d-4068-ba17-a158f810191c",
      "name": "ðŸ¤– AI Parse Text",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -3968,
        -1696
      ],
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('ðŸ”§ Config Parse').item.json.chatInput }}"
            }
          ]
        }
      },
      "typeVersion": 1.4
    },
    {
      "id": "3814f181-8e64-457c-a00f-e85a6c50de9a",
      "name": "OpenAI Model 1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        -3920,
        -240
      ],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "chatgpt-4o-latest",
          "cachedResultName": "chatgpt-4o-latest"
        },
        "options": {
          "temperature": 0.15
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "8f46f5e0-89f6-4e08-9dea-77fb73e35aef",
      "name": "ðŸ”§ Config Transform",
      "type": "n8n-nodes-base.set",
      "position": [
        -1744,
        -400
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "83df83a1-7099-4f1d-a41c-11bdacf6587c",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json._transform_prompt }}"
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "c5024917-6a3e-4ddf-bce0-76b0bae61685",
      "name": "ðŸ¤– AI Transform",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -1568,
        -400
      ],
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('ðŸ”§ Config Transform').item.json.chatInput }}"
            }
          ]
        }
      },
      "typeVersion": 1.4
    },
    {
      "id": "5b0a861f-bc95-4892-9c01-50e089893efb",
      "name": "OpenAI Model 2",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        -3600,
        -32
      ],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.3
        }
      },
      "credentials": {
        "openAiApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "e059086c-d718-45c2-abb1-365997bf0cbf",
      "name": "ðŸ”§ Config Rerank",
      "type": "n8n-nodes-base.set",
      "position": [
        -1744,
        -208
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "39cc26f5-b4d3-4c66-94b2-b9f2f12267e4",
              "name": "system_prompt",
              "type": "string",
              "value": "You are a construction cost database expert. Respond ONLY with valid JSON, no markdown."
            },
            {
              "id": "09774508-e3cf-41ea-844a-a65c00e12cba",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json._rerank_prompt }}"
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "3a82f4fc-6f8c-4c82-acf4-f763d6e53e76",
      "name": "ðŸ¤– AI Rerank",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -1568,
        -208
      ],
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('ðŸ”§ Config Rerank').item.json.chatInput }}"
            }
          ]
        }
      },
      "typeVersion": 1.4
    },
    {
      "id": "06f2702e-b068-4a92-afa7-67d935b881f1",
      "name": "ðŸ“ Parse Text Response",
      "type": "n8n-nodes-base.code",
      "position": [
        -3664,
        -1696
      ],
      "parameters": {
        "jsCode": "// Parse AI response for text works\nconst aiResponse = $input.first().json;\nconst prepData = $('Prep Text LLM').first().json;\nconst cid = String(prepData.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = prepData.L || {};\n\nconsole.log('=== PARSE TEXT RESPONSE ===');\n\nlet text = '';\nif (aiResponse.text) {\n  text = aiResponse.text;\n} else if (aiResponse.response?.text) {\n  text = aiResponse.response.text;\n} else if (aiResponse.output) {\n  text = aiResponse.output;\n}\n\nconsole.log('Raw response:', text?.substring(0, 200));\n\n// Clean response - remove markdown code blocks\ntext = text.replace(/```json\\n?/gi, '').replace(/```\\n?/g, '').trim();\n\n// Extract JSON array\nlet works = [];\ntry {\n  const match = text.match(/\\[.*\\]/s);\n  if (match) {\n    works = JSON.parse(match[0]);\n  } else {\n    works = JSON.parse(text);\n  }\n} catch (e) {\n  console.log('Parse error:', e.message);\n  // Try line by line\n  const lines = text.split('\\n').filter(l => l.trim().startsWith('{'));\n  if (lines.length > 0) {\n    try {\n      works = JSON.parse('[' + lines.join(',') + ']');\n    } catch (e2) {\n      console.log('Fallback parse failed');\n    }\n  }\n}\n\nconsole.log('Parsed works:', works.length);\n\n// Validate and clean works\nworks = works.map((w, i) => ({\n  id: i + 1,\n  name: String(w.name || w.work || '').trim(),\n  qty: parseFloat(w.qty || w.quantity || 1) || 1,\n  unit: String(w.unit || 'mÂ²').trim(),\n  room: w.room || ''\n})).filter(w => w.name.length > 0);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].works = works;\nsd.sess[cid].description = prepData.description || prepData.textInput?.substring(0, 50) || '';\nsd.sess[cid].state = 'parsed';\n\nconsole.log('Saved', works.length, 'works to session');\n\nreturn { json: { \n  ...prepData, \n  works, \n  _parsed: true,\n  _works_count: works.length\n}};"
      },
      "typeVersion": 2
    },
    {
      "id": "b13e5f92-4464-463a-bac7-c6c49dc284d2",
      "name": "Sticky AI Parse",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4304,
        -1952
      ],
      "parameters": {
        "color": 6,
        "width": 1112,
        "height": 392,
        "content": "## ðŸ¤– AI Parse Text\n\n**Purpose:** Extract works from user text\n\n**Models (enable ONE):**\n- âœ“ OpenAI Model 1 (gpt-4o-mini)\n- â—‹ Claude Model 1 (disabled)\n- â—‹ Gemini Model 1 (disabled)\n\n**To switch:** Disable current, enable other"
      },
      "typeVersion": 1
    },
    {
      "id": "484e78d7-8254-4b00-81be-3c5c6571dd0a",
      "name": "Sticky AI Transform Rerank",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1776,
        -544
      ],
      "parameters": {
        "width": 456,
        "height": 736,
        "content": "## ðŸ¤– AI Transform & Rerank\n\n**Transform:** Optimize search query\n**Rerank:** Score candidates 0-100\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**Models per stage:**\n- OpenAI Model 2/3 (active)\n- Claude Model 2/3 (disabled)\n- Gemini Model 2/3 (disabled)\n\n**To switch models:**\n1. Disable current model node\n2. Enable alternative model\n3. Connects automatically"
      },
      "typeVersion": 1
    },
    {
      "id": "7b2f5619-46d8-41d5-82f8-c2a769572e4b",
      "name": "Token Setup",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5536,
        -1376
      ],
      "parameters": {
        "width": 280,
        "height": 264,
        "content": "## âš ï¸ Setup ðŸ”‘ TOKEN\n\n**Edit TOKEN node values:**\n\n- `bot_token` â†’ Telegram token\n- `QDRANT_URL` â†’ Qdrant server\n\n**Error \"resource not found\"?**\nâ†’ bot_token is invalid\n\n**Get token:** @BotFather â†’ /newbot"
      },
      "typeVersion": 1
    },
    {
      "id": "a12cfbcc-d1c7-41b9-ae56-a36a35ff3e3b",
      "name": "ðŸ”§ Config Embed",
      "type": "n8n-nodes-base.set",
      "position": [
        -2640,
        -208
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "4f212355-64b3-4ce6-b0ba-d5c9684d12b3",
              "name": "text",
              "type": "string",
              "value": "={{ $json._query }}"
            },
            {
              "id": "6335a7c9-976c-4404-a80b-1969dbb9d6f5",
              "name": "model",
              "type": "string",
              "value": "text-embedding-3-large"
            },
            {
              "id": "5676b77d-c38f-42c5-bb8b-7869c0344efe",
              "name": "dimensions",
              "type": "number",
              "value": "=3072"
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "472ff9d9-ddd5-455c-8b35-d1477feb8464",
      "name": "3ï¸âƒ£ Embeddings API",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2464,
        -208
      ],
      "parameters": {
        "url": "https://api.openai.com/v1/embeddings",
        "method": "POST",
        "options": {
          "timeout": 30000,
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        },
        "jsonBody": "={\n  \"model\": \"{{ $('ðŸ”§ Config Embed').item.json.model || 'text-embedding-3-large' }}\",\n  \"input\": {{ JSON.stringify($('ðŸ”§ Config Embed').item.json.text) }},\n  \"dimensions\": {{ $('ðŸ”§ Config Embed').item.json.dimensions || 3072 }}\n}",
        "sendBody": true,
        "specifyBody": "json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi"
      },
      "credentials": {
        "openAiApi": {
          "id": "",
          "name": ""
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "434d32ce-df75-425b-b21f-37051908521b",
      "name": "Sticky Embeddings",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2928,
        -80
      ],
      "parameters": {
        "width": 384,
        "height": 264,
        "content": "## ðŸ§® Embeddings\n\n**Settings in Config Embed:**\n- `model`: text-embedding-3-large\n- `dimensions`: 3072\n\n**Change model:**\nEdit ðŸ”§ Config Embed node\n\n**Credentials:**\nUses n8n OpenAI credential in 3ï¸âƒ£ Embeddings API"
      },
      "typeVersion": 1
    },
    {
      "id": "c67658c9-4b67-48e5-b782-e671ff1e4763",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "disabled": true,
      "position": [
        -3776,
        -32
      ],
      "parameters": {
        "options": {},
        "modelName": "models/gemini-2.5-pro"
      },
      "typeVersion": 1
    },
    {
      "id": "e3d0ce38-abd2-4cfd-afdc-671a661909db",
      "name": "Anthropic Chat Model2",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "disabled": true,
      "position": [
        -3760,
        -240
      ],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-opus-4-20250514",
          "cachedResultName": "Claude Opus 4"
        },
        "options": {}
      },
      "typeVersion": 1.3
    },
    {
      "id": "fac9a3b6-332b-4659-a975-59809bd0186f",
      "name": "OpenRouter Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "disabled": true,
      "position": [
        -3600,
        -240
      ],
      "parameters": {
        "options": {}
      },
      "typeVersion": 1
    },
    {
      "id": "e930de34-857f-4143-8719-370ea7ec0a82",
      "name": "LLM Models",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4304,
        -336
      ],
      "parameters": {
        "width": 904,
        "height": 528,
        "content": "## ðŸ§  Available AI Models\n\nConnect any model to LLM Chain nodes:\n\n- **OpenAI** â€” GPT-4o (default)\n- **Anthropic** â€” Claude 3.5\n- **Google Gemini** â€” Gemini Pro\n- **OpenRouter** â€” Multiple models\n- **xAI Grok** â€” Grok models\n\nModels are used for:\n- Header analysis\n- Category classification\n- Project type detection\n- Phase generation\n- Work decomposition\n- Validation"
      },
      "typeVersion": 1
    },
    {
      "id": "0a955ad6-e47e-40f5-94b2-ef964385af75",
      "name": "DeepSeek Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "disabled": true,
      "position": [
        -3936,
        -32
      ],
      "parameters": {
        "options": {}
      },
      "typeVersion": 1
    },
    {
      "id": "087db646-d3cb-4ba9-9072-f2e73bd81fc5",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4304,
        -1536
      ],
      "parameters": {
        "color": 6,
        "width": 320,
        "height": 448,
        "content": ""
      },
      "typeVersion": 1
    }
  ],
  "active": false,
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "21ec0f7e-063c-40c0-bbb0-19541e77ad6d",
  "connections": {
    "Acc": {
      "main": [
        [
          {
            "node": "Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agg": {
      "main": [
        [
          {
            "node": "Generate HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop": {
      "main": [
        [
          {
            "node": "ðŸ§¹ Prep Cleanup",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“ Prep Work Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final": {
      "main": [
        [
          {
            "node": "Prep HTML File",
            "type": "main",
            "index": 0
          },
          {
            "node": "ðŸ“¤ Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Lang Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Lang CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Works Updated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¤ Ask New Work",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Calc CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Excel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¤ Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "View Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Text LLM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ðŸ“¤ Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF PDF": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Send PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Menu": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Edit Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Works": {
      "main": [
        [
          {
            "node": "Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”‘ TOKEN": {
      "main": [
        [
          {
            "node": "Main",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate PDF": {
      "main": [
        [
          {
            "node": "IF PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Lang OK": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Lang OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "View Details": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML": {
      "main": [
        [
          {
            "node": "Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Text LLM": {
      "main": [
        [
          {
            "node": "ðŸ”§ Config Parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Works Updated": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Works Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Calc CB": {
      "main": [
        [
          {
            "node": "ðŸ“ Prep Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Lang CB": {
      "main": [
        [
          {
            "node": "Prep Lang OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Excel": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Send Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model 1": {
      "ai_languageModel": [
        [
          {
            "node": "ðŸ¤– AI Parse Text",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model 2": {
      "ai_languageModel": [
        [
          {
            "node": "ðŸ¤– AI Transform",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "ðŸ¤– AI Rerank",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prep HTML File": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Send HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¤ Send Work": {
      "main": [
        [
          {
            "node": "ðŸ’¾ Save Work Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– AI Rerank": {
      "main": [
        [
          {
            "node": "8ï¸âƒ£ Apply Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Š Show Works": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Send Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Progress ID": {
      "main": [
        [
          {
            "node": "Prep Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¤ Edit Result": {
      "main": [
        [
          {
            "node": "Acc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9ï¸âƒ£ Calculate": {
      "main": [
        [
          {
            "node": "ðŸ“Š Update Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger1": {
      "main": [
        [
          {
            "node": "ðŸ”‘ TOKEN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ Config Embed": {
      "main": [
        [
          {
            "node": "3ï¸âƒ£ Embeddings API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ Config Parse": {
      "main": [
        [
          {
            "node": "ðŸ¤– AI Parse Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– AI Transform": {
      "main": [
        [
          {
            "node": "2ï¸âƒ£ Extract Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ§¹ Prep Cleanup": {
      "main": [
        [
          {
            "node": "ðŸ—‘ï¸ Delete Work Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1ï¸âƒ£ Prep Query": {
      "main": [
        [
          {
            "node": "ðŸ”§ Config Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ’¾ Save Work Msg": {
      "main": [
        [
          {
            "node": "1ï¸âƒ£ Prep Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Š Update Result": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Edit Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Prep Progress": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Send Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Prep Work Msg": {
      "main": [
        [
          {
            "node": "ðŸ—‘ï¸ Delete Prev",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¤ Send Progress": {
      "main": [
        [
          {
            "node": "Save Progress ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ Config Rerank": {
      "main": [
        [
          {
            "node": "ðŸ¤– AI Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– AI Parse Text": {
      "main": [
        [
          {
            "node": "ðŸ“ Parse Text Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6ï¸âƒ£ Prep Rerank": {
      "main": [
        [
          {
            "node": "ðŸ”§ Config Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ—‘ï¸ Delete Prev": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Send Work",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8ï¸âƒ£ Apply Rerank": {
      "main": [
        [
          {
            "node": "9ï¸âƒ£ Calculate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5ï¸âƒ£ Qdrant Search": {
      "main": [
        [
          {
            "node": "6ï¸âƒ£ Prep Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ”§ Config Transform": {
      "main": [
        [
          {
            "node": "ðŸ¤– AI Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3ï¸âƒ£ Embeddings API": {
      "main": [
        [
          {
            "node": "4ï¸âƒ£ Extract Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ—‘ï¸ Delete Work Msg": {
      "main": [
        [
          {
            "node": "ðŸ—‘ï¸ Delete Progress Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Parse Text Response": {
      "main": [
        [
          {
            "node": "ðŸ“Š Show Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2ï¸âƒ£ Extract Transform": {
      "main": [
        [
          {
            "node": "ðŸ”§ Config Embed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4ï¸âƒ£ Extract Embedding": {
      "main": [
        [
          {
            "node": "5ï¸âƒ£ Qdrant Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ—‘ï¸ Delete Progress Msg": {
      "main": [
        [
          {
            "node": "Agg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}