{
  "id": "iDDUv4QXan1FQAx5",
  "meta": {
    "site": "https://github.com/zengfr/n8n-workflow-all-templates",
    "name": "AI Recruiter ‚Äì Analyze Multiple CVs vs Job Description using OpenAI GPT",
    "wechat": "youandme10086",
    "id": 10101,
    "update_time": "2025-11-10"
  },
  "name": "AI Recruiter ‚Äì Multi-CV Analyzer",
  "tags": [],
  "nodes": [
    {
      "id": "613e9242-0f92-40a4-a31b-2437c4d71c78",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -1808,
        16
      ],
      "webhookId": "2858c076-fe94-4920-a1e9-014b49b70dfe",
      "parameters": {
        "path": "chat-new",
        "options": {
          "allowedOrigins": "*"
        },
        "httpMethod": "POST",
        "responseMode": "responseNode"
      },
      "typeVersion": 2.1
    },
    {
      "id": "7f7a7318-cb2f-4c47-bc6f-108e307f04d1",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        1008,
        -128
      ],
      "parameters": {
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              }
            ]
          }
        },
        "respondWith": "allIncomingItems"
      },
      "typeVersion": 1.4
    },
    {
      "id": "6330221c-ec10-4c28-a05e-8a1c8640a3ad",
      "name": "AI Recruiter Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        432,
        -128
      ],
      "parameters": {
        "text": "=JD c·∫ßn tuy·ªÉn:\n{{ $json.jd }}\n\n---\n\nüéØ Nhi·ªám v·ª•:\nB·∫°n l√† AI Recruiter, c√≥ nhi·ªám v·ª• so s√°nh 1 JD v·ªõi nhi·ªÅu CV.  \nH√£y ƒë·ªçc v√† hi·ªÉu JD ·ªü tr√™n ƒë·ªÉ x√°c ƒë·ªãnh:\n- jd_position: T√™n v·ªã tr√≠ ho·∫∑c ch·ª©c danh c·∫ßn tuy·ªÉn.  \n- jd_domain: Ng√†nh ngh·ªÅ (K·∫ø to√°n, Nh√¢n s·ª±, ERP Technical, ERP Functional, S·∫£n xu·∫•t, H√†nh ch√°nh, v.v.)  \n- jd_function: M·∫£ng c√¥ng vi·ªác ch√≠nh (VD: H√†nh ch√≠nh t·ªïng h·ª£p, Tuy·ªÉn d·ª•ng, ERP System Integration...).\n\nSau ƒë√≥, h√£y ph√¢n t√≠ch t·ª´ng CV trong danh s√°ch d∆∞·ªõi ƒë√¢y:\n- Tr√≠ch xu·∫•t **t√™n ·ª©ng vi√™n th·∫≠t** t·ª´ ph·∫ßn header, ph·∫ßn ‚ÄúCurriculum Vitae‚Äù, ‚ÄúTh√¥ng tin c√° nh√¢n‚Äù ho·∫∑c c√°c ƒëo·∫°n ƒë·∫ßu.  \n- X√°c ƒë·ªãnh ƒë√∫ng ch·ª©c danh, ng√†nh ngh·ªÅ, k·ªπ nƒÉng, kinh nghi·ªám, vai tr√≤ c·ªßa ·ª©ng vi√™n (cv_position, cv_domain, cv_function).  \n- So s√°nh logic gi·ªØa JD v√† CV: n·∫øu kh√°c ng√†nh ho·∫∑c vai tr√≤ ‚Üí domain_match = false.  \n- T√≠nh fit_score d·ª±a tr√™n c√°c ti√™u ch√≠ domain, k·ªπ nƒÉng, kinh nghi·ªám, vai tr√≤.  \n- Vi·∫øt strengths, weaknesses, recommendation, v√† final_decision.  \n- M·ªçi d·ªØ li·ªáu ph·∫£i d·ª±a tr√™n vƒÉn b·∫£n th·∫≠t, **kh√¥ng ƒë∆∞·ª£c b·ªãa, suy di·ªÖn, ho·∫∑c ƒë·ªïi t√™n ·ª©ng vi√™n.**\n\n---\n\nüìÅ Danh s√°ch CV:\n{{ JSON.stringify($json.candidates) }}\n\n---\n\nüìå Quy t·∫Øc b·∫Øt bu·ªôc:\n\n1Ô∏è‚É£ N·∫øu CV c√≥ n·ªôi dung text ‚Üí tr√≠ch xu·∫•t **t√™n ·ª©ng vi√™n th·∫≠t** t·ª´ ph·∫ßn ƒë·∫ßu CV ho·∫∑c ph·∫ßn ‚ÄúTh√¥ng tin c√° nh√¢n‚Äù, ‚ÄúCurriculum Vitae‚Äù, ‚ÄúProfile‚Äù.  \n2Ô∏è‚É£ N·∫øu CV l√† file scan ho·∫∑c kh√¥ng c√≥ text ‚Üí l·∫•y t√™n t·ª´ **filename**, b·ªè ƒëi c√°c ph·∫ßn ‚ÄúCURRICULUM VITAE‚Äù, ‚ÄúCV‚Äù, ‚Äú_‚Äù, ‚Äú.pdf‚Äù, s·ªë th·ª© t·ª± ho·∫∑c k√Ω t·ª± th·ª´a.  \n   V√≠ d·ª•:\n   - \"CURRICULUM_VITAE_NGUYEN_THI_NGOC_PHUONG.pdf\" ‚Üí ‚ÄúNguy·ªÖn Th·ªã Ng·ªçc Ph∆∞∆°ng‚Äù  \n   - \"CV_HR_NguyenThiDiemKieu.pdf\" ‚Üí ‚ÄúNguy·ªÖn Th·ªã Di·ªÖm Ki·ªÅu‚Äù  \n3Ô∏è‚É£ Kh√¥ng ƒë∆∞·ª£c t·ª± b·ªãa t√™n nh∆∞ ‚ÄúNguy·ªÖn VƒÉn A‚Äù, ‚ÄúCandidate 1‚Äù, ‚ÄúNguy·ªÖn Th·ªã Lan‚Äù n·∫øu kh√¥ng c√≥ trong CV.  \n4Ô∏è‚É£ N·∫øu CV r·ªóng ‚Üí fit_score = 0, final_decision = \"Lo·∫°i\".  \n\n---\n\nüß≠ ONTOLOGY PH√ÇN LO·∫†I NGH·ªÄ & VAI TR√í:\n\n**1. Vai tr√≤ / role_match_type**\n- N·∫øu CV c√≥ c√°c cue: [\"Team Lead\", \"Team Leader\", \"Lead\", \"Manager\", \"Head of\", \"Tr∆∞·ªüng\", \"Qu·∫£n l√Ω\"] ‚Üí `\"role_match_type\": \"Manager\"`.\n- N·∫øu c√≥ cue k·ªπ thu·∫≠t: [\"ABAP\", \"Developer\", \"Coding\", \"Integration\", \"Interface\", \"PI/PO\", \"iFlow\", \"API\", \"Webservice\", \"Basis\", \"Technical Consultant\"] ‚Üí `\"role_match_type\": \"Technical\"`.\n- N·∫øu c√≥ cue nghi·ªáp v·ª• ERP: [\"Functional\", \"Consultant\", \"FI/CO\", \"MM\", \"SD\", \"PP\", \"QM\", \"WM\", \"EWM\", \"PM\", \"HR\", \"HCM\", \"FICO\"] ‚Üí `\"role_match_type\": \"Functional\"`.\n\n**2. Ng√†nh ngh·ªÅ / cv_domain**\n- N·∫øu c√≥ Manager cue ‚Üí ‚ÄúERP/IT Manager‚Äù\n- N·∫øu c√≥ Technical cue ‚Üí ‚ÄúCNTT/ERP Technical‚Äù\n- N·∫øu c√≥ Functional cue ‚Üí ‚ÄúCNTT/ERP Functional‚Äù\n- N·∫øu c√≥ HR/Recruitment/Admin cue: [\"HR\", \"Recruiter\", \"C&B\", \"Payroll\", \"H√†nh ch√≠nh\", \"Admin\"] ‚Üí ‚ÄúNh√¢n s·ª±‚Äù\n- N·∫øu c√≥ Accounting cue: [\"Accountant\", \"K·∫ø to√°n\", \"Chief Accountant\", \"GL\", \"Financial Reporting\", \"Cost\"] ‚Üí ‚ÄúK·∫ø to√°n‚Äù\n- N·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ‚Üí ‚ÄúKh√°c‚Äù\n\n**3. X·ª≠ l√Ω domain_match**\n- N·∫øu JD v√† CV kh√°c ng√†nh ‚Üí domain_match = false, fit_score ‚â§ 25.  \n- N·∫øu JD v√† CV c√πng ng√†nh nh∆∞ng kh√°c vai tr√≤ (Functional ‚Üî Technical) ‚Üí fit_score ‚â§ 60.  \n- N·∫øu CV l√† Manager trong c√πng domain ‚Üí fit_score = 70‚Äì90.  \n- Kh√¥ng cho fit_score = 100.  \n- Kh√¥ng ch·∫•m ƒëi·ªÉm n·∫øu kh√¥ng c√≥ n·ªôi dung th·ª±c t·∫ø.\n- So s√°nh logic gi·ªØa JD v√† CV:\n   + N·∫øu jd_domain v√† cv_domain gi·ªëng nhau (ho·∫∑c g·∫ßn nghƒ©a nh∆∞ ‚ÄúHR‚Äù ~ ‚ÄúNh√¢n s·ª±‚Äù) ‚Üí domain_match = true.\n   + N·∫øu kh√°c ng√†nh r√µ r√†ng ‚Üí domain_match = false.\n   + Tuy·ªát ƒë·ªëi kh√¥ng ƒë√°nh false khi hai gi√° tr·ªã gi·ªëng nhau v·ªÅ nghƒ©a.\n\n---\n\nüìä ƒê·ªãnh d·∫°ng ƒë·∫ßu ra (JSON Array, kh√¥ng gi·∫£i th√≠ch th√™m):\n\n[\n  {\n    \"candidate_name\": \"\",\n    \"fit_score\": 0,\n    \"jd_position\": \"\",\n    \"jd_domain\": \"\",\n    \"jd_function\": \"\",\n    \"cv_position\": \"\",\n    \"cv_domain\": \"\",\n    \"cv_function\": \"\",\n    \"domain_match\": false,\n    \"role_match_type\": \"\",\n    \"matched_keywords\": [],\n    \"strengths\": \"\",\n    \"weaknesses\": \"\",\n    \"recommendation\": \"\",\n    \"final_decision\": \"\",\n    \"cv_title\": \"\",\n    \"cv_roles\": [],\n    \"cv_years\": 0,\n    \"evidence\": []\n  }\n]\n\n---\n\nüìà K·∫øt lu·∫≠n:\n- N·∫øu kh√¥ng c√≥ CV n√†o fit_score ‚â• 70 ‚Üí `\"summary\": \"Kh√¥ng c√≥ h·ªì s∆° ph√π h·ª£p. ƒê·ªÅ xu·∫•t ch·ªçn CV kh√°c.\"`  \n- N·∫øu c√≥ ‚â•1 CV ƒë·ªß ƒëi·ªÅu ki·ªán ‚Üí `\"summary\": \"üèÜ ·ª®ng vi√™n xu·∫•t s·∫Øc nh·∫•t: [T√™n] ([ƒêi·ªÉm]%)\"`\n\n---\n\nüß± Ghi nh·ªõ:\n- Tuy·ªát ƒë·ªëi KH√îNG ƒë·ªïi t√™n ·ª©ng vi√™n.  \n- N·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c t√™n ‚Üí ƒë·ªÉ `\"candidate_name\": \"\"`.  \n- Kh√¥ng ƒë∆∞·ª£c t·∫°o ra ·ª©ng vi√™n gi·∫£ ho·∫∑c ƒëi·ªÅn th√¥ng tin kh√¥ng c√≥ trong CV.  \n- Khi ph√¢n lo·∫°i domain ho·∫∑c role, n·∫øu c√≥ b·∫±ng ch·ª©ng trong text (header, ch·ª©c danh, k·ªπ nƒÉng) th√¨ b·∫Øt bu·ªôc tr√≠ch ra v√†o `\"evidence\"`.\n- Kh√¥ng sinh ra k√Ω t·ª± r√°c nh∆∞ `\\\"`, `\\\\n`, ho·∫∑c c√°c k√Ω t·ª± ƒëi·ªÅu khi·ªÉn trong JSON.\n",
        "options": {
          "systemMessage": "üéØ M·ª§C TI√äU\nB·∫°n l√† AI Recruiter, c√≥ nhi·ªám v·ª• so s√°nh 1 JD v·ªõi nhi·ªÅu CV v√† ch·∫•m ƒëi·ªÉm m·ª©c ƒë·ªô ph√π h·ª£p.ra k·∫øt qu·∫£ ƒë√°nh gi√° logic, chi ti·∫øt v√† c√≥ ch·ª©ng c·ª© th·ª±c t·∫ø.\n\n‚ö†Ô∏è QUAN TR·ªåNG:\n- Lu√¥n tr·∫£ l·ªùi v√† m√¥ t·∫£ k·∫øt qu·∫£ b·∫±ng **ti·∫øng Vi·ªát**, k·ªÉ c·∫£ khi CV ho·∫∑c JD l√† ti·∫øng Anh.\n- Gi·ªØ nguy√™n t√™n, ch·ª©c danh, k·ªπ nƒÉng, thu·∫≠t ng·ªØ chuy√™n ng√†nh (v√≠ d·ª•: SAP, Integration, Webservice).\n- Kh√¥ng d·ªãch c√°c t·ª´ k·ªπ thu·∫≠t, nh∆∞ng m·ªçi ph·∫ßn nh·∫≠n x√©t, ƒëi·ªÉm m·∫°nh, ƒëi·ªÉm y·∫øu, g·ª£i √Ω ƒë·ªÅu vi·∫øt ti·∫øng Vi·ªát t·ª± nhi√™n, chuy√™n nghi·ªáp.\n\n---\n- X√°c ƒë·ªãnh ƒë√∫ng ng√†nh ngh·ªÅ c·ªßa JD (jd_domain) v√† t·ª´ng CV (cv_domain).\n- ƒê√°nh gi√° fit_score d·ª±a tr√™n m·ª©c tr√πng kh·ªõp ng√†nh, k·ªπ nƒÉng, kinh nghi·ªám v√† vai tr√≤ (role).\n- Ch·ªâ ƒë·ªÅ xu·∫•t ph·ªèng v·∫•n (final_decision = \"Interview\") khi fit_score ‚â• 70 v√† domain_match = true.\n\n---\n\n‚öôÔ∏è B∆Ø·ªöC 1 ‚Äî PH√ÇN LO·∫†I NG√ÄNH NGH·ªÄ (DOMAIN INFERENCE)\n\n1Ô∏è‚É£ jd_domain:\n   - Suy ra t·ª´ m√¥ t·∫£ JD: v·ªã tr√≠, k·ªπ nƒÉng, ch·ª©c danh, ng·ªØ c·∫£nh c√¥ng vi·ªác.\n   - N·∫øu JD ch·ª©a \"h√†nh ch√°nh\", \"h√†nh ch√≠nh\", \"admin\", \"office\" ‚Üí domain = Nh√¢n s·ª±.\n   - N·∫øu JD ch·ª©a \"kho\", \"th·ªß kho\", \"inventory\", \"warehouse\" ‚Üí domain = Logistics / Supply Chain.\n   - N·∫øu JD ch·ª©a \"QA\", \"QC\", \"KCS\", \"ch·∫•t l∆∞·ª£ng\" ‚Üí domain = S·∫£n xu·∫•t / Ch·∫•t l∆∞·ª£ng.\n\n2Ô∏è‚É£ cv_domain:\n   - Ch·ªâ d·ª±a tr√™n n·ªôi dung th·∫≠t c·ªßa CV, kh√¥ng ƒë∆∞·ª£c sao ch√©p t·ª´ JD.\n\nüìö JOB ONTOLOGY (C∆° s·ªü tri th·ª©c ng√†nh ngh·ªÅ)\n\n| V·ªã tr√≠ / Ch·ª©c danh m·∫´u | Ng√†nh ngh·ªÅ (domain) | Ch·ª©c nƒÉng (function) |\n|-------------------------|---------------------|----------------------|\n| Developer, ABAP, Integration, Technical Consultant | CNTT / ERP Technical | Ph√°t tri·ªÉn, k·ªπ thu·∫≠t h·ªá th·ªëng |\n| FI/MM/SD Functional Consultant, ERP Business Analyst | CNTT / ERP Functional | Ph√¢n t√≠ch nghi·ªáp v·ª• ERP |\n| ERP/IT Manager, Project Manager, Implementation Lead | ERP / IT Manager | Qu·∫£n l√Ω d·ª± √°n ERP |\n| K·∫ø to√°n, Chief Accountant, Cost Controller | K·∫ø to√°n | T√†i ch√≠nh, ghi s·ªï, b√°o c√°o |\n| Nh√¢n s·ª±, HR Admin, C&B, Payroll | Nh√¢n s·ª± | Tuy·ªÉn d·ª•ng, h√†nh ch√≠nh, l∆∞∆°ng th∆∞·ªüng |\n| Nh√¢n vi√™n h√†nh ch√°nh, Office Admin, Administrative Staff | Nh√¢n s·ª± | H√†nh ch√≠nh t·ªïng h·ª£p |\n| Nh√¢n vi√™n kho, Qu·∫£n l√Ω kho, Th·ªß kho | Logistics / Supply Chain | Qu·∫£n l√Ω t·ªìn kho, v·∫≠n h√†nh kho |\n| Nh√¢n vi√™n s·∫£n xu·∫•t, Qu·∫£n ƒë·ªëc, Gi√°m s√°t x∆∞·ªüng | S·∫£n xu·∫•t | Qu·∫£n l√Ω s·∫£n xu·∫•t |\n| QA, QC, KCS, Ki·ªÉm tra ch·∫•t l∆∞·ª£ng | S·∫£n xu·∫•t / Ch·∫•t l∆∞·ª£ng | ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng |\n| Nh√¢n vi√™n kinh doanh, Sales Executive, Account Manager | Kinh doanh | B√°n h√†ng, kh√°ch h√†ng |\n| Marketing, Digital Marketing | Marketing | Th∆∞∆°ng hi·ªáu, qu·∫£ng b√° |\n| Qu·∫£n l√Ω d·ª± √°n, Director, General Manager | Qu·∫£n l√Ω | L·∫≠p k·∫ø ho·∫°ch, ƒëi·ªÅu h√†nh |\n| Kh√°c | Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c ng√†nh ngh·ªÅ | Kh√°c (Other) |\n\n---\n\nüß† B∆Ø·ªöC 2 ‚Äî LOGIC DOMAIN MATCH\n\n| Tr∆∞·ªùng h·ª£p | domain_match | fit_score t·ªëi ƒëa | Ghi ch√∫ |\n|-------------|--------------|------------------|----------|\n| JD = K·∫ø to√°n, CV = CNTT/ERP | ‚ùå | 25 | Sai ng√†nh |\n| JD = Technical, CV = Functional (ho·∫∑c ng∆∞·ª£c l·∫°i) | ‚úÖ | 60 | C√πng ERP kh√°c vai tr√≤ |\n| JD = ERP Technical, CV = ERP/IT Manager | ‚úÖ | 90 | Qu·∫£n l√Ω c√πng ng√†nh |\n| JD = Nh√¢n s·ª±, CV = H√†nh ch√°nh | ‚úÖ | 75 | G·∫ßn nghƒ©a |\n| JD = S·∫£n xu·∫•t, CV = QA/QC | ‚úÖ | 70 | C√πng kh·ªëi s·∫£n xu·∫•t |\n| Kh√¥ng r√µ ng√†nh | ‚ùå | 25 | Thi·∫øu d·ªØ li·ªáu |\n\n---\n\nüìä B∆Ø·ªöC 3 ‚Äî QUY T·∫ÆC CH·∫§M ƒêI·ªÇM (SCORING)\n\n1. fit_score = 0 (ban ƒë·∫ßu)\n2. domain_match = true ‚Üí +50\n3. matched_keywords t·ª´ JD xu·∫•t hi·ªán trong CV ‚Üí +10‚Äì30\n4. C√≥ ‚â•3 nƒÉm kinh nghi·ªám ‚Üí +10\n5. Vai tr√≤ Manager/Lead c√πng ng√†nh ‚Üí +10\n6. domain_match = false ‚Üí fit_score ‚â§ 25\n7. fit_score t·ªëi ƒëa 95 (kh√¥ng bao gi·ªù 100)\n\n---\n\nüîç B∆Ø·ªöC 4 ‚Äî B·∫∞NG CH·ª®NG (EVIDENCE)\n\nM·ªói ·ª©ng vi√™n ph·∫£i c√≥:\n{\n  \"cv_title\": \"ERP Manager\",\n  \"cv_roles\": [\"ERP Manager\", \"Technical Lead\"],\n  \"cv_years\": 8,\n  \"evidence\": [\n    \"ERP Manager t·∫°i c√¥ng ty ABC, qu·∫£n l√Ω tri·ªÉn khai SAP\",\n    \"Kinh nghi·ªám 8 nƒÉm v·ªÅ ABAP, Integration, Webservice\"\n  ]\n}\nN·∫øu kh√¥ng c√≥ ch·ª©ng c·ª© r√µ r√†ng ‚Üí domain_match = false, fit_score ‚â§ 25, final_decision = \"Lo·∫°i\".\n\n---\n\nüß± B∆Ø·ªöC 5 ‚Äî CH·ªêNG NHI·ªÑM JD (ANTI-LEAK)\n\n- Kh√¥ng d√πng t·ª´ kh√≥a trong JD ƒë·ªÉ x√°c ƒë·ªãnh cv_domain, strengths ho·∫∑c matched_keywords.  \n- N·∫øu c·ª•m ch·ªâ c√≥ trong JD m√† kh√¥ng c√≥ trong CV ‚Üí KH√îNG ƒë∆∞·ª£c ƒë∆∞a v√†o matched_keywords.  \n- M·ªçi ph√°n ƒëo√°n ph·∫£i d·ª±a tr√™n **n·ªôi dung c√≥ th·∫≠t trong CV**.\n\n---\n\nüß© B∆Ø·ªöC 6 ‚Äî QUY T·∫ÆC CU·ªêI\n\n- fit_score kh√¥ng ƒë∆∞·ª£c = 0 (tr·ª´ CV tr·ªëng).  \n- N·∫øu c√πng ng√†nh kh√°c vai tr√≤ ‚Üí fit_score ‚â§ 60.  \n- Kh√¥ng cho fit_score = 100.  \n- role_match_type ‚àà {\"Functional\", \"Technical\", \"Manager\"}.\n\n---\n\nüìã B∆Ø·ªöC 7 ‚Äî OUTPUT JSON\n\n{\n  \"candidate_name\": \"\",\n  \"fit_score\": 0,\n  \"jd_position\": \"\",\n  \"jd_domain\": \"\",\n  \"jd_function\": \"\",\n  \"cv_position\": \"\",\n  \"cv_domain\": \"\",\n  \"cv_function\": \"\",\n  \"domain_match\": false,\n  \"role_match_type\": \"\",\n  \"matched_keywords\": [],\n  \"strengths\": \"\",\n  \"weaknesses\": \"\",\n  \"recommendation\": \"\",\n  \"final_decision\": \"\",\n  \"cv_title\": \"\",\n  \"cv_roles\": [],\n  \"cv_years\": 0,\n  \"evidence\": []\n}\n\n---\n\nüßÆ B∆Ø·ªöC 8 ‚Äî K·∫æT LU·∫¨N SAU X·ª¨ L√ù\n\n- N·∫øu kh√¥ng c√≥ CV n√†o fit_score ‚â• 70 ‚Üí ‚Äúsummary‚Äù: ‚ÄúKh√¥ng c√≥ h·ªì s∆° ph√π h·ª£p. ƒê·ªÅ xu·∫•t ch·ªçn CV kh√°c.‚Äù  \n- N·∫øu c√≥ ‚â•1 CV ƒë·ªß ƒëi·ªÅu ki·ªán ‚Üí ‚Äúsummary‚Äù: ‚ÄúüèÜ ·ª®ng vi√™n xu·∫•t s·∫Øc nh·∫•t: [T√™n] ([ƒêi·ªÉm]%)‚Äù.\n\n---\n\nüß† M·ª§C TI√äU CU·ªêI  \nƒê·∫£m b·∫£o m√¥ h√¨nh hi·ªÉu v√† suy lu·∫≠n ƒë∆∞·ª£c:\n- ERP Manager ‚â† K·∫ø to√°n  \n- Functional ‚â† Technical  \n- Nh√¢n s·ª± ‚âà H√†nh ch√°nh  \n- QA/QC ‚âà S·∫£n xu·∫•t  \n- JD kh√¥ng lan sang CV  \n- Ph√¢n lo·∫°i ngh·ªÅ nghi·ªáp ch√≠nh x√°c theo ontology tr√™n.\n"
        },
        "promptType": "define"
      },
      "typeVersion": 2.2
    },
    {
      "id": "b417a559-5741-410e-ad42-89d88cd63f31",
      "name": "Parse Recruiter Output",
      "type": "n8n-nodes-base.code",
      "position": [
        784,
        -128
      ],
      "parameters": {
        "jsCode": "// Parse Recruiter Output - Tie-breaker only (no bonus to fit_score)\ntry {\n  let raw = $json.output || $json;\n\n  // N·∫øu AI tr·∫£ v·ªÅ {output:\"[...json...]\"} th√¨ l·∫•y ph·∫ßn b√™n trong\n  if (typeof raw === 'object' && raw.output) raw = raw.output;\n\n  // L√†m s·∫°ch chu·ªói JSON n·∫øu c·∫ßn\n  if (typeof raw === 'string') {\n    const match = raw.match(/\\[\\s*{[\\s\\S]*}\\s*\\]/);\n    if (match) raw = match[0];\n    raw = raw.trim().replace(/^[\\uFEFF\\x00-\\x1F]+/, '');\n  }\n\n  // Th·ª≠ parse JSON (k·ªÉ c·∫£ khi b·ªã double-encode)\n  let parsed;\n  try {\n    parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;\n  } catch (innerErr) {\n    parsed = JSON.parse(JSON.parse(raw));\n  }\n\n  // Chu·∫©n h√≥a th√†nh m·∫£ng\n  const arr = Array.isArray(parsed) ? parsed : [parsed];\n  if (!arr.length) throw new Error(\"Kh√¥ng c√≥ d·ªØ li·ªáu ·ª©ng vi√™n h·ª£p l·ªá\");\n\n  // Helpers\n  const norm = (s) => (s || '').toLowerCase().trim();\n  const domEq = (cv) => norm(cv.cv_domain) && norm(cv.jd_domain) && norm(cv.cv_domain) === norm(cv.jd_domain);\n  const domNear = (cv) => {\n    const a = norm(cv.cv_domain), b = norm(cv.jd_domain);\n    if (!a || !b) return false;\n    return a.includes(b) || b.includes(a);\n  };\n  const kwLen = (cv) => Array.isArray(cv.matched_keywords) ? cv.matched_keywords.length : 0;\n  const years = (cv) => Number(cv.cv_years || 0);\n\n  // ƒê·ªìng b·ªô nh√£n hi·ªÉn th·ªã v√† auto-fix domain_match n·∫øu AI sai\n  const candidates = arr.map(cv => {\n    const c = { ...cv };\n    // Role match label = ƒë√∫ng domain CV (kh√¥ng ‚ÄúOther‚Äù c·ª©ng)\n    c.role_match_label = (c.cv_domain || '').trim() || 'Kh√¥ng x√°c ƒë·ªãnh';\n\n    // Auto-fix: n·∫øu domain b·∫±ng nhau m√† domain_match = false th√¨ s·ª≠a th√†nh true\n    if (domEq(c) && c.domain_match === false) c.domain_match = true;\n\n    return c;\n  });\n\n  // T·ªïng v√† danh s√°ch ƒë·∫°t chu·∫©n\n  const total = candidates.length;\n  const qualified = candidates.filter(cv => (cv.fit_score || 0) >= 70);\n\n  // Comparator ch·ªçn ·ª©ng vi√™n t·ªët nh·∫•t:\n  // 1) fit_score cao h∆°n th·∫Øng\n  // 2) N·∫øu b·∫±ng nhau: domain = JD th·∫Øng\n  // 3) N·∫øu v·∫´n b·∫±ng nhau: domain g·∫ßn JD th·∫Øng\n  // 4) N·∫øu v·∫´n b·∫±ng nhau: nhi·ªÅu matched_keywords h∆°n th·∫Øng\n  // 5) N·∫øu v·∫´n b·∫±ng nhau: cv_years nhi·ªÅu h∆°n th·∫Øng\n  const better = (a, b) => {\n    const fa = Number(a.fit_score || 0);\n    const fb = Number(b.fit_score || 0);\n    if (fa !== fb) return fa > fb ? a : b;\n\n    const aEq = domEq(a), bEq = domEq(b);\n    if (aEq !== bEq) return aEq ? a : b;\n\n    const aNear = domNear(a), bNear = domNear(b);\n    if (aNear !== bNear) return aNear ? a : b;\n\n    const aKw = kwLen(a), bKw = kwLen(b);\n    if (aKw !== bKw) return aKw > bKw ? a : b;\n\n    const aY = years(a), bY = years(b);\n    if (aY !== bY) return aY > bY ? a : b;\n\n    return a; // gi·ªØ nguy√™n th·ª© t·ª± n·∫øu v·∫´n h√≤a\n  };\n\n  const best = candidates.reduce((acc, cv) => acc ? better(acc, cv) : cv, null);\n\n  // Summary lu√¥n d√πng fit_score ‚Äúg·ªëc‚Äù (kh√¥ng c·ªông th∆∞·ªüng)\n  const summary_text =\n    best && (best.fit_score || 0) >= 70\n      ? `üèÜ ·ª®ng vi√™n ƒëi·ªÉm ƒë√°nh gi√° cao nh·∫•t: ${best.candidate_name || \"(Kh√¥ng x√°c ƒë·ªãnh)\"} (${best.fit_score}%)`\n      : `Kh√¥ng c√≥ h·ªì s∆° ph√π h·ª£p. ƒê·ªÅ xu·∫•t t√¨m th√™m ·ª©ng vi√™n kh√°c.`;\n\n  return [{\n    json: {\n      total_candidates: total,\n      qualified_candidates: qualified.length,\n      best_candidate: best?.candidate_name || \"\",\n      best_score: best?.fit_score || 0,\n      summary_text,\n      candidates\n    }\n  }];\n\n} catch (err) {\n  return [{\n    json: {\n      error: \"JSON_PARSE_FAILED\",\n      message: err.message,\n      raw_snippet: String($json.output || '').slice(0, 500)\n    }\n  }];\n}\n"
      },
      "typeVersion": 2,
      "alwaysOutputData": true
    },
    {
      "id": "d87866a2-c309-45dc-9d6f-187eda5caac0",
      "name": "List_File",
      "type": "n8n-nodes-base.code",
      "position": [
        -1584,
        16
      ],
      "parameters": {
        "jsCode": "const body = $json.body || {};\nconst jd = body.message || \"JD ch∆∞a x√°c ƒë·ªãnh\";\nconst files = Array.isArray(body.files) ? body.files : [];\n\nreturn files.map((f, i) => ({\n  json: {\n    jd,\n    index: i + 1,\n    filename: f.name || `file_${i + 1}.pdf`,\n    base64: (f.data || \"\").split(\",\")[1] || \"\",\n  }\n}));\n"
      },
      "typeVersion": 2
    },
    {
      "id": "32e65a79-c7e0-4f75-8f7b-72226f4f166e",
      "name": "Detect PDF Type",
      "type": "n8n-nodes-base.code",
      "position": [
        -1360,
        16
      ],
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Detect PDF type: text-based or scanned image\n\n// L·∫•y th√¥ng tin c∆° b·∫£n\nconst jd = $json.jd || \"JD ch∆∞a x√°c ƒë·ªãnh\";\nconst index = $json.index || 1;\nconst filename = $json.filename || `cv_${index}.pdf`;\nconst base64 = $json.base64 || \"\";\n\n// N·∫øu kh√¥ng c√≥ base64 th√¨ b·ªè qua\nif (!base64) {\n  return {\n    json: {\n      jd,\n      index,\n      filename,\n      base64: null,\n      pdf_type: \"unknown\",\n      note: \"‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu base64 ƒë·ªÉ ki·ªÉm tra.\"\n    }\n  };\n}\n\ntry {\n  // Chuy·ªÉn base64 ‚Üí text ƒë·ªÉ d√≤ n·ªôi dung readable\n  const pdfBuffer = Buffer.from(base64, \"base64\");\n  const text = pdfBuffer.toString(\"utf8\");\n\n  // Regex ki·ªÉm tra xem c√≥ ƒëo·∫°n text ƒë·ªçc ƒë∆∞·ª£c hay kh√¥ng\n  const hasReadableText = /[A-Za-z√Ä-·ªπ0-9]{3,}/.test(text);\n  const pdf_type = hasReadableText ? \"text\" : \"scan\";\n\n  return {\n    json: {\n      jd,\n      index,\n      filename,\n      base64, // üëà Gi·ªØ l·∫°i base64 ƒë·ªÉ node sau c√≤n d√πng\n      pdf_type,\n      note: hasReadableText\n        ? \"‚úÖ PDF c√≥ l·ªõp text, ƒë·ªçc ƒë∆∞·ª£c.\"\n        : \"‚ö†Ô∏è PDF d·∫°ng ·∫£nh, kh√¥ng c√≥ l·ªõp text.\"\n    }\n  };\n\n} catch (err) {\n  return {\n    json: {\n      jd,\n      index,\n      filename,\n      base64, // v·∫´n gi·ªØ ƒë·ªÉ debug khi l·ªói\n      pdf_type: \"error\",\n      note: \"‚ùå L·ªói khi ƒë·ªçc base64: \" + err.message\n    }\n  };\n}\n"
      },
      "typeVersion": 2
    },
    {
      "id": "4c49c7f6-7657-4453-985c-bc378849a09e",
      "name": "If",
      "type": "n8n-nodes-base.if",
      "position": [
        -1136,
        16
      ],
      "parameters": {
        "options": {},
        "conditions": {
          "options": {
            "version": 1,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "603e402b-0f8c-4c51-a550-49f4564ad0cb",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "",
              "rightValue": ""
            }
          ]
        },
        "looseTypeValidation": "=={{ $json[\"pdf_type\"] === \"text\" }}"
      },
      "typeVersion": 2.2,
      "alwaysOutputData": true
    },
    {
      "id": "64cdfed3-cba0-490b-8119-e90a3273632b",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        504,
        96
      ],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "PzDD1MSeg2N7SDe0",
          "name": "OpenAi account 2"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "471ff4c6-bb44-45b8-bc9c-c8ef9e0aea45",
      "name": "Extract from File",
      "type": "n8n-nodes-base.extractFromFile",
      "position": [
        -464,
        -128
      ],
      "parameters": {
        "options": {},
        "operation": "pdf"
      },
      "executeOnce": false,
      "typeVersion": 1,
      "alwaysOutputData": true
    },
    {
      "id": "508b522e-4eee-4104-9703-f3f4097d4ac9",
      "name": "Convert Base64 to Binary",
      "type": "n8n-nodes-base.code",
      "position": [
        -912,
        16
      ],
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Convert base64 ‚Üí Binary cho t·ª´ng CV\n\nconst base64 = $json.base64 || \"\";\nconst jd = $json.jd || \"JD ch∆∞a x√°c ƒë·ªãnh\";\nconst index = $json.index || 1;\nconst filename = $json.filename || `cv_${index}.pdf`;\n\n// N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu base64 th√¨ b·ªè qua\nif (!base64) {\n  return {\n    json: {\n      jd,\n      index,\n      filename,\n      note: \"‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu base64 ƒë·ªÉ convert.\"\n    }\n  };\n}\n\nreturn {\n  json: {\n    jd,\n    index,\n    filename\n  },\n  binary: {\n    data: {\n      data: Buffer.from(base64, \"base64\"),\n      mimeType: \"application/pdf\",\n      fileName: filename\n    }\n  }\n};\n"
      },
      "typeVersion": 2
    },
    {
      "id": "e9e7a983-9130-4f12-bfc5-c0d4163172c3",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        -688,
        16
      ],
      "parameters": {
        "options": {}
      },
      "typeVersion": 3
    },
    {
      "id": "1f286db8-2495-4359-9db0-7d0a60c61201",
      "name": "Replace Me",
      "type": "n8n-nodes-base.noOp",
      "position": [
        -464,
        64
      ],
      "parameters": {},
      "typeVersion": 1
    },
    {
      "id": "4cbf8ff2-9884-46f9-b21d-207a880392f7",
      "name": "Reattach_Metadata_After_Extract",
      "type": "n8n-nodes-base.code",
      "position": [
        -240,
        -128
      ],
      "parameters": {
        "jsCode": "// Node: Reattach_Metadata_After_Extract (b·∫£n n√¢ng c·∫•p full logic)\n// T√°c d·ª•ng: G·∫Øn l·∫°i jd, filename, text, v√† t·ª± ƒë·ªçc candidate_name, candidate_position, role_match_type\n\nconst extracted = $input.all(); // K·∫øt qu·∫£ t·ª´ Extract From File\nconst srcItems = $items(\"Convert Base64 to Binary\", 0); // D·ªØ li·ªáu g·ªëc c√≥ jd, filename, index\n\n// ====== H√ÄM TI·ªÜN √çCH ======\nconst normalize = (s) => (s || \"\").replace(/\\s+/g, \" \").trim();\n\nconst cleanName = (name) => {\n  return name\n    .replace(/[^\\p{L}\\s]/gu, \"\")\n    .replace(/\\s+/g, \" \")\n    .trim()\n    .replace(/\\b(\\p{L})/gu, (m) => m.toUpperCase());\n};\n\nreturn extracted.map((ex, i) => {\n  const src = (srcItems[i] && srcItems[i].json) ? srcItems[i].json : {};\n  const text = ex.json?.text || \"\";\n  const lines = text.split(/\\n/).map(l => l.trim()).filter(Boolean);\n  const header = lines.slice(0, 5).join(\" \");\n\n  let candidateName = \"\";\n  let candidatePosition = \"\";\n  let roleMatchType = \"Other\";\n\n  // ====== 1Ô∏è‚É£ X√ÅC ƒê·ªäNH T√äN ·ª®NG VI√äN ======\n  // D·∫°ng ƒë·∫ßy ƒë·ªß: \"Nguyen Thi Ngoc Phuong\"\n  const fullNameRegex = /\\b([A-Zƒê][a-z√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒëƒê]{1,}\\s){1,4}[A-Zƒê][a-z√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒëƒê]{2,}/gu;\n  const matchName = header.match(fullNameRegex);\n  if (matchName) candidateName = cleanName(matchName[0]);\n\n  // D·∫°ng vi·∫øt t·∫Øt: N.T.K.Di·ªÖm, L.T.M.Trinh\n  if (!candidateName) {\n    const abbr = header.match(/[A-Z]\\.[A-Z]\\.[A-Z]\\.[A-Za-z√Ä-·ªπ]{2,}/);\n    if (abbr) candidateName = abbr[0].replace(/\\./g, \" \").trim();\n  }\n\n  // T√™n n·∫±m trong ‚ÄúTh√¥ng Tin C√° Nh√¢n‚Äù ho·∫∑c ‚ÄúH·ªç v√† T√™n‚Äù\n  if (!candidateName) {\n    const infoBlock = text.match(/(H·ªç\\s*v√†\\s*t√™n|Th√¥ng\\s*Tin\\s*C√°\\s*Nh√¢n)[\\s\\S]{0,150}/i);\n    if (infoBlock) {\n      const found = infoBlock[0].match(fullNameRegex);\n      if (found) candidateName = cleanName(found[0]);\n    }\n  }\n\n  // ====== 2Ô∏è‚É£ X√ÅC ƒê·ªäNH CH·ª®C DANH (V·ªä TR√ç) ======\n  const roleRegex = /(Team\\s*Leader|Manager|Consultant|Specialist|Developer|Engineer|Officer|Supervisor|Coordinator|Executive|Director|Leader|Nh√¢n\\s*vi√™n\\s*[^\\n,;]+|Chuy√™n\\s*vi√™n\\s*[^\\n,;]+|Tr∆∞·ªüng\\s*[^\\n,;]+|Gi√°m\\s*s√°t\\s*[^\\n,;]+)/i;\n  const matchRole = text.match(roleRegex);\n  if (matchRole) candidatePosition = normalize(matchRole[0]);\n\n  // ====== 3Ô∏è‚É£ PH√ÇN LO·∫†I role_match_type ======\n  if (/Manager|Director|Tr∆∞·ªüng/i.test(candidatePosition)) roleMatchType = \"Manager\";\n  else if (/Consultant|Functional|Analyst|Specialist|Officer/i.test(candidatePosition)) roleMatchType = \"Functional\";\n  else if (/Developer|Technical|Engineer|Programmer|Basis/i.test(candidatePosition)) roleMatchType = \"Technical\";\n  else if (/Admin|H√†nh\\s*ch√°nh|Nh√¢n\\s*s·ª±/i.test(candidatePosition)) roleMatchType = \"Admin\";\n  else roleMatchType = \"Other\";\n\n  // ====== 4Ô∏è‚É£ K·∫æT QU·∫¢ ======\n  return {\n    json: {\n      jd: src.jd ?? null,\n      index: src.index ?? (i + 1),\n      filename: src.filename ?? ex?.binary?.data?.fileName ?? null,\n      text,\n      info: ex.json?.info ?? {},\n      candidate_name: candidateName || null,\n      candidate_position: candidatePosition || null,\n      role_match_type: roleMatchType\n    }\n  };\n});\n"
      },
      "typeVersion": 2
    },
    {
      "id": "c664f25b-3f3c-446e-832c-8a7df09334b4",
      "name": "Combine_Candidates_For_AI",
      "type": "n8n-nodes-base.code",
      "position": [
        -16,
        -128
      ],
      "parameters": {
        "jsCode": "// --- Combine_Candidates_For_AI ---\n// Gom t·∫•t c·∫£ c√°c CV th√†nh m·∫£ng candidates[] ƒë·ªÉ AI Agent ƒë·ªçc\n// ƒê·ªìng th·ªùi t·ª± ƒë·ªông l·∫•y d√≤ng t√™n ƒë·∫ßu ti√™n trong CV (v√≠ d·ª•: \"N.T.K.Di·ªÖm\", \"L.T.M.Trinh\")\n\nfunction extractRawName(text = \"\") {\n  if (!text) return \"\";\n\n  const lines = text\n    .replace(/\\r/g, \"\")\n    .replace(/\\t/g, \" \")\n    .split(\"\\n\")\n    .map(l => l.trim())\n    .filter(l => l && l.length > 1)\n    .slice(0, 8); // ch·ªâ xem v√†i d√≤ng ƒë·∫ßu ti√™n\n\n  // B·ªè qua c√°c d√≤ng ch·ª©a c·ª•m t·ª´ ‚ÄúTh√¥ng tin c√° nh√¢n‚Äù, ‚ÄúCV‚Äù, ‚ÄúS∆° y·∫øu l√Ω l·ªãch‚Äù, ‚ÄúCurriculum Vitae‚Äù\n  const skip = /(th√¥ng tin|s∆° y·∫øu|curriculum vitae|cv|profile)/i;\n  const filtered = lines.filter(l => !skip.test(l));\n\n  // L·∫•y d√≤ng ƒë·∫ßu ti√™n h·ª£p l·ªá (gi·ªØ nguy√™n format, kh√¥ng s·ª≠a g√¨)\n  return filtered.length ? filtered[0] : \"\";\n}\n\nreturn [\n  {\n    json: {\n      jd: $items(\"Reattach_Metadata_After_Extract\")[0].json.jd,\n      candidates: $items(\"Reattach_Metadata_After_Extract\").map(item => {\n        const text = item.json.text || \"\";\n        const nameFromText = extractRawName(text);\n\n        return {\n          filename: item.json.filename,\n          // ∆Øu ti√™n t√™n tr√≠ch t·ª´ text, n·∫øu r·ªóng m·ªõi l·∫•y t√™n c≈©\n          candidate_name: nameFromText || item.json.candidate_name || \"\",\n          candidate_position: item.json.candidate_position || \"\",\n          role_match_type: item.json.role_match_type || \"Other\",\n          text\n        };\n      })\n    }\n  }\n];\n"
      },
      "typeVersion": 2
    },
    {
      "id": "f249f3d8-524e-4e46-97a9-5577fde7a46b",
      "name": "Preprocess_CV_Names",
      "type": "n8n-nodes-base.code",
      "position": [
        208,
        -128
      ],
      "parameters": {
        "jsCode": "// --- Node: Preprocess_CV_Names ---\n// M·ª•c ti√™u: l·∫•y ƒë√∫ng d√≤ng ƒë·∫ßu ti√™n (t√™n th√¥ trong CV), b·ªè qua c√°c d√≤ng nh∆∞ \"Th√¥ng tin c√° nh√¢n\", \"CV\", \"S∆° y·∫øu l√Ω l·ªãch\".\n// Kh√¥ng ƒë·ªïi hoa/th∆∞·ªùng, kh√¥ng b·ªè d·∫•u, kh√¥ng b·ªè d·∫•u ch·∫•m.\n\nfunction extractRawName(text = \"\") {\n  if (!text) return \"\";\n\n  const lines = text\n    .replace(/\\r/g, \"\")\n    .replace(/\\t/g, \" \")\n    .split(\"\\n\")\n    .map(l => l.trim())\n    .filter(l => l && l.length > 1)\n    .slice(0, 8); // ch·ªâ qu√©t v√†i d√≤ng ƒë·∫ßu CV\n\n  // B·ªè qua d√≤ng ch·ª©a \"Th√¥ng tin c√° nh√¢n\", \"CV\", \"Curriculum Vitae\"...\n  const skip = /(th√¥ng tin|s∆° y·∫øu|curriculum vitae|cv|profile)/i;\n  const filtered = lines.filter(l => !skip.test(l));\n\n  // L·∫•y d√≤ng ƒë·∫ßu ti√™n c√≤n l·∫°i (gi·ªØ nguy√™n xi)\n  return filtered.length ? filtered[0] : \"\";\n}\n\nreturn $input.all().map(item => {\n  const t = item.json.text || \"\";\n  const name = extractRawName(t);\n\n  // Debug xem ƒë·ªçc ra g√¨\n  console.log(\"üìÑ File:\", item.json.filename, \"‚Üí Name:\", name);\n\n  return {\n    json: {\n      ...item.json,\n      // √âp c·∫≠p nh·∫≠t l·∫°i t√™n, KH√îNG fallback\n      candidate_name: name,\n    },\n  };\n});\n"
      },
      "typeVersion": 2
    },
    {
      "id": "f8aff173-8caf-428a-8aae-e5ac8203edb5",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1920,
        -368
      ],
      "parameters": {
        "height": 320,
        "content": "üü© Step 1: Upload Files (JD + CVs)\n- Webhook node receives one JD and multiple CV files.\n- List_File node extracts filenames and base64 data.\n- Detect PDF Type node determines whether each file is text-based or scanned.\n\n"
      },
      "typeVersion": 1
    },
    {
      "id": "c3c11827-e7f5-4753-914a-cf1a312fc5e3",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -784,
        -368
      ],
      "parameters": {
        "height": 304,
        "content": "üü® Step 2: Extract & Merge Text\n- Convert Base64 to Binary ‚Üí prepares each CV for text extraction.\n- Extract From File ‚Üí extracts readable text from PDF.\n- Reattach_Metadata_After_Extract ‚Üí restores JD, filename, and candidate metadata.\n- Combine_Candidates_For_AI ‚Üí aggregates all CVs into a single candidates[] array.\n"
      },
      "typeVersion": 1
    },
    {
      "id": "7e966941-fecf-4a79-ac74-104abe8cf9c5",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        416,
        -464
      ],
      "parameters": {
        "height": 288,
        "content": "üü¶ Step 3: AI Analysis & Output\n- AI Recruiter Agent compares JD vs. each CV and generates structured insights (fit_score, strengths, weaknesses, recommendation).\n- Parse Recruiter Output selects the top candidate and builds a summary.\n- Respond to Webhook returns the full JSON result to chat UI or external API.\n\n"
      },
      "typeVersion": 1
    }
  ],
  "active": true,
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "95b2d7aa-89a3-4007-8960-a8f4dd2d158e",
  "connections": {
    "If": {
      "main": [
        [
          {
            "node": "Convert Base64 to Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "List_File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List_File": {
      "main": [
        [
          {
            "node": "Detect PDF Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect PDF Type": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Reattach_Metadata_After_Extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Recruiter Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Recruiter Agent": {
      "main": [
        [
          {
            "node": "Parse Recruiter Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        []
      ]
    },
    "Preprocess_CV_Names": {
      "main": [
        [
          {
            "node": "AI Recruiter Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Recruiter Output": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Base64 to Binary": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine_Candidates_For_AI": {
      "main": [
        [
          {
            "node": "Preprocess_CV_Names",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reattach_Metadata_After_Extract": {
      "main": [
        [
          {
            "node": "Combine_Candidates_For_AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}