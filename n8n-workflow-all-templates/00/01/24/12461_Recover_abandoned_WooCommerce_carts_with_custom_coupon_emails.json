{
  "id": "hAFQqzrBpAXS0LwD",
  "meta": {
    "site": "https://github.com/zengfr/n8n-workflow-all-templates",
    "name": "Recover abandoned WooCommerce carts with custom coupon emails",
    "wechat": "youandme10086",
    "id": 12461,
    "update_time": "2026-02-13"
  },
  "name": "Recover abandoned carts with custom coupons for WooCommerce",
  "tags": [
    {
      "id": "",
      "name": "",
      "createdAt": "2025-09-09T19:46:50.767Z",
      "updatedAt": "2025-09-09T19:46:50.767Z"
    }
  ],
  "nodes": [
    {
      "id": "49fbfe38-6c4d-4d98-8bee-6f3cbed260ee",
      "name": "No Operation, do nothing1",
      "type": "n8n-nodes-base.noOp",
      "position": [
        0,
        0
      ],
      "parameters": {},
      "typeVersion": 1
    },
    {
      "id": "9dffd428-e03e-4aaa-bef0-c9356dfd4c95",
      "name": "Fetching Cart Contents",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -1024,
        80
      ],
      "webhookId": "fde986cf-7c26-42e9-885d-cb44ee305863",
      "parameters": {
        "path": "fde986cf-7c26-42e9-885d-cb44ee305863",
        "options": {},
        "httpMethod": "POST"
      },
      "typeVersion": 2
    },
    {
      "id": "da6a3a81-4495-4b9a-acc9-9d756cb4f243",
      "name": "Waiting Time",
      "type": "n8n-nodes-base.wait",
      "position": [
        -848,
        80
      ],
      "webhookId": "4721cf57-a939-46f1-bcb8-1dd85412a143",
      "parameters": {
        "unit": "minutes",
        "amount": 15
      },
      "typeVersion": 1.1
    },
    {
      "id": "0a19f77e-d3b2-41e8-8a61-6be83fd536b7",
      "name": "Fetching If Customer has placed order",
      "type": "n8n-nodes-base.wooCommerce",
      "position": [
        -656,
        80
      ],
      "parameters": {
        "limit": 10,
        "options": {
          "after": "={{ $('Fetching Cart Contents').item.json.body.arg.timestamp }}",
          "search": "={{ $json.body.arg.customer_id }}",
          "status": "completed"
        },
        "resource": "order",
        "operation": "getAll"
      },
      "credentials": {
        "wooCommerceApi": {
          "id": "3GgviDcfZZLbbl5i",
          "name": "WooCommerce account"
        }
      },
      "typeVersion": 1,
      "alwaysOutputData": true
    },
    {
      "id": "f60a0edc-d6c3-40cf-8c56-7e469aff6faa",
      "name": "If, There's a Order Placed",
      "type": "n8n-nodes-base.if",
      "position": [
        -224,
        80
      ],
      "parameters": {
        "options": {},
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "137f38ed-baa4-4027-b4a1-9fad50c94ca5",
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "leftValue": "={{ $node[\"Set Default Order Data\"].json.length }}",
              "rightValue": "=0"
            }
          ]
        },
        "looseTypeValidation": true
      },
      "typeVersion": 2.2
    },
    {
      "id": "fa08116b-5b16-4d35-a500-d5674fd9210b",
      "name": "Abandoned Cart Recovery Email",
      "type": "n8n-nodes-base.emailSend",
      "position": [
        720,
        192
      ],
      "webhookId": "dc08939a-a98d-43a8-ae1f-71835ed27309",
      "parameters": {
        "html": "={{ $json.email_html }}",
        "options": {
          "appendAttribution": false
        },
        "subject": "=Greetings! You left [Your Product Name] in your cart! ",
        "toEmail": "={{ $('Set Default Order Data').item.json.body.arg.billing_email }}",
        "fromEmail": ""
      },
      "credentials": {
        "smtp": {
          "id": "YmfND4stCynWOORm",
          "name": "SMTP"
        }
      },
      "typeVersion": 2.1
    },
    {
      "id": "152ac14f-ba84-4f0f-b413-7f53a37414fa",
      "name": "Set Default Order Data",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        80
      ],
      "parameters": {
        "jsCode": "try {\n  // Get input data from WooCommerce node\n  const inputData = $input.first() || {};\n  // Get original webhook payload from Fetching Cart Contents\n  const webhookData = $node[\"Fetching Cart Contents\"].json || {};\n  // Log input for debugging\n  console.log('Input to Set Default Order Data: ' + JSON.stringify(inputData, null, 2));\n  console.log('Webhook Data: ' + JSON.stringify(webhookData, null, 2));\n  // Extract and validate orders\n  let orders = inputData.json;\n  if (orders === undefined || orders === null || typeof orders !== 'object') {\n    orders = [];\n  } else if (!Array.isArray(orders)) {\n    console.log('Invalid data format, forcing empty array');\n    orders = [];\n  }\n  // Merge webhook data with orders\n  const output = {\n    orders: orders,\n    ...webhookData // Preserve original payload fields\n  };\n  // Return normalized data\n  return [{ json: output }];\n} catch (error) {\n  console.log('Error in Set Default Order Data: ' + error.message);\n  return [{ json: { orders: [] } }];\n}"
      },
      "typeVersion": 2
    },
    {
      "id": "b7aaf7e2-acb5-4fc5-b995-695ad788faa6",
      "name": "Generate Unique Coupon Code",
      "type": "n8n-nodes-base.code",
      "position": [
        0,
        192
      ],
      "parameters": {
        "jsCode": "// --- CONFIGURATION SECTION ---\nconst CONFIG = {\n    COUPON_PREFIX: '',       // Specify the Coupon Code Phrase here\n    EXPIRY_MINUTES: 30,      // Time until expiry\n    TIMEZONE: 'UTC'          // CHANGE THIS: 'Asia/Kolkata', 'America/New_York', 'UTC', etc.\n};\n\n// --- COUPON GENERATION LOGIC ---\nconst customerId = $input.first().json.body.arg.customer_id;\n\n// Generate base number (0-1000) based on ID and current timestamp\nlet baseNumber = Math.floor(Math.abs(parseInt(customerId + Date.now().toString().slice(-6))) % 1000 + 1);\nlet codeNumber = ('000' + baseNumber).slice(-3);\nlet finalCode = CONFIG.COUPON_PREFIX + codeNumber;\n\n// Handle collisions\nlet usedCodes = $json.usedCodes || [];\nwhile (usedCodes.includes(finalCode)) {\n    baseNumber = (baseNumber % 1000) + 1;\n    codeNumber = ('000' + baseNumber).slice(-3);\n    finalCode = CONFIG.COUPON_PREFIX + codeNumber;\n}\nusedCodes.push(finalCode);\n\n// --- TIME CALCULATION LOGIC ---\n\n// 1. Calculate the exact expiry moment (Current Time + Expiry Minutes)\nconst now = new Date();\nconst expiryDate = new Date(now.getTime() + CONFIG.EXPIRY_MINUTES * 60000);\n\n// 2. Format: \"HH:mm\" (e.g., \"19:09\") based on TARGET TIMEZONE\nconst expiryTime = expiryDate.toLocaleTimeString('en-GB', {\n    timeZone: CONFIG.TIMEZONE,\n    hour12: false,\n    hour: '2-digit',\n    minute: '2-digit'\n});\n\n// 3. Format: \"YYYY-MM-DD HH:mm:ss\" based on TARGET TIMEZONE\n// We use the 'sv-SE' (Swedish) locale hack, which naturally formats dates as ISO 8601 (YYYY-MM-DD)\nconst dateExpires = expiryDate.toLocaleString('sv-SE', {\n    timeZone: CONFIG.TIMEZONE,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit'\n}).replace('T', ' ');\n\nreturn [{\n    json: {\n        code: finalCode,\n        usedCodes: usedCodes,\n        customer_id: customerId,\n        expiry_time: expiryTime,   // Local time in HH:mm\n        date_expires: dateExpires, // Full timestamp YYYY-MM-DD HH:mm:ss\n        timezone: CONFIG.TIMEZONE  // Helpful for debugging\n    }\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "554fc78c-2c70-441a-9a8a-6cab7006d139",
      "name": "Create Abandoned Cart Coupon (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        240,
        192
      ],
      "parameters": {
        "url": "",
        "method": "POST",
        "options": {},
        "jsonBody": "={\n  \"code\": \"{{ $json.code }}\",\n  \"discount_type\": \"percent\",\n  \"amount\": \"5\",\n  \"date_expires\": \"{{ $json.date_expires }}\",\n  \"individual_use\": true,\n  \"usage_limit\": 1,\n  \"usage_limit_per_user\": 1,\n  \"customer_id\": \"{{ $('Set Default Order Data').item.json.body.arg.customer_id }}\",\n\"meta_data\": [\n    {\n      \"key\": \"expiry_time\",\n      \"value\": \"{{ $json.expiry_time }}\"\n    }\n  ]\n}",
        "sendBody": true,
        "specifyBody": "json",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wooCommerceApi"
      },
      "credentials": {
        "wooCommerceApi": {
          "id": "3GgviDcfZZLbbl5i",
          "name": "WooCommerce account"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "fb2119a3-91fb-4910-82d9-bb8cd139e5d8",
      "name": "Generate Email HTML",
      "type": "n8n-nodes-base.code",
      "position": [
        480,
        192
      ],
      "parameters": {
        "jsCode": "// --- CONFIGURATION SECTION ---\nconst CONFIG = {\n    TIMEZONE: 'UTC',        // CHANGE THIS: 'Asia/Kolkata', 'America/New_York', 'UTC', etc.\n    CURRENCY_SYMBOL: '',   // CHANGE THIS: '$', '€', '£', etc.\n    LOCALE_FORMAT: 'en-US'  // CHANGE THIS: 'en-GB', 'en-US' (for number formatting)\n};\n\n// --- DATA EXTRACTION ---\nconst inputData = $input.first().json;\n\n// Safe navigation for inputs (defaults provided if missing)\nconst cartContents = $('Set Default Order Data').first().json.body.arg.cart_contents || [];\nconst billingEmail = $('Set Default Order Data').first().json.body.arg.billing_email || '';\nconst cartTotal = $('Set Default Order Data').first().json.body.arg.cart_total || '0.00';\n\n// --- TIMESTAMP LOGIC (LOCALE AWARE) ---\n// If timestamp is missing, generate current time in the Configured Timezone\nlet currentTimestamp;\nif ($('Set Default Order Data').first().json.body.arg.timestamp) {\n    currentTimestamp = $('Set Default Order Data').first().json.body.arg.timestamp;\n} else {\n    // Generate ISO-like format (YYYY-MM-DD HH:mm:ss) respecting the CONFIG.TIMEZONE\n    currentTimestamp = new Date().toLocaleString('sv-SE', {\n        timeZone: CONFIG.TIMEZONE,\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit',\n        hour: '2-digit',\n        minute: '2-digit',\n        second: '2-digit'\n    }).replace('T', ' ');\n}\nconst timestamp = currentTimestamp;\n\n// Retrieve Coupon Data (Ensure these nodes exist in your workflow)\nconst couponCode = $node[\"Generate Unique Coupon Code\"].json.code; \nconst dateExpires = $node[\"Create Abandoned Cart Coupon (HTTP)\"].json.date_expires;\n// Note: Ensure meta_data[0] actually exists in your previous node's output\nconst expiryTime = $node[\"Create Abandoned Cart Coupon (HTTP)\"].json.meta_data && $node[\"Create Abandoned Cart Coupon (HTTP)\"].json.meta_data[0] \n    ? $node[\"Create Abandoned Cart Coupon (HTTP)\"].json.meta_data[0].value \n    : '';\n\n// --- CALCULATIONS ---\n// Calculate discount (5%) and total\nconst discount = (parseFloat(cartTotal) * 0.05).toFixed(2);\nconst totalWithDiscount = (parseFloat(cartTotal) - parseFloat(discount)).toFixed(2);\n\n// --- DYNAMIC HTML GENERATION ---\nlet tableRows = '';\ncartContents.forEach(item => {\n    // Use CONFIG.CURRENCY_SYMBOL here\n    tableRows += `\n        <tr>\n            <td style=\"padding: 15px; border-bottom: 1px solid #e5e5e5; vertical-align: top\">\n                <img src=\"${item.image_url || 'https:'}\" alt=\"${item.name || 'Item'}\" style=\"width: 80px; display: block;\" />\n            </td>\n            <td style=\"padding: 15px; border-bottom: 1px solid #e5e5e5; font-family: Helvetica, Arial, sans-serif; font-size: 14px; color: #333333; vertical-align: top\">${item.name || 'Unnamed Item'}</td>\n            <td style=\"padding: 15px; border-bottom: 1px solid #e5e5e5; text-align: center; font-family: Helvetica, Arial, sans-serif; font-size: 14px; color: #333333; vertical-align: top\">${item.quantity || '1'}</td>\n            <td style=\"padding: 15px; border-bottom: 1px solid #e5e5e5; text-align: right; font-family: Helvetica, Arial, sans-serif; font-size: 14px; color: #333333; vertical-align: top\">${CONFIG.CURRENCY_SYMBOL}${item.price || '0.00'}</td>\n        </tr>\n    `;\n});\n\n// Construct checkout URL\nconst baseUrl = \"\"; // Replace with your actual domain\nconst cartUrl = couponCode ? `${baseUrl}/cart/?coupon=${couponCode}` : `${baseUrl}/cart/`;\n\n// --- EMAIL CONTENT ---\n// You can now use variables: ${timestamp}, ${formattedTotal}, ${tableRows}, etc.\n// HTML Version (Add Your Mail's HTML Code)\nconst htmlContent = `\n    \n`;\n\n// Plain Text Version (Fallback) (Add Fallback Text)\n\nreturn [{\n    json: {\n        email_html: htmlContent,\n        email_text: textContent,\n        meta: {\n            timestamp: timestamp,\n            timezone: CONFIG.TIMEZONE,\n            currency: CONFIG.CURRENCY_SYMBOL\n        }\n    }\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "18f67ec7-d8ee-4626-b52d-d1de37d5aaed",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1856,
        -304
      ],
      "parameters": {
        "width": 480,
        "height": 1392,
        "content": "# Recover abandoned carts with custom coupons for WooCommerce\n\n\nThis n8n workflow helps you recover lost sales opportunities by automatically sending personalized emails with a customized coupon to your customers who leave the website after adding products to their carts without completing checkout.\n\n\n## How it works :\n\n-  Webhook Trigger:  Webhook receives complete cart details from WooCommerce the moment any customer adds an item to the cart.\n\n- Verification of Order: It waits for the specified wait time and then checks through the WooCommerce API node to see if the customer has actually completed the purchase during that window.\n\n- Coupon Generation: If no order is found, a Code node generates a unique, custom coupon code with a custom expiry time (e.g., 30 minutes).\n\n-  Coupon Creation on Website: An HTTP Request node registers this new coupon directly into your WooCommerce store via the REST API.\n\n-  Email Composition: A Code node fetches all information extracted and converts it into an HTML email template.\n\n-  Sending Emails: Finally, the SMTP node sends the personalized recovery mail to the customer's email address.\n\n## Setup Steps :\n\n1. Set up your WooCommerce Account Credentials in n8n\n2. Set up Webhook in n8n & WooCommerce\n3. Add the provided code in functions.php or as a PHP snippet via a plugin in your website\n4. Customize the coupon code's phrase according to your needs\n5.  Customize the email's HTML code according to your needs\n\n\n## Requirements :\n\n- WooCommerce Store: With WooCommerce REST API access enabled.\n\n- SMTP Credentials: For sending recovery emails.\n\n\n## Need Help?\n\n[Schedule a 1:1 Troubleshooting Call](https://cal.com/mattakshitij/workflow-troubleshoot) or [Ping me on X](https://x.com/matta_kshitij)\n\nHappy Automating :)\n"
      },
      "typeVersion": 1
    },
    {
      "id": "e184c052-e398-4b02-bd6d-ed5669afceaf",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1264,
        -256
      ],
      "parameters": {
        "color": 7,
        "width": 384,
        "height": 288,
        "content": "## 1. Configuring webhook in n8n and WooCommerce\n\nSet up the webhook path and configure it in WooCommerce. Follow the given steps:\n- Go to WooCommerce Settings > Advanced > Webhook\n- Create a webhook and select Topic as Action and Action Event as woocommerce_add_to_cart\n- Add Webhook URL configured in n8n in the Delivery URL field\n"
      },
      "typeVersion": 1
    },
    {
      "id": "7480b529-059b-4033-9dd8-1250a5c44fda",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -960,
        304
      ],
      "parameters": {
        "color": 3,
        "width": 448,
        "height": 368,
        "content": "##  2. Add the provided code to your WP (WooCommerce) website to enable the features of fetching cart details and coupon code customization\n\n** This PHP Code Snippet needs to be added in either the functions.php code of your theme or can be added via code snippet plugins like HFCM, which enables code to run on all pages of the website.\n\n- Access the code from [here](https://pastebin.com/tp0yFSRN)\n- Add it to your WordPress (WooCommerce) website"
      },
      "typeVersion": 1
    },
    {
      "id": "fbc9567b-45b0-47a5-b283-c4a35938719c",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -160,
        384
      ],
      "parameters": {
        "color": 7,
        "width": 416,
        "height": 304,
        "content": "## 3. Customize the coupon code according to your needs\n\n- In COUPON_PREFIX, you need to set the phrase of the coupon, for example, your coupon to be HELLOxxx, then you need to put it in HELLO.\n- In EXPIRY_MINUTES, set the time in minutes for which the coupon should be active.\n- In TIMEZONE, you need to set the timezone acc. to your WP website's Timezone\n"
      },
      "typeVersion": 1
    },
    {
      "id": "286eb849-4c3a-46fc-9736-ec79a21054fa",
      "name": "Sticky Note4",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        368,
        -208
      ],
      "parameters": {
        "color": 7,
        "width": 336,
        "height": 352,
        "content": "## 4. Customize email HTML according to your needs\n\n\n- Add HTML Code and set the variables defined in it to fetch values dynamically.\n\n- In TIMEZONE, you need to set the timezone according to your WP website's Timezone\n\n- CURRENCY_SYMBOL Add the symbol of the currency used in your store\n\n"
      },
      "typeVersion": 1
    }
  ],
  "active": false,
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5edef004-513b-4325-ac0e-8b1722d61556",
  "connections": {
    "Waiting Time": {
      "main": [
        [
          {
            "node": "Fetching If Customer has placed order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Email HTML": {
      "main": [
        [
          {
            "node": "Abandoned Cart Recovery Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetching Cart Contents": {
      "main": [
        [
          {
            "node": "Waiting Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Default Order Data": {
      "main": [
        [
          {
            "node": "If, There's a Order Placed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If, There's a Order Placed": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Unique Coupon Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Unique Coupon Code": {
      "main": [
        [
          {
            "node": "Create Abandoned Cart Coupon (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Abandoned Cart Coupon (HTTP)": {
      "main": [
        [
          {
            "node": "Generate Email HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetching If Customer has placed order": {
      "main": [
        [
          {
            "node": "Set Default Order Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}