{
  "id": "aZU2RbdXlp3eXCZh",
  "meta": {
    "site": "https://github.com/zengfr/n8n-workflow-all-templates",
    "name": "Food Image Analysis for Calorie Estimation with Vision AI and Telegram",
    "wechat": "youandme10086",
    "id": 9619,
    "update_time": "2025-11-10"
  },
  "name": "Infer Ingredients from a Food Image and Estimate Calories",
  "tags": [],
  "nodes": [
    {
      "id": "agent1",
      "name": "AI Agent - é£Ÿæåˆ†æ",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        752,
        400
      ],
      "parameters": {
        "text": "=ã‚ãªãŸã¯æ–™ç†ã¨æ „é¤Šã®å°‚é–€å®¶ã§ã™ã€‚æä¾›ã•ã‚ŒãŸæ–™ç†ã®ç”»åƒã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ï¼š\n\n1. æ–™ç†å\n2. æ¨å®šã•ã‚Œã‚‹ä¸»ãªé£Ÿæã¨ãã®åˆ†é‡ï¼ˆã‚°ãƒ©ãƒ ï¼‰\n3. å„é£Ÿæã®ã‚«ãƒ­ãƒªãƒ¼\n4. åˆè¨ˆæ¨å®šã‚«ãƒ­ãƒªãƒ¼\n5. æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®ç°¡å˜ãªè©•ä¾¡\n\nç”»åƒURL: {{ $json.message.photo[0].file_id }}",
        "options": {
          "systemMessage": "ä»¥ä¸‹ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæ–™ç†ã®æƒ…å ±ã‚’åˆ†æã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n1.  **å½¹å‰²:** æ–™ç†ãƒ¬ã‚·ãƒ”ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼\n2.  **å…¥åŠ›:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ–™ç†åã‚„é£Ÿæã«é–¢ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ\n3.  **å‡¦ç†:**\n    *   æ–™ç†åã‚’ç‰¹å®šã™ã‚‹ã€‚\n    *   é£Ÿæãƒªã‚¹ãƒˆã‚’æŠ½å‡ºã—ã€å„é£Ÿæã®ã€Œåå‰(name)ã€ã€Œåˆ†é‡(amount)ã€ã€Œã‚«ãƒ­ãƒªãƒ¼(calories)ã€ã‚’ç‰¹å®šã™ã‚‹ã€‚åˆ†é‡ã¨ã‚«ãƒ­ãƒªãƒ¼ã¯ä¸€èˆ¬çš„ãªå€¤ã‚’æ¨å®šã—ã¦ã‚‚ã‚ˆã„ã€‚\n    *   å…¨é£Ÿæã®ã‚«ãƒ­ãƒªãƒ¼ã‚’åˆè¨ˆã—ã€ã€Œåˆè¨ˆã‚«ãƒ­ãƒªãƒ¼(totalCalories)ã€ã‚’è¨ˆç®—ã™ã‚‹ã€‚\n    *   è¨ˆç®—çµæœã«åŸºã¥ãã€ã€Œæ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡(nutritionEvaluation)ã€ã‚’ä½œæˆã™ã‚‹ã€‚\n4.  **å‡ºåŠ›:** ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å³å¯†ã«å¾“ã£ãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›ã™ã‚‹ã€‚\n    *   `dishName`: string\n    *   `ingredients`: array of objects\n        *   `name`: string\n        *   `amount`: number (å˜ä½: g)\n        *   `calories`: number (å˜ä½: kcal)\n    *   `totalCalories`: number (å˜ä½: kcal)\n    *   `nutritionEvaluation`: string\n5.  **æ³¨æ„:**\n    *   å‡ºåŠ›ã«JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæŒ¨æ‹¶ã€èª¬æ˜ãªã©ï¼‰ã‚’å«ã‚ãªã„ã§ãã ã•ã„ã€‚\n    *   JSONã®ã‚­ãƒ¼åã¯æŒ‡å®šé€šã‚Šã«ã—ã¦ãã ã•ã„ã€‚"
        },
        "promptType": "define",
        "hasOutputParser": true
      },
      "typeVersion": 2
    },
    {
      "id": "parser1",
      "name": "Structured Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        912,
        608
      ],
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"dishName\": {\n      \"type\": \"string\",\n      \"description\": \"æ–™ç†å\"\n    },\n    \"ingredients\": {\n      \"type\": \"array\",\n      \"description\": \"é£Ÿæãƒªã‚¹ãƒˆ\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"string\",\n            \"description\": \"é£Ÿæå\"\n          },\n          \"amount\": {\n            \"type\": \"number\",\n            \"description\": \"åˆ†é‡ï¼ˆã‚°ãƒ©ãƒ ï¼‰\"\n          },\n          \"calories\": {\n            \"type\": \"number\",\n            \"description\": \"ã‚«ãƒ­ãƒªãƒ¼ï¼ˆkcalï¼‰\"\n          }\n        }\n      }\n    },\n    \"totalCalories\": {\n      \"type\": \"number\",\n      \"description\": \"åˆè¨ˆã‚«ãƒ­ãƒªãƒ¼ï¼ˆkcalï¼‰\"\n    },\n    \"nutritionEvaluation\": {\n      \"type\": \"string\",\n      \"description\": \"æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡\"\n    }\n  },\n  \"required\": [\"dishName\", \"ingredients\", \"totalCalories\", \"nutritionEvaluation\"]\n}"
      },
      "typeVersion": 1.2
    },
    {
      "id": "52bb2509-5870-4f4c-96ea-c607548b15b1",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "position": [
        480,
        400
      ],
      "webhookId": "f6a51604-9b18-4756-a50e-1e5eb1f8da6f",
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {
          "download": true
        }
      },
      "credentials": {
        "telegramApi": {
          "id": "Ikb8BOl71y5C8wqu",
          "name": "Telegram account"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "a8ee11fd-47bc-4524-89a5-a19380041613",
      "name": "OpenRouter Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "position": [
        608,
        608
      ],
      "parameters": {
        "model": "openai/gpt-5-mini",
        "options": {
          "temperature": 0.3
        }
      },
      "credentials": {
        "openRouterApi": {
          "id": "fMR5QJezr3tD108w",
          "name": "ç°¡æ˜“ãƒ‡ãƒ¢"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "7397c3e2-c057-4f6b-9afa-010b0a610789",
      "name": "Format for Gmail",
      "type": "n8n-nodes-base.code",
      "position": [
        1152,
        400
      ],
      "parameters": {
        "jsCode": "// AI Agentã‹ã‚‰å‡ºåŠ›ã•ã‚ŒãŸJSONå½¢å¼ã®æ–™ç†åˆ†æçµæœã‚’å–å¾—ã—ã¾ã™ã€‚\nconst analysisResult = $input.first().json.output;\n\n// çµæœãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯æœŸå¾…ã—ãŸå½¢å¼ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®å‡¦ç†\nif (!analysisResult || !analysisResult.dishName) {\n  return [{\n    json: {\n      subject: \"æ–™ç†åˆ†æã‚¨ãƒ©ãƒ¼\",\n      htmlBody: \"<p>AIã«ã‚ˆã‚‹åˆ†æçµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>\"\n    }\n  }];\n}\n\n// 1. ãƒ¡ãƒ¼ãƒ«ã®ä»¶åã‚’ä½œæˆ\nconst subject = `ã€æ–™ç†åˆ†æãƒ¬ãƒãƒ¼ãƒˆã€‘ ${analysisResult.dishName}`;\n\n// 2. HTMLãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã‚’ç”Ÿæˆ\nlet htmlBody = `\n<!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f9f9f9; margin: 0; padding: 0; }\n    .container { max-width: 600px; margin: 20px auto; padding: 25px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }\n    h1 { font-size: 26px; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 0; }\n    h2 { font-size: 20px; color: #e74c3c; margin-bottom: 15px; }\n    h3 { font-size: 18px; color: #34495e; margin-top: 30px; border-bottom: 1px solid #eeeeee; padding-bottom: 8px;}\n    p { margin-top: 0; color: #555; }\n    table { width: 100%; border-collapse: collapse; margin-top: 15px; }\n    th, td { text-align: left; padding: 12px; border-bottom: 1px solid #dddddd; }\n    th { background-color: #f2f2f2; color: #333; }\n    tr:last-child td { border-bottom: none; }\n    .total-calories { text-align: center; background-color: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; }\n    .evaluation { background-color: #eafaf1; padding: 15px; border-left: 5px solid #2ecc71; border-radius: 5px; margin-top: 20px;}\n    .footer { text-align: center; margin-top: 25px; font-size: 12px; color: #999; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h1>${analysisResult.dishName}</h1>\n    \n    <div class=\"total-calories\">\n      <h2>åˆè¨ˆæ¨å®šã‚«ãƒ­ãƒªãƒ¼: ${analysisResult.totalCalories} kcal</h2>\n    </div>\n\n    <h3>è©³ç´°ãªé£Ÿæãƒªã‚¹ãƒˆ</h3>\n    <table>\n      <thead>\n        <tr>\n          <th>é£Ÿæå</th>\n          <th>åˆ†é‡ (g)</th>\n          <th>ã‚«ãƒ­ãƒªãƒ¼ (kcal)</th>\n        </tr>\n      </thead>\n      <tbody>\n`;\n\n// å„é£Ÿæã®æƒ…å ±ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã¨ã—ã¦è¿½åŠ \nif (analysisResult.ingredients && analysisResult.ingredients.length > 0) {\n  analysisResult.ingredients.forEach(ingredient => {\n    htmlBody += `\n        <tr>\n          <td>${ingredient.name}</td>\n          <td>${ingredient.amount}</td>\n          <td>${ingredient.calories}</td>\n        </tr>\n    `;\n  });\n}\n\nhtmlBody += `\n      </tbody>\n    </table>\n\n    <h3>æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡</h3>\n    <div class=\"evaluation\">\n      <p>${analysisResult.nutritionEvaluation}</p>\n    </div>\n\n    <div class=\"footer\">\n      <p>ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\n// 3. å¾Œç¶šã®Gmailãƒãƒ¼ãƒ‰ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™\nreturn [{\n  json: {\n    subject: subject,\n    htmlBody: htmlBody\n  }\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "ae0d956b-599d-4bba-b14b-67245e3287fb",
      "name": "Send a message1",
      "type": "n8n-nodes-base.gmail",
      "position": [
        1408,
        400
      ],
      "webhookId": "b0128308-fba0-4291-996d-e38ac9edaed4",
      "parameters": {
        "sendTo": "t.minamig20@gmail.com",
        "message": "={{ $json.htmlBody }}",
        "options": {
          "appendAttribution": false
        },
        "subject": "={{ $json.subject }}"
      },
      "credentials": {
        "gmailOAuth2": {
          "id": "qEtK64Ero6pOyPe0",
          "name": "Gmail account 16"
        }
      },
      "typeVersion": 2.1
    },
    {
      "id": "9be8d7fb-d689-41bb-b638-755bddd7a618",
      "name": "Sticky 1: Overview",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -16,
        80
      ],
      "parameters": {
        "color": 5,
        "width": 520,
        "height": 260,
        "content": "## ğŸ—’ï¸ Sticky 1: Overview\n**What this template does**\n- Accepts a **food image** and runs **AI-based ingredient inference** â†’ **calorie estimation** â†’ **concise summary**\n- Input can be an **image URL** or **Base64 image** (via Webhook or a messaging app)\n\n**Why itâ€™s useful**\n- Quickly generates a calorie rough estimate and a short nutrition comment for logging, sharing, or feedback loops\n\n**No hardcoded secrets**\n- All API keys must be set via **Credentials/Environment Variables** (never hardcode keys in nodes)"
      },
      "typeVersion": 1
    },
    {
      "id": "0bd3d0eb-a030-4d79-a390-17e41d705f7e",
      "name": "Sticky 2: Prerequisites",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        608,
        -16
      ],
      "parameters": {
        "color": 4,
        "width": 520,
        "height": 280,
        "content": "## ğŸ—’ï¸ Sticky 2: Prerequisites & Credentials\n**Connections**\n- LLM (OpenAI or compatible) with **vision** capability\n- One input channel (Webhook **or** Telegram/LINE, etc.)\n\n**Environment Variables (examples)**\n- `LLM_MODEL` (e.g., `gpt-4o` or any vision-capable model)\n- `LLM_TEMPERATURE` (e.g., `0.3`)\n- `WEBHOOK_SECRET` (optional, if you validate requests)\n\n**Scopes / Permissions**\n- If image URLs are external, ensure they are publicly accessible or use signed/temporary URLs"
      },
      "typeVersion": 1
    },
    {
      "id": "ff6d1495-3223-4305-a354-57a22adf71f3",
      "name": "Sticky 3: Input Format",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -144,
        560
      ],
      "parameters": {
        "color": 2,
        "width": 520,
        "height": 300,
        "content": "## ğŸ—’ï¸ Sticky 3: Input Format (Sample)\n**Expected JSON**\n```json\n{\n  \"imageUrl\": \"https://example.com/dish.jpg\"\n  // or\n  // \"imageBase64\": \"data:image/jpeg;base64,....\"\n}\n```\n**Notes**\n- Template assumes **one image** per request (extend with arrays for multiple images)\n- If you receive platform-specific payloads (e.g., Telegram `file_id`, LINE message objects), **normalize** them first to `imageUrl` or `imageBase64` before calling the LLM"
      },
      "typeVersion": 1
    },
    {
      "id": "1bd2ee7d-a5f9-42f4-9974-4698fb05b553",
      "name": "Sticky 4: Model & Prompt",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        528,
        864
      ],
      "parameters": {
        "color": 3,
        "width": 520,
        "height": 260,
        "content": "## ğŸ—’ï¸ Sticky 4: Model & Prompt Policy\n**Model**\n- Use a **vision-capable** LLM (e.g., `gpt-4o`)\n- Keep `temperature` low (0.2â€“0.3) for stable outputs\n\n**Prompt Rules**\n- The model must return **strict JSON only**, with the fields below (no extra text)\n- Keep names concise (e.g., \"grilled chicken\", \"white rice\", \"mixed salad\")\n- Provide amounts in grams when possible (estimates are fine)"
      },
      "typeVersion": 1
    },
    {
      "id": "84f0f90c-e819-4022-a76e-b63353ca9968",
      "name": "Sticky 5: Output Schema",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1184,
        -16
      ],
      "parameters": {
        "width": 520,
        "height": 280,
        "content": "## ğŸ—’ï¸ Sticky 5: Output Schema (Fixed)\n**JSON structure**\n```json\n{\n  \"dishName\": \"string\",\n  \"ingredients\": [\n    { \"name\": \"string\", \"amount\": 0, \"calories\": 0 }\n  ],\n  \"totalCalories\": 0,\n  \"nutritionEvaluation\": \"string\"\n}\n```\n**Validation**\n- If fields are empty/missing, route to an **error branch** and return a helpful message for the user"
      },
      "typeVersion": 1
    },
    {
      "id": "fe6e558b-4f6a-4c0a-9b06-e3939b07be3f",
      "name": "Sticky 6: Test Steps",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1200,
        816
      ],
      "parameters": {
        "color": 5,
        "width": 520,
        "height": 220,
        "content": "## ğŸ—’ï¸ Sticky 6: Test Steps (Under 1 Minute)\n1) Turn on the **Webhook** node and copy the **Test URL**\n2) Send a sample payload with a valid `imageUrl`\n3) Confirm the run returns the **strict JSON** structure\n4) If using Telegram/Slack replies, authenticate and send a test message to verify delivery"
      },
      "typeVersion": 1
    },
    {
      "id": "24bbd216-9c8b-4a4f-b446-dd82585117fd",
      "name": "Sticky 7: Errors & Limits",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1696,
        0
      ],
      "parameters": {
        "color": 4,
        "width": 520,
        "height": 260,
        "content": "## ğŸ—’ï¸ Sticky 7: Error Handling & Limits\n**Retries**\n- For LLM calls, implement **exponential backoff** on 429/5xx\n- If the image fetch fails, **retry**, then go to **error branch**\n\n**Limits**\n- Watch for model **context/vision limits**; downscale/thumbnail images if needed\n- When rate-limited, use **Delay** + **Retry** to recover gracefully"
      },
      "typeVersion": 1
    },
    {
      "id": "55619913-3b70-43d8-ab38-f5b8eb4a6375",
      "name": "Sticky 8: Security",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1776,
        784
      ],
      "parameters": {
        "color": 3,
        "width": 520,
        "height": 220,
        "content": "## ğŸ—’ï¸ Sticky 8: Security & PII\n- Store API keys/tokens in **Credentials/Env Vars** (never in node fields)\n- If image URLs are private, use **signed/temporary URLs**\n- **Do not log** personal data; mask/remove PII from execution logs\n- Use **HTTPS only** for all external requests"
      },
      "typeVersion": 1
    },
    {
      "id": "95833663-f776-40c5-9225-30f07e580acb",
      "name": "Sticky 9: Delivery",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2272,
        0
      ],
      "parameters": {
        "color": 2,
        "width": 520,
        "height": 220,
        "content": "## ğŸ—’ï¸ Sticky 9: Delivery Options (No Gmail)\n- Reply via **Telegram/Slack** or return via **HTTP Response**\n- Optionally log results to **Google Sheets** or **Notion** for history/analytics\n- If email is required, use **SMTP** or a non-Gmail provider (per your stack)"
      },
      "typeVersion": 1
    },
    {
      "id": "d1f31505-89ed-4483-bb52-d1f98c02db36",
      "name": "Sticky 10: Extensibility",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1840,
        400
      ],
      "parameters": {
        "width": 520,
        "height": 240,
        "content": "## ğŸ—’ï¸ Sticky 10: Extensibility (Review Bonus)\n- **Multilingual output** (ja/en) switch\n- Normalize serving units (piece/slice) â†’ **gram conversion**\n- Categorize components (main dish / side / sauce)\n- Add **evidence-based** nutrition comments (e.g., high fat/high carb) with short rationale"
      },
      "typeVersion": 1
    }
  ],
  "active": false,
  "pinData": {},
  "settings": {
    "timezone": "Asia/Tokyo",
    "errorWorkflow": "",
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "versionId": "8766f935-4d36-4d19-9f54-9179e0a59262",
  "connections": {
    "Format for Gmail": {
      "main": [
        [
          {
            "node": "Send a message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "AI Agent - é£Ÿæåˆ†æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - é£Ÿæåˆ†æ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - é£Ÿæåˆ†æ": {
      "main": [
        [
          {
            "node": "Format for Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent - é£Ÿæåˆ†æ",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    }
  }
}